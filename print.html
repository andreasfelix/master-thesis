<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="author" content="Felix Andreas" />
        <title>A new Python-based Lattice Development Tool and its Applications at BESSY II</title>
    <link rel="icon" href="favicon.svg" type="image/svg+xml">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Crimson+Pro:ital,wght@0,400;0,500;0,600;0,700;1,400;1,500;1,600;1,700&family=Inter:wght@400;500;600;700&family=JetBrains+Mono&display=swap"
        rel="stylesheet">
    <style>
        code{white-space: pre-wrap;}
        span.smallcaps{font-variant: small-caps;}
        span.underline{text-decoration: underline;}
        div.column{display: inline-block; vertical-align: top; width: 50%;}
        div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
        ul.task-list{list-style: none;}
        pre > code.sourceCode { white-space: pre; position: relative; }
        pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
        pre > code.sourceCode > span:empty { height: 1.2em; }
        .sourceCode { overflow: visible; }
        code.sourceCode > span { color: inherit; text-decoration: inherit; }
        div.sourceCode { margin: 1em 0; }
        pre.sourceCode { margin: 0; }
        @media screen {
        div.sourceCode { overflow: auto; }
        }
        @media print {
        pre > code.sourceCode { white-space: pre-wrap; }
        pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
        }
        pre.numberSource code
          { counter-reset: source-line 0; }
        pre.numberSource code > span
          { position: relative; left: -4em; counter-increment: source-line; }
        pre.numberSource code > span > a:first-child::before
          { content: counter(source-line);
            position: relative; left: -1em; text-align: right; vertical-align: baseline;
            border: none; display: inline-block;
            -webkit-touch-callout: none; -webkit-user-select: none;
            -khtml-user-select: none; -moz-user-select: none;
            -ms-user-select: none; user-select: none;
            padding: 0 4px; width: 4em;
            color: #aaaaaa;
          }
        pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
        div.sourceCode
          {   }
        @media screen {
        pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
        }
        code span.al { color: #ff0000; font-weight: bold; } /* Alert */
        code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
        code span.at { color: #7d9029; } /* Attribute */
        code span.bn { color: #40a070; } /* BaseN */
        code span.bu { } /* BuiltIn */
        code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
        code span.ch { color: #4070a0; } /* Char */
        code span.cn { color: #880000; } /* Constant */
        code span.co { color: #60a0b0; font-style: italic; } /* Comment */
        code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
        code span.do { color: #ba2121; font-style: italic; } /* Documentation */
        code span.dt { color: #902000; } /* DataType */
        code span.dv { color: #40a070; } /* DecVal */
        code span.er { color: #ff0000; font-weight: bold; } /* Error */
        code span.ex { } /* Extension */
        code span.fl { color: #40a070; } /* Float */
        code span.fu { color: #06287e; } /* Function */
        code span.im { } /* Import */
        code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
        code span.kw { color: #007020; font-weight: bold; } /* Keyword */
        code span.op { color: #666666; } /* Operator */
        code span.ot { color: #007020; } /* Other */
        code span.pp { color: #bc7a00; } /* Preprocessor */
        code span.sc { color: #4070a0; } /* SpecialChar */
        code span.ss { color: #bb6688; } /* SpecialString */
        code span.st { color: #4070a0; } /* String */
        code span.va { color: #19177c; } /* Variable */
        code span.vs { color: #4070a0; } /* VerbatimString */
        code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
        div.csl-bib-body { }
        div.csl-entry {
          clear: both;
        }
        .hanging div.csl-entry {
          margin-left:2em;
          text-indent:-2em;
        }
        div.csl-left-margin {
          min-width:2em;
          float:left;
        }
        div.csl-right-inline {
          margin-left:2em;
          padding-left:1em;
        }
        div.csl-indent {
          margin-left: 2em;
        }
    </style>
        <link rel="stylesheet" href="css/variables.css" />
        <link rel="stylesheet" href="css/pages.css" />
        <link rel="stylesheet" href="css/interface.css" />
        <link rel="stylesheet" href="css/print.css" />
        
    <!-- don't use pandoc's katex, so we can only render html and not mathml -->
    <!-- because katex's mathml causes weird overflow of root html in chrome for small screen sizes in a table -->
    <!-- katex render is called at bottom of body -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.18/dist/katex.min.css"
        integrity="sha384-zTROYFVGOfTw7JV7KUu8udsvW2fx4lWOsCEDqhBreBwlHI4ioVRtmIvEThzJHGET" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.13.18/dist/katex.min.js"
        integrity="sha384-GxNFqL3r9uRJQhR+47eDxuPoNE7yLftQM8LcxzgS4HT73tp970WS/wV5p8UzCOmb"
        crossorigin="anonymous"></script>
    <script src="https://unpkg.com/pagedjs/dist/paged.polyfill.js"></script>
</head>

<body>
    
    <div class="pages">
        <!-- firefox overflows at height: 247mm -->
        <div id="title-page" style="height: 246.9mm; text-align: center; display: grid; grid-auto-rows: 1fr;">
            <div style="font-size: 1.875rem; font-weight: 500; align-self:center;">A new Python-based Lattice Development Tool and its Applications at BESSY II</div>
            <div style="display: flex; flex-direction: column; justify-content: space-between;">
                <div style="display: flex; justify-content: space-between; font-size: 1.125rem;">
                    <div style="text-align: left;">
                        <div style="font-style: italic; margin-bottom: 0.5rem">Author</div>
                        <div>Felix Andreas</div>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-style: italic; margin-bottom: 0.5rem">Supervisors</div>
                        <div>Prof. Dr. Andreas Jankowiak<br>Dr. Paul Goslawski</div>
                    </div>
                </div>
                <div style="font-style: italic; display: grid; gap: 1rem;">
                    <div><p>A thesis submitted in partial fulfillment of the requirements for the degree of Master of Science (M.Sc)</p></div>
                    <div>in the</div>
                    <a href="https://www.physik.hu-berlin.de" target="_blank" rel="nofollow">
                        Department of Physics<br />Faculty of Mathematics and Natural Sciences<br />Humboldt-Universität zu Berlin
                    </a>
                </div>
                <div>December 20, 2021</div>
            </div>
        </div>

        <div class="frontmatter">
            <section id="abstract" class="level1">
                <h1>Abstract</h1>
                <p>Due to the BESSY-VSR upgrade and the design of the next synchrotron radiation facility BESSY III, there are several lattice development tasks at the Helmholtz-Zentrum Berlin (HZB). Within the last several years, there was a significant shift in the physics community from standalone plotting programs, optimization routines, and numerical libraries towards the Python programming language, which absorbed these tools into different packages. At HZB, Python is the predominant programming language used to set up the execution of simulations and to post-process their results. The issue with existing and mature particle accelerator simulation codes is that it is not trivial to integrate them into a typical Python workflow. Many physicists have written several wrapper scripts around the existing simulation codes to leverage the power of Python’s rich ecosystem of scientific tools. The issue with these wrappers is that there are often not reusable because they are very specific to a particular task and often rely on string manipulation of the lattice files or run files, which can be very error-prone and is computationally inefficient. Furthermore, these wrapper scripts only give access to the simulation results and not to the underlying internal models of the simulation codes, like the magnetic lattice or information about individual magnets. Therefore it was decided to develop a new Python package that generates an accelerator model from a given lattice file. This model can be queried for information on individual magnets and on properties of composed structures like the length of a cell. It is designed in such an extensible way that it can be used as a foundation for different simulation methods, which can be built on top of it. Such a method, which is capable of computing the Twiss parameters, dispersion function, chromaticity, emittance, and synchrotron radiation integrals, was implemented. This thesis covers how this new tool was developed and then used to optimize the O5T2off optics for the BESSY-VSR project, adapt the beta functions of the BESSY II storage ring for an emittance exchange experiment, and create a framework of automated lattice summaries, which could be useful for the development of a future BESSY III lattice. The developed code does not aim to replace the more mature and full-featured existing particle accelerator codes. However, it extends the ecosystem of accelerator tools by enabling fundamental lattice development using the Python language.</p>
            </section>

            <section id="acknowledgments" class="level1">
                <h1>Acknowledgments</h1>
                <p>An erster Stelle möchte ich mich bei Herrn Professor Andreas Jankowiak bedanken. Danke, dass Sie mir diese Arbeit am Helmholtz-Zentrum Berlin ermöglicht haben und dass Sie diese Arbeit begutachten.</p>
                <p>Ich möchte mich bei Dr. Markus Ries für das gemeinsame Experimentieren beim Nutzerzustandstest der Q5T2-off Optik und beim Emittance-Exchange Experiment bedanken.</p>
                <p>Vielen Dank an Dr. Tom Mertens für die Diskussionen und Vorschläge rund um die Entwicklung des LatticeJSON Lattice File Formats. Danke auch für spannende physikalische Debatten.</p>
                <p>Ebenfalls möchte ich mich bei Dr. Michael Abo-Bakr bedanken. Für die Unterstützung bei einigen Experimenten, Beantwortung beschleunigerphysikalischer Fragen und viele Diskussionen rund um die Entwicklung der Lattice Summaries.</p>
                <p>Mein größter Dank geht an Dr. Paul Goslawski. Danke für Deine intensive Betreuung innerhalb der letzten Jahre seit meiner Bachelorarbeit. Danke für Deine vielen Anregungen, Kommentare und Dein großes Engagement. Danke für Deine Ausdauer beim spannenden nächtlichen Experimentieren. Und danke für viele interessante Diskussionen, manchmal auch etwas am Rande der Beschleunigerphysik.</p>
                <p>Zuletzt möchte ich mich bei meinen Eltern bedanken. Danke für die große Unterstützung während der letzten Jahre und danke dafür, dass Ihr mir mein Studium ermöglicht habt.</p>
            </section>

            <section id="toc" class="level1">
                <h1>Contents</h1>
                <ul>
                <li><a href="#introduction"><span class="toc-section-number">1</span> Introduction</a>
                <ul>
                <li><a href="#bessy-ii---a-third-generation-light-source"><span class="toc-section-number">1.1</span> BESSY II - A Third Generation Light Source</a></li>
                <li><a href="#lattice-development-at-hzb---examples"><span class="toc-section-number">1.2</span> Lattice Development at HZB - Examples</a>
                <ul>
                <li><a href="#sec:introduction-q5t2off-bessy-vsr-optics"><span class="toc-section-number">1.2.1</span> Enlarging the Available Installation Length for the VSR Cryomodule</a></li>
                <li><a href="#emittance-exchange-experiment"><span class="toc-section-number">1.2.2</span> Emittance Exchange Experiment</a></li>
                <li><a href="#sec:automated-lattice-summaries"><span class="toc-section-number">1.2.3</span> Automated Lattice Summaries</a></li>
                <li><a href="#smaller-lattice-development-tasks-at-the-bessy-ii-storage-ring"><span class="toc-section-number">1.2.4</span> Smaller Lattice Development Tasks at the BESSY II Storage Ring</a></li>
                </ul></li>
                <li><a href="#motivation-the-need-for-a-python-interface-to-particle-accelerator-simulations"><span class="toc-section-number">1.3</span> Motivation: The Need for a Python Interface to Particle Accelerator Simulations</a></li>
                </ul></li>
                <li><a href="#beam-dynamics-in-electron-storage-rings"><span class="toc-section-number">2</span> Beam Dynamics in Electron Storage Rings</a>
                <ul>
                <li><a href="#sec:frenet-serret-coordinates"><span class="toc-section-number">2.1</span> The Co-moving Coordinate System</a></li>
                <li><a href="#sec:equations-of-motion"><span class="toc-section-number">2.2</span> Equations of Motion</a></li>
                <li><a href="#sec:linear-beam-dynamics"><span class="toc-section-number">2.3</span> Linear Beam Dynamics</a>
                <ul>
                <li><a href="#linearized-equations-of-motion"><span class="toc-section-number">2.3.1</span> Linearized Equations of Motion</a></li>
                <li><a href="#sec:betatron-oscillation"><span class="toc-section-number">2.3.2</span> Betatron Oscillation</a></li>
                <li><a href="#sec:transformation-twiss-parameter"><span class="toc-section-number">2.3.3</span> Transformation of the Twiss parameters</a></li>
                <li><a href="#sec:dispersion"><span class="toc-section-number">2.3.4</span> Dispersion</a></li>
                <li><a href="#momentum-compaction"><span class="toc-section-number">2.3.5</span> Momentum Compaction</a></li>
                </ul></li>
                <li><a href="#sec:chromaticity"><span class="toc-section-number">2.4</span> Chromaticity</a>
                <ul>
                <li><a href="#sec:natural-chromaticity"><span class="toc-section-number">2.4.1</span> Natural Chromaticity in a Storage Ring</a></li>
                <li><a href="#chromaticity-correction"><span class="toc-section-number">2.4.2</span> Chromaticity Correction</a></li>
                </ul></li>
                <li><a href="#sec:synchrotron-radiation"><span class="toc-section-number">2.5</span> Synchrotron Radiation</a>
                <ul>
                <li><a href="#radiation-damping-of-betatron-oscillations"><span class="toc-section-number">2.5.1</span> Radiation Damping of Betatron Oscillations</a></li>
                <li><a href="#sec:quantum-excitation"><span class="toc-section-number">2.5.2</span> Quantum Excitation</a></li>
                <li><a href="#sec:emittance"><span class="toc-section-number">2.5.3</span> Equilibrium Emittance</a></li>
                </ul></li>
                <li><a href="#sec:lattice-design"><span class="toc-section-number">2.6</span> Lattice Design</a>
                <ul>
                <li><a href="#the-fodo-lattice"><span class="toc-section-number">2.6.1</span> The FODO Lattice</a></li>
                <li><a href="#sec:the-dba-lattice"><span class="toc-section-number">2.6.2</span> The DBA Lattice</a></li>
                </ul></li>
                </ul></li>
                <li><a href="#implementation"><span class="toc-section-number">3</span> Implementation</a>
                <ul>
                <li><a href="#overview-of-used-technology"><span class="toc-section-number">3.1</span> Overview of Used Technology</a></li>
                <li><a href="#sec:improving-performance"><span class="toc-section-number">3.2</span> Improving the Performance of the Twiss Calculation</a></li>
                <li><a href="#sec:accelerator-model"><span class="toc-section-number">3.3</span> Representation of the Magnetic Lattice</a></li>
                <li><a href="#sec:implementation-usage"><span class="toc-section-number">3.4</span> Usage</a></li>
                <li><a href="#sec:latticejson"><span class="toc-section-number">3.5</span> LatticeJSON: An Attempt towards a Universal Lattice File Format</a></li>
                </ul></li>
                <li><a href="#applications"><span class="toc-section-number">4</span> Applications</a>
                <ul>
                <li><a href="#sec:q5t2off-bessy-vsr-optics"><span class="toc-section-number">4.1</span> Modifying the BESSY II Optics for the VSR project</a>
                <ul>
                <li><a href="#lattice-design-of-the-bessy-storage-ring"><span class="toc-section-number">4.1.1</span> Lattice Design of the BESSY Storage Ring</a></li>
                <li><a href="#sec:q5t2off-constraints"><span class="toc-section-number">4.1.2</span> Constraints for the Development of the Q5T2off-optics</a></li>
                <li><a href="#sec:turning-off-the-q5t2-quadrupoles"><span class="toc-section-number">4.1.3</span> Turning off the Q5T2 Quadrupoles</a></li>
                <li><a href="#sec:optimizing-the-q5t2off-optics"><span class="toc-section-number">4.1.4</span> Optimizing the Q5T2off-optics in Simulations</a></li>
                <li><a href="#sec:user-acceptance-test"><span class="toc-section-number">4.1.5</span> User Operation Acceptance Test of the Q5T2 Optics</a></li>
                </ul></li>
                <li><a href="#sec:emittance-exchange-experiment"><span class="toc-section-number">4.2</span> Emittance Exchange Experiment</a></li>
                <li><a href="#sec:lattice-summaries"><span class="toc-section-number">4.3</span> Automated Lattice Summaries</a>
                <ul>
                <li><a href="#sec:lattice-summaries-architecture"><span class="toc-section-number">4.3.1</span> Architecture</a></li>
                <li><a href="#sec:database-of-lattice-files"><span class="toc-section-number">4.3.2</span> Database of Lattice Files</a></li>
                <li><a href="#set-of-routines"><span class="toc-section-number">4.3.3</span> Set of Routines</a></li>
                <li><a href="#lattice-summaries-website"><span class="toc-section-number">4.3.4</span> Lattice Summaries Website</a></li>
                </ul></li>
                </ul></li>
                <li><a href="#conclusion"><span class="toc-section-number">5</span> Conclusion</a></li>
                <li><a href="#sec:appendix-code"><span class="toc-section-number">6</span> Developed Code</a>
                <ul>
                <li><a href="#installation"><span class="toc-section-number">6.1</span> Installation</a></li>
                <li><a href="#requirements"><span class="toc-section-number">6.2</span> Requirements</a></li>
                <li><a href="#links"><span class="toc-section-number">6.3</span> Links</a></li>
                <li><a href="#license"><span class="toc-section-number">6.4</span> License</a></li>
                </ul></li>
                <li><a href="#sec:code-to-reproduce-q5t2off-optics"><span class="toc-section-number">7</span> Code to Reproduce the Q5T2off Optics</a></li>
                <li><a href="#sec:gui-power-supply-values"><span class="toc-section-number">8</span> GUI to Calculate and Set new Power Supply Values</a></li>
                <li><a href="#sec:appendix-transfer-matrices"><span class="toc-section-number">9</span> Transfer Matrices</a>
                <ul>
                <li><a href="#drift-space"><span class="toc-section-number">9.1</span> Drift Space</a></li>
                <li><a href="#dipole-magnet"><span class="toc-section-number">9.2</span> Dipole Magnet</a></li>
                <li><a href="#quadrupole-magnet"><span class="toc-section-number">9.3</span> Quadrupole Magnet</a></li>
                </ul></li>
                <li><a href="#grammar-files-of-common-lattice-file-formats"><span class="toc-section-number">10</span> Grammar Files of Common Lattice File Formats</a>
                <ul>
                <li><a href="#sec:elegant-grammar"><span class="toc-section-number">10.1</span> Elegant Grammar File</a></li>
                <li><a href="#sec:madx-grammar"><span class="toc-section-number">10.2</span> MAD-X Grammar File</a></li>
                </ul></li>
                <li><a href="#sec:appendix-documentation"><span class="toc-section-number">11</span> Documentation</a></li>
                <li><a href="#bibliography">Bibliography</a></li>
                </ul>
            </section>
        </div>

        <!-- Do not indent "body", because <code> tags are white-space sensitive! -->
        <main><section id="introduction" class="level1" data-number="1">
<h1 data-number="1"><span class="header-section-number">1</span> Introduction</h1>
<p>This thesis presents the development of the new lattice design tool <em>apace</em>, the new JSON-based lattice file format <em>LatticeJSON</em>, and some of their applications.</p>
<p>This first chapter provides a brief overview of the third-generation light source BESSY II and some of its current lattices design tasks. Then, it discusses the challenges of integrating the existing simulation codes in a modern and high-level programming language like Python, which sets the motivation for the development of a new optics code as part of this thesis.</p>
<p>The second chapter covers the physical concepts of beam dynamics in electron storage rings needed to implement the new lattice design tool.</p>
<p>The third chapter addresses various challenges and considerations made during the implementation. Furthermore, it gives a short overview of the capabilities of the developed Python package.</p>
<p>The fourth chapter presents the applications of the developed optics simulation program for two optics changes at the BESSY II storage ring.</p>
<p>The last chapter concludes the thesis with a summary of the results and gives an outlook into its potential use cases in the future.</p>
<p>The appendix includes the documentation, the API reference, and the source code of the developed Python package.</p>
<section id="bessy-ii---a-third-generation-light-source" class="level2" data-number="1.1">
<h2 data-number="1.1"><span class="header-section-number">1.1</span> BESSY II - A Third Generation Light Source</h2>
<p>The third-generation synchrotron light source BESSY II is located in Berlin Adlershof and is operated by the research institute Helmholtz-Zentrum Berlin (HZB) since 1998. Its purpose is to provide extremely brilliant synchrotron light pulses in the range of terahertz radiation to hard X-rays. The storage ring has a circumference of 240 m and is equipped with 50 beamlines. A graphic overview of BESSY II is shown in <a href="#fig:bessy2-floorplan">Figure 1.1</a>. In addition, the most important parameters of the storage ring are listed in <a href="#tbl:bessy2-parameters">Table 1.1</a>.</p>
<figure>
<img src="figures/bessy2-floorplan.svg" id="fig:bessy2-floorplan" alt="Figure 1.1: Floor plan of the synchrotron light source BESSY II (extracted from [1])" /><figcaption aria-hidden="true">Figure 1.1: Floor plan of the synchrotron light source BESSY II (extracted from <span class="citation" data-cites="ruprecht-phd"><a href="#ref-ruprecht-phd" role="doc-biblioref">[1]</a></span>)</figcaption>
</figure>
<div id="tbl:bessy2-parameters">
<table>
<caption>Table 1.1: Parameters of the BESSY II storage ring</caption>
<thead>
<tr class="header">
<th>Parameter</th>
<th>Value</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>nominal energy</td>
<td>1.7 GeV</td>
</tr>
<tr class="even">
<td>horizontal emittance</td>
<td>≈ 7 nm rad</td>
</tr>
<tr class="odd">
<td>circumference</td>
<td>240 m</td>
</tr>
<tr class="even">
<td>RF-frequency</td>
<td>500 MHz</td>
</tr>
<tr class="odd">
<td>revolution time</td>
<td>800 ns</td>
</tr>
<tr class="even">
<td>beam current</td>
<td>300 mA</td>
</tr>
<tr class="odd">
<td>number of cells</td>
<td>16</td>
</tr>
<tr class="even">
<td>number of bending magnets</td>
<td>32</td>
</tr>
<tr class="odd">
<td>bending radius</td>
<td>4.354 m</td>
</tr>
<tr class="even">
<td>beam-lines</td>
<td>≈ 42</td>
</tr>
</tbody>
</table>
</div>
<p>The electrons are emitted by a DC grid cathode and are accelerated up to 90 keV. In the following linear accelerator (LINAC), their energy is increased up to 50 MeV <span class="citation" data-cites="linac"><a href="#ref-linac" role="doc-biblioref">[2]</a></span>. Next, the electrons are transferred to the booster synchrotron, where they are accelerated up to 1.7 GeV and injected into the storage ring cumulatively so that a beam current of 300 mA is maintained (<em>top-up</em>). The electrons can be stored for up to 10 hours and emit, depending on the type of deflection (bending magnet, wiggler, or undulator), photon energies from 10 eV up to 15 keV.</p>
<p>At BESSY II, it is possible to operate the machine in two different modes. Most of the time, the storage ring is set to the standard user optics with 15 ps bunch length. During two weeks of the year, the lattice is changed to the low <span class="math inline">\alpha</span> optics, which provide buckets with 3 ps bunch length <span class="citation" data-cites="abobakr2003"><a href="#ref-abobakr2003" role="doc-biblioref">[3]</a></span>. This can be realized by reducing the momentum compaction factor <span class="math inline">\alpha_{\mathrm{c}}</span> from <span class="math inline">7 \cdot 10^{-4}</span> to <span class="math inline">4 \cdot 10^{-5}</span>. The coherent synchrotron radiation instability leads to a limiting bursting threshold current, which scales with ~<span class="math inline">\alpha_{\mathrm{c}}</span>. Therefore the photon flux has to be reduced significantly in comparison to the standard optics. At this time, high flux users cannot run experiments, which is why the low alpha mode can only be provided for short periods.</p>
</section>
<section id="lattice-development-at-hzb---examples" class="level2" data-number="1.2">
<h2 data-number="1.2"><span class="header-section-number">1.2</span> Lattice Development at HZB - Examples</h2>
<p>This section introduces some of the lattice development tasks at HZB, which have been addressed using the developed code.</p>
<section id="sec:introduction-q5t2off-bessy-vsr-optics" class="level3" data-number="1.2.1">
<h3 data-number="1.2.1"><span class="header-section-number">1.2.1</span> Enlarging the Available Installation Length for the VSR Cryomodule</h3>
<p>Due to increasing interest in studies that require very short photon pulses, HZB is developing a new operational mode called Variable pulse-length Storage Ring (VSR) <span class="citation" data-cites="vsrstudy"><a href="#ref-vsrstudy" role="doc-biblioref">[4]</a></span>, which aims to fulfill the requirements of the users who need short 2 ps bunches and of the users relying on the high average beam current, which is mainly stored in the 15 ps long bunches. The idea is to store long and short bunches in one storage ring simultaneously by establishing a beating pattern of higher harmonic cavities providing alternating longitudinal focusing gradients for two different bunch lengths.</p>
<figure>
<img src="figures/vsr-cavity-voltage.svg" id="fig:vsr-cavity-voltage" alt="Figure 1.2: Voltage of the VSR cavities and their sum. The alternating large (blue) and small (red) gradients lead to short and longer bunches, respectively. (based on [4] and [1])" /><figcaption aria-hidden="true">Figure 1.2: Voltage of the VSR cavities and their sum. The alternating large (blue) and small (red) gradients lead to short and longer bunches, respectively. (based on <span class="citation" data-cites="vsrstudy"><a href="#ref-vsrstudy" role="doc-biblioref">[4]</a></span> and <span class="citation" data-cites="ruprecht-phd"><a href="#ref-ruprecht-phd" role="doc-biblioref">[1]</a></span>)</figcaption>
</figure>
<p>This will be achieved by the installation of an additional cavity module consisting of two 1.5 GHz and two 1.75 GHz cavities. The superposition of these two new frequencies and the existing 0.5 GHz cavity leads to alternating high (blue) and low gradients (blue) shown in <a href="#fig:vsr-cavity-voltage">Figure 1.2</a>. The long bunches are located at the small voltage gradients, where the voltages of the 1.5 GHz and 1.75 GHz cavities cancel out. The short bunches, with higher current than in the low alpha mode, are produced at the high voltage gradient, where the voltages of the cavities add up.</p>
<figure>
<img src="figures/vsr-installation-length.svg" id="fig:vsr-installation-length" alt="Figure 1.3: The currently available space within the T2 section of the storage ring. Removing the Q5 quadrupoles would lead to about 0.7 m of additional installation lenght for a larger cryomodule. (yellow - Dipole, red - Quadrupole, green - Sextupole)" /><figcaption aria-hidden="true">Figure 1.3: The currently available space within the T2 section of the storage ring. Removing the Q5 quadrupoles would lead to about 0.7 m of additional installation lenght for a larger cryomodule. (yellow - Dipole, red - Quadrupole, green - Sextupole)</figcaption>
</figure>
<p>The additional cavity module will be installed in the T2 section of the BESSY II storage ring, shown in <a href="#fig:vsr-installation-length">Figure 1.3</a>. One challenge - addressed by my bachelor’s thesis <span class="citation" data-cites="andreas_ba"><a href="#ref-andreas_ba" role="doc-biblioref">[5]</a></span> - is that the module needs more space than initially assumed. One solution is to remove the two Q5T2 quadrupoles to gain about 0.7 meters of installation length. The goal is to switch off the Q5T2 quadrupoles in simulations while maintaining the most important transverse linear parameters as the beta functions, tune, and momentum compaction factor. The best optics presented showed that a turn-off of the Q5T2 quadrupoles in the T2 straight is possible. Furthermore, the optics was tested at the storage ring, where it was possible to store high current with reasonable lifetime and injection efficiency.</p>
<p>As already stated in the conclusion of the bachelor’s thesis, the presented optics have to be further optimized regarding different aspects: There is still a non-negligible beta beat outside of the T2 section. The linear optics could be further improved by overcoming some limitations of the code of the bachelor’s thesis. Depending on the number of parameters, some optimization runs took several days. Optimizing time-critical parts of the developed code would allow optimizing using a higher number of quadrupole configurations. Also, the capability to mask certain regions, which would not be taking into account by the objective function, or set the beta functions to the desired value in the cavity module could further improve the obtained optics. That would require a significant rewrite of the developed code. Adjusting the objective function of the optimization method, discussed in <a href="#sec:q5t2off-bessy-vsr-optics">Section 4.1</a>, could improve the linear result. Besides the optimization of the linear beam dynamics, the optics has to be further optimized with regard to the non-linear dynamics. Different sextupole settings can be used to optimize the phase and momentum acceptance.</p>
</section>
<section id="emittance-exchange-experiment" class="level3" data-number="1.2.2">
<h3 data-number="1.2.2"><span class="header-section-number">1.2.2</span> Emittance Exchange Experiment</h3>
<p>With the uprise of 4ᵗʰ generation light sources, the discussion of round beams becomes more relevant. A round beam is produced when the emittance is the same in both transversal planes. Such an emittance exchange is helpful in two use cases:</p>
<p>First, discussed in <span class="citation" data-cites="kuskekramer2016"><a href="#ref-kuskekramer2016" role="doc-biblioref">[6]</a></span>, an exchange of the transverse beam emittances can improve the injection efficiency. Since the beam is injected in the horizontal plane and the beam emittance is much larger in the horizontal plane for an electron synchrotron, the horizontal emittance primarily defines the required acceptance for a high injection efficiency. Therefore, reducing the horizontal emittance in the booster synchrotron, shown in <a href="#fig:aperture-emittance-requirement">Figure 1.4</a>, by partially transferring it into the vertical plane can significantly lower the required acceptance of the storage ring and thus increase the injection efficiency.</p>
<figure>
<img src="figures/aperture-emittance-requirement.svg" id="fig:aperture-emittance-requirement" alt="Figure 1.4: Influence of the horizontal emittance of the injected beam on the required aperture for high injection efficiency (based on [6])" /><figcaption aria-hidden="true">Figure 1.4: Influence of the horizontal emittance of the injected beam on the required aperture for high injection efficiency (based on <span class="citation" data-cites="kuskekramer2016"><a href="#ref-kuskekramer2016" role="doc-biblioref">[6]</a></span>)</figcaption>
</figure>
<p>Another reason for an emittance exchange is the generation of round beams in the storage ring. The goal is to match the electron beam phase space with the phase space of the emitted photon beam at the radiation source to optimize the photon beam’s brilliance and coherent fraction.</p>
<p>There are different techniques to generate round beams. For example, operating on a coupling resonance or driving a skew excitation resonantly with the beam. One experiment to study the influence of the resonant skew excitation on the emittance exchange depending on the size of the beta function required an optics change in one of the triplet sections of the storage ring. <a href="#sec:emittance-exchange-experiment">Section 4.2</a> presents how the developed code was used to raise the horizontal beta function from 1.2 m to 15 m at the center of the straight.</p>
</section>
<section id="sec:automated-lattice-summaries" class="level3" data-number="1.2.3">
<h3 data-number="1.2.3"><span class="header-section-number">1.2.3</span> Automated Lattice Summaries</h3>
<p>At HZB, the development of the Conceptual Design Report (CDR) of the BESSY II successor BESSY III has started. Many lattice candidates arise during the development of an entirely new accelerator lattice, which themselves require serval iterations. These numerous versions of lattices are created by different physicists making different considerations and optimizing for different parameters. Due to the variety of accelerator physics codes, the lattice files and simulation results are stored in different formats. Even though many accelerator codes provide the option to export the lattice files to different formats, this often does not work flawlessly and requires editing these files manually afterward. That makes sharing and comparing the different lattices candidates during the design phase very cumbersome and unnecessarily time-consuming.</p>
<p>The number of different simulation codes and lattice file formats is probably due to the variety of different lattice development tasks. Certain tasks can be very specific to a given facility and require a feature, which may not be implemented in one of the existing codes. Due to some codes not being open-source or since it can be easier to implement a certain feature from scratch than integrating it into one of the existing codes, this probably led to the historical fragmentation of accelerator physics codes and lattice file formats.</p>
<p>On the other hand, the boundary conditions for a new BESSY III lattice are well defined. Therefore, especially for fundamental lattices development, mainly linear beam dynamics, it should be possible to automate the process of sharing lattice files and simulation results.</p>
<p>Ideally, there would be a shared database of lattices. The lattices files would be automatically generated in multiple formats every time a lattice is added to the database. In the same way, a predefined set of simulations would be run. The simulation results could then be summarized in the form of a lattice report, for example, through a web page. Such a framework of automatically generated lattice summaries would also be useful for existing lattices. For example, to benchmark a BESSY III candidate lattice with one of the existing 4ᵗʰ generation light sources or build an updated version of the Synchrotron Light Source Data Book <span class="citation" data-cites="murphy_1996"><a href="#ref-murphy_1996" role="doc-biblioref">[7]</a></span>.</p>
<p>As a starting point and to facilitate the creation of such a database, it might be helpful to use a slimmed-down version of lattice file formats. Such a restricted version would only contain basic element types such as drifts and multipoles. As these elements are available in all accelerator codes, this would make a one-to-one translation between the lattice file formats possible. Furthermore, with the lattice files available in the different formats, automated routines could be set up for the different simulations codes.</p>
<p>A prove-of-concept framework of automated lattice summaries was developed using the new lattice design tool and JSON-based lattice file format and will be presented in <a href="#sec:lattice-summaries">Section 4.3</a>.</p>
</section>
<section id="smaller-lattice-development-tasks-at-the-bessy-ii-storage-ring" class="level3" data-number="1.2.4">
<h3 data-number="1.2.4"><span class="header-section-number">1.2.4</span> Smaller Lattice Development Tasks at the BESSY II Storage Ring</h3>
<p>Sometimes there are smaller lattice development tasks, where, for example, a user needs to know the value of the beta function at a specific position in the storage ring. Often this task requires some post-processing, which at HZB is mainly done in Python. Thus, having a native Python interface to the accelerator model and the Twiss parameters would be very beneficial for these tasks.</p>
</section>
</section>
<section id="motivation-the-need-for-a-python-interface-to-particle-accelerator-simulations" class="level2" data-number="1.3">
<h2 data-number="1.3"><span class="header-section-number">1.3</span> Motivation: The Need for a Python Interface to Particle Accelerator Simulations</h2>
<p>MAD-X <span class="citation" data-cites="madx"><a href="#ref-madx" role="doc-biblioref">[8]</a></span> and elegant <span class="citation" data-cites="elegant"><a href="#ref-elegant" role="doc-biblioref">[9]</a></span> are some of the most mature and commonly used accelerator physics simulation codes, among many others, listed here <span class="citation" data-cites="accelerator-physics-codes"><a href="#ref-accelerator-physics-codes" role="doc-biblioref">[10]</a></span>. Both programs a driven by an input file - often called run-file. This file defines various simulation parameters but can also be used to define an optimization procedure. After the execution, the results are stored in an output file. Over the years, various toolkits and programs emerged to inspect, post-process, and plot these results. Elegant even comes with its own post-processing toolkit SDDS <span class="citation" data-cites="sdds-toolkit"><a href="#ref-sdds-toolkit" role="doc-biblioref">[11]</a></span>. Sometimes, for complex runs, more flexibility is needed, which is why Python is commonly used for post-processing and analysis of the simulation data.</p>
<p>Python has a rich ecosystem of numerical libraries and optimization tools, which is growing day by day. It has become the go-to language for scientific computing and machine learning. A typical workflow of using MAD-X or elegant with Python would be (see <a href="#fig:workflow-analysis-python">Figure 1.5</a>):</p>
<ol type="1">
<li>Create a run file</li>
<li>Run the simulation defined by the run-file</li>
<li>Store the results as a file.</li>
<li>Load the simulation results into Python and post-process the data.</li>
<li>Output the post-processed data. (e.g. a plot or a new optics file)</li>
</ol>
<figure>
<img src="figures/workflow-analysis-python.svg" id="fig:workflow-analysis-python" alt="Figure 1.5: An exemplary workflow for using MAD-X or elegant from Python." /><figcaption aria-hidden="true">Figure 1.5: An exemplary workflow for using MAD-X or elegant from Python.</figcaption>
</figure>
<p>One issue of this workflow is that not all information contained within the data structures and models of the simulation software is included in the output files. For example, MAD-X and elegant do not include a complete model of the accelerator’s lattice but only an array of elements for the simulated orbit positions. Another issue is that the execution of MAD-X and elegant can only be driven by their respective run-file. Although both run-files provide basic features of a programming language, such as variables, loops, or if-else statements, their capabilities are extremely limited compared to Python. Therefore it would be desirable to drive the execution of the simulation using Python. Full access to the accelerator model of these simulations software would require implementing a Python interface for MAD-X or elegant. PyMAD <span class="citation" data-cites="pymad"><a href="#ref-pymad" role="doc-biblioref">[12]</a></span> is an attempt to create a Python API for MAD-X. As Python is a highly object-oriented language and MAD-X is mainly written in C and Fortran, it is not trivial to design an API that fits the different programming paradigms of these languages. The PyMAD project was unmaintained since 2017 but was recently picked up by the Heidelberg Ion-Beam Therapy Center (HIT) <span class="citation" data-cites="cpymad"><a href="#ref-cpymad" role="doc-biblioref">[13]</a></span>.</p>
<figure>
<img src="figures/workflow-python-driven.svg" id="fig:workflow-python-driven" alt="Figure 1.6: Driving the execution of MAD-X or elegant using Python. A new run-file is generated for each iteration of the optimization process." /><figcaption aria-hidden="true">Figure 1.6: Driving the execution of MAD-X or elegant using Python. A new run-file is generated for each iteration of the optimization process.</figcaption>
</figure>
<p>To still leverage the powerful optimizers of the Python ecosystem, one common workaround is to use a template lattice-file or run-file: At the beginning of each iteration, Python generates a unique input file by inserting the values of the optimization parameters into the template file. Using this new run-file, Python then starts the simulation software as a sub-process, parses the results, calculates the value of the fitness function, and lets the optimizer compute the values of the optimization arguments for the next iteration. This is repeated until the terminating condition of the optimizer is met. Afterward, the final results are saved to a file. This workflow, illustrated in <a href="#fig:workflow-python-driven">Figure 1.6</a>, has several drawbacks:</p>
<ul>
<li>No direct access to the accelerator model.</li>
<li>It is computationally very inefficient: The simulation software has to parse the run-file and rebuild the accelerator model for each iteration because the memory is freed after the program terminates.</li>
<li>Storing simulation results in a file and loading them into Python for each iteration is another performance issue: Hard disks are many magnitudes slower than computer memory. Even though this could be enhanced by using a RAM disk, serializing and deserializing the simulation results for each iteration are still not optimal.</li>
<li>Substituting strings in a run-file is very error-prone and can lead to hard-to-find bugs.</li>
</ul>
<p>For these reasons, it would be desirable to have a direct Python API to drive the execution of accelerator simulations. As discussed above, integrating one of the existing simulation codes in Python is a difficult task. It was therefore decided to develop a new optics code as a native Python package. As Python is a dynamically typed language and its major implementation CPython <span class="citation" data-cites="cpython"><a href="#ref-cpython" role="doc-biblioref">[14]</a></span> does not convert the source code directly into native machine instruction, ordinary Python programs execute slower than programs written in lower-level languages like C or Fortran. To ensure an extremely fast calculation of the Twiss parameters, which is necessary because high-dimensional optimizations often require millions of iterations, time-critical parts were implemented in the C language.</p>
<p>The code is partially based on scripts written for the Q5T2-off optics of my bachelor’s thesis. At the time of this thesis, the code is capable of calculating most of the linear parameters like the Twiss parameters, the dispersion function, the betatron phase, the tune, the momentum compaction factor, the natural chromaticity, the emittance, and synchrotron radiation integrals. Particle tracking is implemented by the matrix method. In addition, an experimental branch can do particle tracking by integrating the equations of motion, which is used for some plots in this thesis but not well tested.</p>
<p>A main feature of the developed code is its accelerator model, which includes an internal dependency graph between the accelerator elements: Whenever an element changes one of its attributes, it automatically notifies all its dependents. For example, suppose a magnet changes its length. In that case, it notifies its containing lattice that its length has to be recomputed, which in turn notifies a simulation method that the linear optics parameters have to be recalculated the next time they are accessed. That is convenient for the users because they do not have to keep track of complex dependency relations and ensure that only outdated properties are recomputed. No performance is wasted on calculating already known values.</p>
<p>The next chapter provides an introduction to the physical foundation of the developed code.</p>
</section>
</section>
<section id="beam-dynamics-in-electron-storage-rings" class="level1" data-number="2">
<h1 data-number="2"><span class="header-section-number">2</span> Beam Dynamics in Electron Storage Rings</h1>
<p>This chapter covers all concepts of electron beam dynamics in circular accelerators needed for implementing the developed beam optics code <em>apace</em>. The books of H. Wiedemann <span class="citation" data-cites="wiedemann"><a href="#ref-wiedemann" role="doc-biblioref">[15]</a></span>, A. Wolski <span class="citation" data-cites="wolski"><a href="#ref-wolski" role="doc-biblioref">[16]</a></span>, K. Wille <span class="citation" data-cites="wille"><a href="#ref-wille" role="doc-biblioref">[17]</a></span> and, F. Hinterberger <span class="citation" data-cites="hinterberger"><a href="#ref-hinterberger" role="doc-biblioref">[18]</a></span> are the main sources of this chapter.</p>
<p>Electrons in a storage ring oscillate around a curved ideal path. Transforming this ideal orbit away using a different coordinate system than Cartesian coordinates will facilitate our work in the following sections. Therefore, the first section introduces the co-moving Frenet-Serret coordinate system. Next, <a href="#sec:equations-of-motion">Section 2.2</a> derives the equations of motions in this new coordinate system. Linearizing these equations of motion allows for an analytical description of the particle beam, presented in <a href="#sec:linear-beam-dynamics">Section 2.3</a>. The following <a href="#sec:chromaticity">Section 2.4</a> addresses the effects of energy deviations of the particle beam on the betatron tune and ways to limit these chromatic errors. <a href="#sec:synchrotron-radiation">Section 2.5</a> provides a brief overview of the effects of synchrotron radiation on the beam properties. Finally, the last section discusses the concepts introduced at the example of different periodic lattices.</p>
<section id="sec:frenet-serret-coordinates" class="level2" data-number="2.1">
<h2 data-number="2.1"><span class="header-section-number">2.1</span> The Co-moving Coordinate System</h2>
<p>To describe the motion of a particle in circular accelerators, one usually chooses the co-moving <em>Frenet-Serret coordinates</em>, whose origin follows the trajectory of the reference particle.</p>
<figure>
<img src="figures/frenet-serret-coordinates.svg" id="fig:frenet-serret-coordinates" alt="Figure 2.1: Co-moving Frenet-Serret coordinate system" /><figcaption aria-hidden="true">Figure 2.1: Co-moving Frenet-Serret coordinate system</figcaption>
</figure>
<p>The three basis vectors</p>
<div id="eq:basis-vectors">
<table style="width:99%;">
<colgroup>
<col style="width: 90%" />
<col style="width: 9%" />
</colgroup>
<tbody>
<tr class="odd">
<td style="text-align: center;"><span class="math display">
\begin{aligned}
\mathbf{\hat{e}}_\mathrm{s}(s) &amp;= \frac{\mathrm{d} \mathbf{r}_0(s)}{\mathrm{d}  s} &amp; \text{tangent basis vector} \\
\mathbf{\hat{e}}_\mathrm{x}(s) &amp;&amp; \text{horizontal basis vector} \\
\mathbf{\hat{e}}_\mathrm{y}(s) &amp;= \mathbf{\hat{e}}_\mathrm{s}(s) \times\mathbf{\hat{e}}_\mathrm{x}(s) &amp; \text{vertical basis vector}
\end{aligned}
</span></td>
<td style="text-align: right;"><span class="math display">(2.1)</span></td>
</tr>
</tbody>
</table>
</div>
<p>span the Frenet-Serret coordinate system. While the <span class="math inline">\mathbf{\hat{e}}_\mathrm{s}(s)</span> vector moves tangential to the orbit, the horizontal <span class="math inline">\mathbf{\hat{e}}_\mathrm{x}(s)</span> and vertical <span class="math inline">\mathbf{\hat{e}}_\mathrm{y}(s)</span> vectors are perpendicular to it. The <span class="math inline">s</span> coordinate describes the distance covered on the ideal orbit. The <span class="math inline">z</span> coordinate defines the path length of the individual particle trajectory. The horizontal and vertical coordinates correspond to <span class="math inline">x</span> and <span class="math inline">y</span>, respectively. For statements that are valid for both transversal planes, we will use the general variable <span class="math inline">u</span>.</p>
<p>In the Frenet-Serret system, the sum of the coordinate system’s origin <span class="math inline">\mathbf{r}_0(s)</span>, the horizontal displacement <span class="math inline">x(s) \mathbf{\hat{e}}_\mathrm{x}(s)</span>, and the vertical displacement <span class="math inline">y(s) \mathbf{\hat{e}}_\mathrm{y}(s)</span> from the nominal orbit corresponds to the position vector of the individual particle:</p>
<div id="eq:frenet-serret-position">
<table style="width:99%;">
<colgroup>
<col style="width: 90%" />
<col style="width: 9%" />
</colgroup>
<tbody>
<tr class="odd">
<td style="text-align: center;"><span class="math display">
\mathbf{r}(x,y,s) = \mathbf{r}_0(s) + x(s) \mathbf{\hat{e}}_\mathrm{x}(s) + y(s) \mathbf{\hat{e}}_\mathrm{y}(s)
</span></td>
<td style="text-align: right;"><span class="math display">(2.2)</span></td>
</tr>
</tbody>
</table>
</div>
<p>In the following, we use a dot to denote a derivative with respect to time <span class="math inline">t</span> and a prime mark to denote a derivative with respect to the orbit position <span class="math inline">s</span>. Then the velocity and acceleration in the Frenet-Serret system are</p>
<div id="eq:frenet-serret-velocity">
<table style="width:99%;">
<colgroup>
<col style="width: 90%" />
<col style="width: 9%" />
</colgroup>
<tbody>
<tr class="odd">
<td style="text-align: center;"><span class="math display">
\dot{\textbf{r}}(x,y,s) = \dot{s} x&#39; \mathbf{\hat{e}}_\mathrm{x}(s) + \dot{s} y&#39; \mathbf{\hat{e}}_\mathrm{y}(s) + \dot{s} h \mathbf{\hat{e}}_\mathrm{s}(s)
</span></td>
<td style="text-align: right;"><span class="math display">(2.3)</span></td>
</tr>
</tbody>
</table>
</div>
<p>and</p>
<div id="eq:frenet-serret-acceleration">
<table style="width:99%;">
<colgroup>
<col style="width: 90%" />
<col style="width: 9%" />
</colgroup>
<tbody>
<tr class="odd">
<td style="text-align: center;"><span class="math display"> \begin{aligned}
\ddot{\textbf{r}}(x,y,s)
&amp;= \left(x&#39;&#39;\dot{s}^2 + x&#39; \ddot{s} - h \kappa_\mathrm{x0} \dot{s}^2 \right) \mathbf{\hat{e}}_\mathrm{x}(s) \\
&amp;+ \left(y&#39;&#39; \dot{s}^2 + y&#39; \ddot{s} - h \kappa_\mathrm{y0} \dot{s}^2\right) \mathbf{\hat{e}}_\mathrm{y}(s) \\
&amp;+ \left(2 \kappa_\mathrm{x0} x&#39;\dot{s}^2+ 2 \kappa_\mathrm{y0} y&#39;\dot{s}^2+h \ddot{s}\right) \mathbf{\hat{e}}_\mathrm{s}(s) .
\end{aligned}
</span></td>
<td style="text-align: right;"><span class="math display">(2.4)</span></td>
</tr>
</tbody>
</table>
</div>
<p>Here we introduced</p>
<div id="eq:needsaname">
<table style="width:99%;">
<colgroup>
<col style="width: 90%" />
<col style="width: 9%" />
</colgroup>
<tbody>
<tr class="odd">
<td style="text-align: center;"><span class="math display">
h = 1 + \kappa_\mathrm{x0} x + \kappa_\mathrm{y0} y ,
</span></td>
<td style="text-align: right;"><span class="math display">(2.5)</span></td>
</tr>
</tbody>
</table>
</div>
<p>where <span class="math inline">\kappa_\mathrm{x0}</span> and <span class="math inline">\kappa_\mathrm{y0}</span> correspond to the horizontal and vertical curvature of the ideal orbit, respectively.</p>
</section>
<section id="sec:equations-of-motion" class="level2" data-number="2.2">
<h2 data-number="2.2"><span class="header-section-number">2.2</span> Equations of Motion</h2>
<p>A particle with the charge <span class="math inline">q</span> and the mass <span class="math inline">m</span> moving through a structure of magnets experiences the magnetic part of the Lorentz force, which defines its equations of motion</p>
<div id="eq:lorentz-force">
<table style="width:99%;">
<colgroup>
<col style="width: 90%" />
<col style="width: 9%" />
</colgroup>
<tbody>
<tr class="odd">
<td style="text-align: center;"><span class="math display">
\ddot{\mathbf{r}} = \frac{q}{m} (\dot{\mathbf{r}} \times \mathbf{B}) ,
</span></td>
<td style="text-align: right;"><span class="math display">(2.6)</span></td>
</tr>
</tbody>
</table>
</div>
<p>where <span class="math inline">\mathbf{B}</span> is the magnetic field vector. Assuming a vanishing longitudinal component of the magnetic field <span class="math inline">B_\mathrm{z} \approx 0</span>, we obtain the equations of motion in the Frenet-Serret coordinates by substituting <a href="#eq:frenet-serret-velocity">Equation 2.3</a> and <a href="#eq:frenet-serret-acceleration">Equation 2.4</a> into <a href="#eq:lorentz-force">Equation 2.6</a>:</p>
<div id="eq:eom-1">
<table style="width:99%;">
<colgroup>
<col style="width: 90%" />
<col style="width: 9%" />
</colgroup>
<tbody>
<tr class="odd">
<td style="text-align: center;"><span class="math display"> \begin{aligned}
x&#39;&#39; \dot{s}^2 + x&#39; \ddot{s} - \dot{s}^2 \kappa_\mathrm{x0} h &amp;= -\frac{q}{m} B_\mathrm{y}  h \dot{s}\\
y&#39;&#39; \dot{s}^2 + y&#39; \ddot{s} - \dot{s}^2 \kappa_\mathrm{y0} h &amp;= \frac{q}{m} B_\mathrm{x}  h \dot{s}
\end{aligned}
</span></td>
<td style="text-align: right;"><span class="math display">(2.7)</span></td>
</tr>
</tbody>
</table>
</div>
<p>The second time derivate of the orbit position <span class="math inline">\ddot{s}</span> changes when a particle travels with an offset through a bending magnet or when it moves with an angle divergence to the orbit. However, as the transversal velocities of a relativistic particle beam are small compared to the longitudinal components, the first time derivate of the orbit position <span class="math inline">\dot{s}</span> changes slowly. Therefore we can approximate</p>
<div id="eq:zero-ddot-s">
<table style="width:99%;">
<colgroup>
<col style="width: 90%" />
<col style="width: 9%" />
</colgroup>
<tbody>
<tr class="odd">
<td style="text-align: center;"><span class="math display">
\ddot{s} \approx 0,
</span></td>
<td style="text-align: right;"><span class="math display">(2.8)</span></td>
</tr>
</tbody>
</table>
</div>
<p>simplifying the equations of motion</p>
<div id="eq:eom-2">
<table style="width:99%;">
<colgroup>
<col style="width: 90%" />
<col style="width: 9%" />
</colgroup>
<tbody>
<tr class="odd">
<td style="text-align: center;"><span class="math display"> \begin{aligned}
x&#39;&#39; &amp;= -\frac{q h}{m \dot{s}} B_\textup{y} + \kappa_\textup{x0} h \\
y&#39;&#39; &amp;= \frac{q h}{m \dot{s}} B_\textup{x} + \kappa_\textup{y0} h .
\end{aligned}
</span></td>
<td style="text-align: right;"><span class="math display">(2.9)</span></td>
</tr>
</tbody>
</table>
</div>
<p>When a magnetic field deflects a charged particle, the Lorentz force takes the place of the centripetal force</p>
<div id="eq:lorentz-force-centripetal">
<table style="width:99%;">
<colgroup>
<col style="width: 90%" />
<col style="width: 9%" />
</colgroup>
<tbody>
<tr class="odd">
<td style="text-align: center;"><span class="math display"> \begin{aligned}
\mathbf{F}_\mathrm{centripetal} &amp;= \mathbf{F}_\mathrm{Lorentz} \\
- m v^2 \boldsymbol{\kappa} &amp;= q (\dot{\mathbf{r}} \times \mathbf{B}) .
\end{aligned}
</span></td>
<td style="text-align: right;"><span class="math display">(2.10)</span></td>
</tr>
</tbody>
</table>
</div>
<p>Here, the horizontal <span class="math inline">\kappa_\mathrm{x}</span> and vertical <span class="math inline">\kappa_\mathrm{y}</span> curvatures are defined as the curvatures experienced by an on-momentum particle due to the magnet lattice:</p>
<div id="eq:curvature-lorentz">
<table style="width:99%;">
<colgroup>
<col style="width: 90%" />
<col style="width: 9%" />
</colgroup>
<tbody>
<tr class="odd">
<td style="text-align: center;"><span class="math display">
\begin{aligned}
\kappa_\mathrm{x} (x,y,s) = \frac{1}{\rho_\mathrm{x} (x,y,s)} &amp;= \frac{q}{p_0} B_\mathrm{y}(x,y,s) \\
\kappa_\mathrm{y} (x,y,s) = \frac{1}{\rho_\mathrm{y} (x,y,s)} &amp;=-\frac{q}{p_0} B_\mathrm{x}(x,y,s)
\end{aligned}
</span></td>
<td style="text-align: right;"><span class="math display">(2.11)</span></td>
</tr>
</tbody>
</table>
</div>
<figure>
<img src="figures/path-length-difference.svg" id="fig:path-length-difference" alt="Figure 2.2: Path length difference between the orbit and an individual particle trajectory" /><figcaption aria-hidden="true">Figure 2.2: Path length difference between the orbit and an individual particle trajectory</figcaption>
</figure>
<p>Applying the linear approximation of the relationship between the path length of the orbit and the path length of an individual particle trajectory</p>
<div id="eq:path-length-difference">
<table style="width:99%;">
<colgroup>
<col style="width: 90%" />
<col style="width: 9%" />
</colgroup>
<tbody>
<tr class="odd">
<td style="text-align: center;"><span class="math display"> \mathrm{d}z = (1 + \kappa_\mathrm{x0} x + \kappa_\mathrm{y0} y) \mathrm{d}s + \mathcal{O}(2),
</span></td>
<td style="text-align: right;"><span class="math display">(2.12)</span></td>
</tr>
</tbody>
</table>
</div>
<p>shown in <a href="#fig:path-length-difference">Figure 2.2</a>, yields the momentum as an expression of the time derivative of the orbit position <span class="math inline">\dot{s}</span>:</p>
<div id="eq:momentum-orbit-position">
<table style="width:99%;">
<colgroup>
<col style="width: 90%" />
<col style="width: 9%" />
</colgroup>
<tbody>
<tr class="odd">
<td style="text-align: center;"><span class="math display"> p = m v \approx (1 + \kappa_\mathrm{x0} x + \kappa_\mathrm{y0} y) \dot{s} = m h \dot{s}
</span></td>
<td style="text-align: right;"><span class="math display">(2.13)</span></td>
</tr>
</tbody>
</table>
</div>
<p>We define the relative momentum deviation</p>
<div id="eq:relative-momentum-deviation">
<table style="width:99%;">
<colgroup>
<col style="width: 90%" />
<col style="width: 9%" />
</colgroup>
<tbody>
<tr class="odd">
<td style="text-align: center;"><span class="math display"> \delta = \frac{\Delta p}{p_0}
</span></td>
<td style="text-align: right;"><span class="math display">(2.14)</span></td>
</tr>
</tbody>
</table>
</div>
<p>as the ratio of the momentum deviation <span class="math inline">\Delta p</span> and the momentum of the ideal particle <span class="math inline">p_0</span>. Then we can express a particle’s momentum</p>
<div id="eq:momentum-as-relative-momentum">
<table style="width:99%;">
<colgroup>
<col style="width: 90%" />
<col style="width: 9%" />
</colgroup>
<tbody>
<tr class="odd">
<td style="text-align: center;"><span class="math display">
p = p_0 + \Delta p = p_0 (1 + \delta)
</span></td>
<td style="text-align: right;"><span class="math display">(2.15)</span></td>
</tr>
</tbody>
</table>
</div>
<p>in terms of its momentum deviation <span class="math inline">\delta</span> and the ideal momentum <span class="math inline">p_0</span>.</p>
<p>Subsituting <a href="#eq:curvature-lorentz">Equation 2.11</a>, <a href="#eq:momentum-orbit-position">Equation 2.13</a>, and <a href="#eq:momentum-as-relative-momentum">Equation 2.15</a> into <a href="#eq:eom-2">Equation 2.9</a>, we obtain a second-order differential equation for the equations of motion</p>
<div id="eq:eom-integratable">
<table style="width:99%;">
<colgroup>
<col style="width: 90%" />
<col style="width: 9%" />
</colgroup>
<tbody>
<tr class="odd">
<td style="text-align: center;"><span class="math display">
\begin{aligned}
x&#39;&#39; &amp;= - \frac{h^2}{(1 + \delta)} \kappa_\mathrm{x} + h \kappa_\mathrm{x0} \\
y&#39;&#39; &amp;=  \frac{h^2}{(1 + \delta)} \kappa_\mathrm{y} + h \kappa_\mathrm{y0},
\end{aligned}
</span></td>
<td style="text-align: right;"><span class="math display">(2.16)</span></td>
</tr>
</tbody>
</table>
</div>
<p>completely defined by the geometric multipole strengths of the magnetic lattice of the accelerator</p>
<div id="eq:expansion-of-curvature">
<table style="width:99%;">
<colgroup>
<col style="width: 90%" />
<col style="width: 9%" />
</colgroup>
<tbody>
<tr class="odd">
<td style="text-align: center;"><span class="math display">
\begin{aligned}
\kappa_\mathrm{x}(x,y,s) &amp;= \kappa_\mathrm{x0}(s) + k(s) x + m(s) (x^2 - y^2) + ... \\
\kappa_\mathrm{y}(x,y,s) &amp;= \kappa_\mathrm{y0}(s) + k(s) y + m(s) x y + ... \; .
\end{aligned}
</span></td>
<td style="text-align: right;"><span class="math display">(2.17)</span></td>
</tr>
</tbody>
</table>
</div>
<p>Integrating <a href="#eq:eom-integratable">Equation 2.16</a> yields the individual particle trajectories and can be used to track particles through non-linear elements. An experimental implementation of this method is included in the developed code, but it is not as performant as other tracking methods of more mature codes. Nevertheless, it was, for example, used to create the plots in <a href="#sec:chromaticity">Section 2.4</a>.</p>
</section>
<section id="sec:linear-beam-dynamics" class="level2" data-number="2.3">
<h2 data-number="2.3"><span class="header-section-number">2.3</span> Linear Beam Dynamics</h2>
<p><a href="#eq:eom-integratable">Equation 2.16</a> does not allow for analytical investigations. Courant and Synder <span class="citation" data-cites="courantsnyder"><a href="#ref-courantsnyder" role="doc-biblioref">[19]</a></span> developed a formalism that allows describing the particle beam using analytic quantities by linearizing the equations of motion. My bachelor’s thesis <span class="citation" data-cites="andreas_ba"><a href="#ref-andreas_ba" role="doc-biblioref">[5]</a></span> thoroughly discussed the theory of linear beam dynamics. Therefore this section skips most of the derivations and only provides a summary of the most important results.</p>
<section id="linearized-equations-of-motion" class="level3" data-number="2.3.1">
<h3 data-number="2.3.1"><span class="header-section-number">2.3.1</span> Linearized Equations of Motion</h3>
<p>To linearize <a href="#eq:eom-integratable">Equation 2.16</a>, we expand the expression</p>
<div id="eq:taylor-momentum">
<table style="width:99%;">
<colgroup>
<col style="width: 90%" />
<col style="width: 9%" />
</colgroup>
<tbody>
<tr class="odd">
<td style="text-align: center;"><span class="math display">
\frac{1}{1 + \delta} =  1 - \delta + \mathcal{O}(2)
</span></td>
<td style="text-align: right;"><span class="math display">(2.18)</span></td>
</tr>
</tbody>
</table>
</div>
<p>in <span class="math inline">\delta</span>, leading to:</p>
<div id="eq:eom-momentum-approximaton">
<table style="width:99%;">
<colgroup>
<col style="width: 90%" />
<col style="width: 9%" />
</colgroup>
<tbody>
<tr class="odd">
<td style="text-align: center;"><span class="math display">
\begin{aligned}
x&#39;&#39; &amp;= - (1 - \delta)(1 + \kappa_\mathrm{x0})^2 (\kappa_\mathrm{x0} + k x) + \kappa_\mathrm{x0} (1 + \kappa_\mathrm{x0} x)\\
y&#39;&#39; &amp;= (1 - \delta)(1 + \kappa_\mathrm{x0})^2 k y
\end{aligned}
</span></td>
<td style="text-align: right;"><span class="math display">(2.19)</span></td>
</tr>
</tbody>
</table>
</div>
<p>Multiplying out the parentheses and only keeping terms linear in <span class="math inline">x</span>, <span class="math inline">y</span>, and <span class="math inline">\delta</span>, we obtain the linearized equations of motion:</p>
<div id="eq:eom-linearized">
<table style="width:99%;">
<colgroup>
<col style="width: 90%" />
<col style="width: 9%" />
</colgroup>
<tbody>
<tr class="odd">
<td style="text-align: center;"><span class="math display">
\begin{aligned}
x&#39;&#39; + (\kappa_\mathrm{x0}^2 + k) x &amp;= \kappa_\mathrm{x0} \delta \\
y&#39;&#39; - k y &amp;= 0
\end{aligned}
</span></td>
<td style="text-align: right;"><span class="math display">(2.20)</span></td>
</tr>
</tbody>
</table>
</div>
<p><a href="#eq:eom-linearized">Equation 2.20</a> is a linear second order differential equation, which can be solved analytically. Therefore, the transformation of the particle trajectory</p>
<div id="eq:particle-vector">
<table style="width:99%;">
<colgroup>
<col style="width: 90%" />
<col style="width: 9%" />
</colgroup>
<tbody>
<tr class="odd">
<td style="text-align: center;"><span class="math display">
\begin{aligned}
\textbf{X}(s) =
\begin{pmatrix}
x(s) \\ x&#39;(s) \\ y(s) \\ y&#39;(s) \\ l(s) \\ \delta(s)
\end{pmatrix}
=
\begin{pmatrix}
\textup{horizontal offset} \\ \textup{horizontal slope} \\ \textup{vertical offset}\\ \textup{vertical slope} \\ \textup{longitudinal offset}  \\ \textup{relative momentum deviation}
\end{pmatrix}
\end{aligned}
</span></td>
<td style="text-align: right;"><span class="math display">(2.21)</span></td>
</tr>
</tbody>
</table>
</div>
<p>through beam transport elements can be described as a matrix multiplication</p>
<div id="eq:transformation-particle-vector">
<table style="width:99%;">
<colgroup>
<col style="width: 90%" />
<col style="width: 9%" />
</colgroup>
<tbody>
<tr class="odd">
<td style="text-align: center;"><span class="math display"> \textbf{X}(s+L) = \textbf{R}(s,s+L) \textbf{X}(s) ,
</span></td>
<td style="text-align: right;"><span class="math display">(2.22)</span></td>
</tr>
</tbody>
</table>
</div>
<p>where <span class="math inline">\mathbf{R}</span> is a <span class="math inline">6 \times 6</span> transfer matrix. The solutions of <a href="#eq:eom-linearized">Equation 2.20</a> for a drift section (<span class="math inline">\kappa_\mathrm{x0} = k = 0</span>), for a dipole magnet (<span class="math inline">\kappa_\mathrm{x0} \neq 0, k = 0</span>), and for a quadrupole (<span class="math inline">\kappa_\mathrm{x0} = 0, k \neq 0</span>) are included in <a href="#sec:appendix-transfer-matrices">Section 9</a>.</p>
</section>
<section id="sec:betatron-oscillation" class="level3" data-number="2.3.2">
<h3 data-number="2.3.2"><span class="header-section-number">2.3.2</span> Betatron Oscillation</h3>
<p>Tracking a particle through the beam transport system by applying the different transfer matrices of beam transport elements yields the individual particle trajectory. However, Courant and Synder <span class="citation" data-cites="courantsnyder"><a href="#ref-courantsnyder" role="doc-biblioref">[19]</a></span> developed a formalism, revealing more insightful analytical properties of the entire particle beam. The <em>Courant-Snyder functions</em>, sometimes called <em>Twiss parameters</em>, arise from separating the on- and off-momentum motion.</p>
<p>Therefore, we first solve the linearized equations of motion, <a href="#eq:eom-linearized">Equation 2.20</a>, for the <em>dispersion-free</em> case, leading us to the most fundamental quantity of the transversal beam motion, the beta function <span class="math inline">\beta(s)</span>. Then, in <a href="#sec:dispersion">Section 2.3.4</a>, we introduce the dispersion function <span class="math inline">\eta(s)</span> to account for the transverse motions caused by momentum deviations.</p>
<p>By neglecting the off-momentum terms and combining the focusing terms into one parameter <span class="math inline">K_\mathrm{x}(s) = \kappa_\mathrm{x0}^2(s) + k(s)</span> for the horizontal and <span class="math inline">K_\mathrm{y}(s) = - k(s)</span> for the vertical plane, the linear equations of motion become</p>
<div id="eq:hill-equation">
<table style="width:99%;">
<colgroup>
<col style="width: 90%" />
<col style="width: 9%" />
</colgroup>
<tbody>
<tr class="odd">
<td style="text-align: center;"><span class="math display"> u&#39;&#39;(s) + K_u(s) u(s) = 0 .
</span></td>
<td style="text-align: right;"><span class="math display">(2.23)</span></td>
</tr>
</tbody>
</table>
</div>
<p><a href="#eq:hill-equation">Equation 2.23</a>, known as <em>Hill’s equation</em>, is a second-order linear ordinary differential equation similar to the harmonic oscillator. The difference is that the parameter <span class="math inline">K(s) = K(s + C)</span> is not constant but is a function periodic with the circumference of the accelerator <span class="math inline">C</span>. The <em>Floquet’s theorem</em> states that Hill’s equation has two linearly independent solutions, given by the product of a complex exponential function and a periodic function <span class="citation" data-cites="magnus_winkler"><a href="#ref-magnus_winkler" role="doc-biblioref">[20]</a></span>. The real part of the general solution of Hill’s equation is</p>
<div id="eq:betatron-oscillation">
<table style="width:99%;">
<colgroup>
<col style="width: 90%" />
<col style="width: 9%" />
</colgroup>
<tbody>
<tr class="odd">
<td style="text-align: center;"><span class="math display"> u(s) = \sqrt{\epsilon_u \beta_u (s)} \cos(\psi_u(s) + \psi_{u0}),
</span></td>
<td style="text-align: right;"><span class="math display">(2.24)</span></td>
</tr>
</tbody>
</table>
</div>
<p>where we identify the integration constants <span class="math inline">\epsilon</span> and <span class="math inline">\psi_0</span> with the emittance and the initial betatron phase, respectively. The beta function <span class="math inline">\beta_u(s)</span> is periodic with the circumference of the accelerator <span class="math inline">C</span>.</p>
<figure>
<img src="figures/betatron-oscillation.svg" id="fig:betatron-oscillation" alt="Figure 2.3: The envelope of a particle beam at the example of a FODO cell. The right plot shows the betatron oscillation for 33 electrons with an emittance of 5 nm rad. (extracted from [5])" /><figcaption aria-hidden="true">Figure 2.3: The envelope of a particle beam at the example of a FODO cell. The right plot shows the betatron oscillation for 33 electrons with an emittance of 5 nm rad. (extracted from <span class="citation" data-cites="andreas_ba"><a href="#ref-andreas_ba" role="doc-biblioref">[5]</a></span>)</figcaption>
</figure>
<p><a href="#fig:betatron-oscillation">Figure 2.3</a> shows the particle trajectories and the beam envelope as defined by <a href="#eq:betatron-oscillation">Equation 2.24</a>. The individual particles oscillate within the envelope</p>
<div id="eq:betatron-envelope">
<table style="width:99%;">
<colgroup>
<col style="width: 90%" />
<col style="width: 9%" />
</colgroup>
<tbody>
<tr class="odd">
<td style="text-align: center;"><span class="math display"> E(s) = \pm \sqrt{\epsilon \beta(s)} .
</span></td>
<td style="text-align: right;"><span class="math display">(2.25)</span></td>
</tr>
</tbody>
</table>
</div>
<p>As the beta function <span class="math inline">\beta(s)</span> determines the shape of this envelope, and therefore the transverse beam size, it is considered one of the most important quantities in circular accelerator physics.</p>
<p>By substituting <a href="#eq:betatron-oscillation">Equation 2.24</a> and its second derivative into <a href="#eq:hill-equation">Equation 2.23</a>, we obtain an expression for the <em>betatron phase</em></p>
<div id="eq:betatron-phase">
<table style="width:99%;">
<colgroup>
<col style="width: 90%" />
<col style="width: 9%" />
</colgroup>
<tbody>
<tr class="odd">
<td style="text-align: center;"><span class="math display"> \psi_u(s) = \int_0^s \frac{\mathrm{d} s^*}{\beta_u(s^*)} .
</span></td>
<td style="text-align: right;"><span class="math display">(2.26)</span></td>
</tr>
</tbody>
</table>
</div>
<p>The <em>tune</em></p>
<div id="eq:tune">
<table style="width:99%;">
<colgroup>
<col style="width: 90%" />
<col style="width: 9%" />
</colgroup>
<tbody>
<tr class="odd">
<td style="text-align: center;"><span class="math display"> Q_u = \frac{1}{2 \pi}\int_s^{s+C} \frac{d s^*}{\beta_u (s^*)}
</span></td>
<td style="text-align: right;"><span class="math display">(2.27)</span></td>
</tr>
</tbody>
</table>
</div>
<p>describes the number of betatron oscillations per turn.</p>
<p>By rearranging <a href="#eq:betatron-oscillation">Equation 2.24</a> and its first derivative with respect to the orbit position <span class="math inline">s</span></p>
<div id="eq:betatron-oscillation-first-derivative">
<table style="width:99%;">
<colgroup>
<col style="width: 90%" />
<col style="width: 9%" />
</colgroup>
<tbody>
<tr class="odd">
<td style="text-align: center;"><span class="math display"> u&#39;(s) = -\frac{\sqrt{\epsilon}}{\sqrt{\beta_u (s)}}(\alpha_u(s)\cos(\psi_u(s) + \psi_{u0}) + \sin(\psi_u(s) + \psi_{u0})) ,
</span></td>
<td style="text-align: right;"><span class="math display">(2.28)</span></td>
</tr>
</tbody>
</table>
</div>
<p>we obtain an ellipse equation for the Twiss parameters</p>
<div id="eq:phase-space-ellipse">
<table style="width:99%;">
<colgroup>
<col style="width: 90%" />
<col style="width: 9%" />
</colgroup>
<tbody>
<tr class="odd">
<td style="text-align: center;"><span class="math display"> \epsilon_u = \gamma_u(s) u^2(s) + 2 \alpha_u(s) u(s)u&#39;(s) + \beta_u(s) u&#39;^2(s) ,
</span></td>
<td style="text-align: right;"><span class="math display">(2.29)</span></td>
</tr>
</tbody>
</table>
</div>
<p>where</p>
<div>
<table style="width:99%;">
<colgroup>
<col style="width: 90%" />
<col style="width: 9%" />
</colgroup>
<tbody>
<tr class="odd">
<td style="text-align: center;"><span class="math display"> \alpha(s) := \frac{-\beta&#39;(s)}{2}
</span></td>
<td style="text-align: right;"><span class="math display">(2.30)</span></td>
</tr>
</tbody>
</table>
</div>
<p>and</p>
<div>
<table style="width:99%;">
<colgroup>
<col style="width: 90%" />
<col style="width: 9%" />
</colgroup>
<tbody>
<tr class="odd">
<td style="text-align: center;"><span class="math display"> \gamma(s) := \frac{1 + \alpha^2(s)}{\beta(s)} .
</span></td>
<td style="text-align: right;"><span class="math display">(2.31)</span></td>
</tr>
</tbody>
</table>
</div>
<p>Following <a href="#eq:phase-space-ellipse">Equation 2.29</a>, the trajectory of betatron oscillation forms an ellipse in the <span class="math inline">(u, u&#39;)</span>-phase space. The Twiss parameters <span class="math inline">\alpha(s)</span>, <span class="math inline">\beta(s)</span>, and <span class="math inline">\gamma(s)</span> determine the shape of this ellipse at the orbit position <span class="math inline">s</span>. The emittance <span class="math inline">\epsilon</span>, which we introduced as an integration constant, describes the occupied phase space volume of the ellipse <span class="math inline">A = \pi \epsilon</span>, according to <em>Liouville’s theorem</em> a constant of motion <span class="citation" data-cites="Nolting2018"><a href="#ref-Nolting2018" role="doc-biblioref">[21]</a></span>.</p>
<p>Furthermore, supposing the Twiss parameters <span class="math inline">\alpha</span>, <span class="math inline">\beta</span>, and <span class="math inline">\gamma</span> are know for the positons <span class="math inline">s</span> and <span class="math inline">s + L</span>. Then, the 2×2-sub-matrices <span class="math inline">\mathbf{R}_u^{2\times 2}(s,L)</span> of <span class="math inline">\mathbf{R}(s, L)</span> describing the transformation of a particle from the orbit position <span class="math inline">s</span> to <span class="math inline">s + L</span> within horizontal or vertical plane is</p>
<div id="eq:transfer-matrix-beta">
<table style="width:99%;">
<colgroup>
<col style="width: 90%" />
<col style="width: 9%" />
</colgroup>
<tbody>
<tr class="odd">
<td style="text-align: center;"><span class="math display"> \mathbf{R}_u^{2\times 2}(s,L) =
\begin{pmatrix}
\sqrt{\frac{\beta_1}{\beta_0}}(\cos{\psi_1} + \alpha_0 \sin{\psi_1}) &amp; \sqrt{\beta_0\beta_1} \sin{\psi_1} \\
\frac{\alpha_0 - \alpha_1}{\sqrt{\beta_0\beta_1}} \cos{\psi_1} - \frac{1 + \alpha_0\alpha_1 }{\sqrt{\beta_0\beta_1}} \sin{\psi_1}  &amp; \sqrt{\frac{\beta_0}{\beta_1}}(\cos{\psi_1} - \alpha_1 \sin{\psi_1}) ,
\end{pmatrix}
</span></td>
<td style="text-align: right;"><span class="math display">(2.32)</span></td>
</tr>
</tbody>
</table>
</div>
<p>where <span class="math inline">\beta_0 = \beta_u(s)</span>, <span class="math inline">\beta_1 = \beta_u(s+L)</span>, <span class="math inline">\alpha_0 = \alpha_u(s)</span>, <span class="math inline">\alpha_1 = \alpha_u(s+L)</span>, and <span class="math inline">\psi_1 = \psi_u(s+L)</span>.</p>
</section>
<section id="sec:transformation-twiss-parameter" class="level3" data-number="2.3.3">
<h3 data-number="2.3.3"><span class="header-section-number">2.3.3</span> Transformation of the Twiss parameters</h3>
<p><a href="#eq:phase-space-ellipse">Equation 2.29</a> can be written in matrix form:</p>
<div id="eq:phase-space-ellipse-matrix">
<table style="width:99%;">
<colgroup>
<col style="width: 90%" />
<col style="width: 9%" />
</colgroup>
<tbody>
<tr class="odd">
<td style="text-align: center;"><span class="math display">
\epsilon_u =
\begin{pmatrix}
u(s) &amp; u&#39;(s)
\end{pmatrix}
\begin{pmatrix}
\gamma_u(s) &amp; \alpha_u(s) \\
\alpha_u(s) &amp; \beta_u(s)
\end{pmatrix}
\begin{pmatrix}
u(s) \\
u&#39;(s)
\end{pmatrix}
</span></td>
<td style="text-align: right;"><span class="math display">(2.33)</span></td>
</tr>
</tbody>
</table>
</div>
<p>We define the <em>Twiss matrix</em></p>
<div id="eq:beta-matrix">
<table style="width:99%;">
<colgroup>
<col style="width: 90%" />
<col style="width: 9%" />
</colgroup>
<tbody>
<tr class="odd">
<td style="text-align: center;"><span class="math display"> \mathbf{B}_u(s) =
\begin{pmatrix}
\beta_u(s) &amp; -\alpha_u(s) \\
-\alpha_u(s) &amp; \gamma_u(s)
\end{pmatrix} .
</span></td>
<td style="text-align: right;"><span class="math display">(2.34)</span></td>
</tr>
</tbody>
</table>
</div>
<p>Since the emittance <span class="math inline">\epsilon</span> is the same at the position <span class="math inline">s</span> and <span class="math inline">s + L</span>, rearranging <a href="#eq:phase-space-ellipse-matrix">Equation 2.33</a></p>
<div id="eq:transformation-beta-matrix-derivation">
<table style="width:99%;">
<colgroup>
<col style="width: 90%" />
<col style="width: 9%" />
</colgroup>
<tbody>
<tr class="odd">
<td style="text-align: center;"><span class="math display">
\begin{aligned}
\epsilon &amp; = \textbf{X}^\mathrm{T}(s) \textbf{B}^{-1}(s) \textbf{X}(s) \\
&amp; = \textbf{X}^\mathrm{T}(s) \textbf{R}^\mathrm{T} (\textbf{R}^\mathrm{T})^{-1} \textbf{B}^{-1}(s) \textbf{R}^{-1} \textbf{R} \textbf{X}(s) \\
&amp; = (\textbf{R} \textbf{X}(s) )^\mathrm{T} (\textbf{R} \textbf{B}(s) \textbf{R}^\mathrm{T})^{-1} (\textbf{R} \textbf{X}(s)) \\
&amp; = \textbf{X}^\mathrm{T}(s+L) (\textbf{R} \textbf{B}(s) \textbf{R}^\mathrm{T})^{-1} \textbf{X}(s+L) \\
&amp; \overset{!}{=} \textbf{X}^\mathrm{T}(s+L) \textbf{B}^{-1}(s+L) \textbf{X}(s+L),
\end{aligned}
</span></td>
<td style="text-align: right;"><span class="math display">(2.35)</span></td>
</tr>
</tbody>
</table>
</div>
<p>results in an expression for the transformation of the Twiss parameters</p>
<div id="eq:transformation-beta-matrix">
<table style="width:99%;">
<colgroup>
<col style="width: 90%" />
<col style="width: 9%" />
</colgroup>
<tbody>
<tr class="odd">
<td style="text-align: center;"><span class="math display"> \mathbf{B}(s+L) = \mathbf{R}(s,L) \mathbf{B}(s) \mathbf{R}^\mathrm{T}(s,L) .
</span></td>
<td style="text-align: right;"><span class="math display">(2.36)</span></td>
</tr>
</tbody>
</table>
</div>
<p>Multiplying the matrices of <a href="#eq:transformation-beta-matrix">Equation 2.36</a> yields a system of linear equations</p>
<div id="eq:betatron-function-transformation">
<table style="width:99%;">
<colgroup>
<col style="width: 90%" />
<col style="width: 9%" />
</colgroup>
<tbody>
<tr class="odd">
<td style="text-align: center;"><span class="math display">
\begin{aligned}
\beta(s+L) &amp;= R_{11}^2\beta(s)-2R_{11}R_{12}\alpha(s)+R_{12}^2\gamma(s)\\
\alpha(s+L) &amp;= -R_{11}R_{12}\beta(s)+(R_{11}R_{22}+R_{12}^2)\alpha(s)+R_{12}R_{22}\gamma(s)\\
\gamma(s+L) &amp;= R_{12}^2\beta(s)-2R_{12}R_{22}\alpha(s)+R_{22}^2\gamma(s) .
\end{aligned}
</span></td>
<td style="text-align: right;"><span class="math display">(2.37)</span></td>
</tr>
</tbody>
</table>
</div>
<p>For a stable solution to exist, the Twiss functions must have the same value after one revolution, leading to the periodicity condition for circular accelerators</p>
<div id="eq:beta-perodicity-condition">
<table style="width:99%;">
<colgroup>
<col style="width: 90%" />
<col style="width: 9%" />
</colgroup>
<tbody>
<tr class="odd">
<td style="text-align: center;"><span class="math display">
\begin{aligned}
\beta(s)  &amp;= \beta(s + C_0)  \\
\alpha(s) &amp;= \alpha(s + C_0) \\
\gamma(s) &amp;= \gamma(s + C_0) ,
\end{aligned}
</span></td>
<td style="text-align: right;"><span class="math display">(2.38)</span></td>
</tr>
</tbody>
</table>
</div>
<p>where <span class="math inline">C_0</span> is the length of the ideal orbit. Using this condition we can solve the system of linear equations of <a href="#eq:betatron-function-transformation">Equation 2.37</a>, yielding the Twiss functions as expression of the one-turn-matrix <span class="math inline">\mathbf{R}(s, C_0)</span>:</p>
<div id="eq:beta-initial-values">
<table style="width:99%;">
<colgroup>
<col style="width: 90%" />
<col style="width: 9%" />
</colgroup>
<tbody>
<tr class="odd">
<td style="text-align: center;"><span class="math display">
\begin{aligned}
\beta(s)  &amp;= \frac{2 R_{12}}{\sqrt{2 - R_{11}^2 - 2 R_{12} R_{21} - R_{22}^2}} \\
\alpha(s) &amp;= \frac{R_{11}-R_{22}}{2 R_{12}} \beta(s) \\
\gamma(s) &amp;= \frac{1 + \alpha^2(s)}{\beta(s)}.
\end{aligned}
</span></td>
<td style="text-align: right;"><span class="math display">(2.39)</span></td>
</tr>
</tbody>
</table>
</div>
<p>From the expression of the beta function <span class="math inline">\beta(s)</span> in <a href="#eq:beta-initial-values">Equation 2.39</a>, it follows that a stable solution only exists for</p>
<div id="eq:stability-condition">
<table style="width:99%;">
<colgroup>
<col style="width: 90%" />
<col style="width: 9%" />
</colgroup>
<tbody>
<tr class="odd">
<td style="text-align: center;"><span class="math display"> 2 - R_{11}^2 - 2 R_{12} R_{21} - R_{22}^2 &gt; 0 ,
</span></td>
<td style="text-align: right;"><span class="math display">(2.40)</span></td>
</tr>
</tbody>
</table>
</div>
<p>defining a stability criteria.</p>
</section>
<section id="sec:dispersion" class="level3" data-number="2.3.4">
<h3 data-number="2.3.4"><span class="header-section-number">2.3.4</span> Dispersion</h3>
<p>The <em>dispersion function</em></p>
<div id="eq:dispersion-function-definition">
<table style="width:99%;">
<colgroup>
<col style="width: 90%" />
<col style="width: 9%" />
</colgroup>
<tbody>
<tr class="odd">
<td style="text-align: center;"><span class="math display"> \eta_u(s) = \frac{\mathrm{d} u(s)}{\mathrm{d} \delta}
</span></td>
<td style="text-align: right;"><span class="math display">(2.41)</span></td>
</tr>
</tbody>
</table>
</div>
<p>describes the change in the transverse offset <span class="math inline">u(s)</span> with respect to the relative momentum deviation <span class="math inline">\delta</span>. Therefore, the trajectory of an off-momentum particle is given by the sum of the betatron oscillation <span class="math inline">u_\beta(s)</span> and the dispersive offset <span class="math inline">u_\delta = \eta_u(s) \delta</span>:</p>
<div id="eq:transverse-offset-dispersion">
<table style="width:99%;">
<colgroup>
<col style="width: 90%" />
<col style="width: 9%" />
</colgroup>
<tbody>
<tr class="odd">
<td style="text-align: center;"><span class="math display"> u(s) = u_\beta(s) + u_\delta(s) = u_\beta(s) + \eta_u(s) \delta
</span></td>
<td style="text-align: right;"><span class="math display">(2.42)</span></td>
</tr>
</tbody>
</table>
</div>
<p>Supposing the values of the dispersion function <span class="math inline">\eta(s)</span> and its derivative <span class="math inline">\eta&#39;(s)</span> are known at the orbit position <span class="math inline">s</span>. Then, the transfer matrix <span class="math inline">\mathbf{R}(s, L)</span> determines their values at the orbit position <span class="math inline">s + L</span>:</p>
<div id="eq:dispersion-transformation">
<table style="width:99%;">
<colgroup>
<col style="width: 90%" />
<col style="width: 9%" />
</colgroup>
<tbody>
<tr class="odd">
<td style="text-align: center;"><span class="math display">
\begin{aligned}
\eta(s + L) &amp;= R_{11} \eta(s) + R_{12} \eta&#39;(s) + R_{16} \\
\eta&#39;(s + L) &amp;= R_{21} \eta(s) + R_{22} \eta&#39;(s) + R_{26}
\end{aligned}
</span></td>
<td style="text-align: right;"><span class="math display">(2.43)</span></td>
</tr>
</tbody>
</table>
</div>
<p>Using the periodicity condition for circular accelerators</p>
<div id="eq:dispersion-perodicity-condition">
<table style="width:99%;">
<colgroup>
<col style="width: 90%" />
<col style="width: 9%" />
</colgroup>
<tbody>
<tr class="odd">
<td style="text-align: center;"><span class="math display">
\begin{aligned}
\eta(s)  &amp;= \eta(s + C_0)  \\
\eta&#39;(s) &amp;= \eta&#39;(s + C_0)
\end{aligned}
</span></td>
<td style="text-align: right;"><span class="math display">(2.44)</span></td>
</tr>
</tbody>
</table>
</div>
<p>the dispersion function <span class="math inline">\eta(s)</span> and its derivative <span class="math inline">\eta&#39;(s)</span> can be expressed in terms of the one-turn-matrix <span class="math inline">\mathbf{R}(s, C_0)</span>:</p>
<div id="eq:dispersion-initial-values">
<table style="width:99%;">
<colgroup>
<col style="width: 90%" />
<col style="width: 9%" />
</colgroup>
<tbody>
<tr class="odd">
<td style="text-align: center;"><span class="math display">
\begin{aligned}
\eta(s)  &amp;= \frac{R_{16}(1 - R_{22}) + R_{12}R_{26}}{2 - R_{11} - R_{22}} \\
\eta&#39;(s) &amp;= \frac{R_{16}(1 - R_{11}) + R_{21}R_{16}}{2 - R_{11} - R_{22}}
\end{aligned}
</span></td>
<td style="text-align: right;"><span class="math display">(2.45)</span></td>
</tr>
</tbody>
</table>
</div>
<p>To calculate the graph of <span class="math inline">\eta(s)</span> and <span class="math inline">\eta&#39;(s)</span> along the entire ring, <a href="#eq:dispersion-initial-values">Equation 2.45</a> can be used to calculate the values <span class="math inline">\eta_0 = \eta(s_0)</span> and <span class="math inline">\eta&#39;_0 = \eta&#39;(s_0)</span> at an initial orbit position <span class="math inline">s_0</span>. Afterward, <a href="#eq:dispersion-transformation">Equation 2.43</a> yields the values of <span class="math inline">\eta(s)</span> and <span class="math inline">\eta&#39;(s)</span> for all other orbit positions <span class="math inline">s</span>.</p>
</section>
<section id="momentum-compaction" class="level3" data-number="2.3.5">
<h3 data-number="2.3.5"><span class="header-section-number">2.3.5</span> Momentum Compaction</h3>
<p>The <em>momentum compaction factor</em></p>
<div id="eq:momentum-compation-factor">
<table style="width:99%;">
<colgroup>
<col style="width: 90%" />
<col style="width: 9%" />
</colgroup>
<tbody>
<tr class="odd">
<td style="text-align: center;"><span class="math display">
\begin{aligned}
\alpha_\mathrm{c} = \frac{1}{C_0}\frac{\mathrm{d} C}{\mathrm{d}\delta} \quad \mathrm{with} \quad C = C_\beta + \Delta C_\delta,
\end{aligned}
</span></td>
<td style="text-align: right;"><span class="math display">(2.46)</span></td>
</tr>
</tbody>
</table>
</div>
<p>is defined as the ratio between the change in the path length of a dispersive particle for one revolution <span class="math inline">C</span> with respect to the relative momentum deviation <span class="math inline">\delta</span> and the path length of the ideal orbit <span class="math inline">C_0</span>. While <span class="math inline">C_\beta</span> is the path length of an on-momentum particle,</p>
<div id="eq:dispersive-path-length">
<table style="width:99%;">
<colgroup>
<col style="width: 90%" />
<col style="width: 9%" />
</colgroup>
<tbody>
<tr class="odd">
<td style="text-align: center;"><span class="math display">
\Delta C_\delta = C - C_\beta = \int_0^{C} \mathrm{d} z - \int_0^{C_\beta} \mathrm{d} z&#39;
</span></td>
<td style="text-align: right;"><span class="math display">(2.47)</span></td>
</tr>
</tbody>
</table>
</div>
<p>corresponds to the path length difference caused by the momentum deviation. Applying the linear approximation of the path length element <span class="math inline">\mathrm{d}z \approx (1 + \kappa_\mathrm{x0} x) \mathrm{d}s</span>, introduced in <a href="#eq:path-length-difference">Equation 2.12</a>, to <a href="#eq:dispersive-path-length">Equation 2.47</a> yields</p>
<div id="eq:dispersive-path-length-approximation">
<table style="width:99%;">
<colgroup>
<col style="width: 90%" />
<col style="width: 9%" />
</colgroup>
<tbody>
<tr class="odd">
<td style="text-align: center;"><span class="math display">
\begin{aligned}
\Delta C_\delta &amp;= \int_0^{C_0} 1 + \kappa_\mathrm{x0}(s) (u_\beta(s) + u_\delta(s)) \mathrm{d} s - \int_0^{C_0} 1 + \kappa_\mathrm{x0}(s)u_\beta(s) \mathrm{d} s \\
&amp;= \delta \int_0^{C_0} \kappa_\mathrm{x0}(s) \eta(s)  \mathrm{d} s .
\end{aligned}
</span></td>
<td style="text-align: right;"><span class="math display">(2.48)</span></td>
</tr>
</tbody>
</table>
</div>
<p>Substituting <a href="#eq:dispersive-path-length-approximation">Equation 2.48</a> into <a href="#eq:momentum-compation-factor">Equation 2.46</a>, we obtain an expression for the momentum compaction factor</p>
<div id="eq:momentum-compation-factor-expression">
<table style="width:99%;">
<colgroup>
<col style="width: 90%" />
<col style="width: 9%" />
</colgroup>
<tbody>
<tr class="odd">
<td style="text-align: center;"><span class="math display">
\begin{aligned}
\alpha_\textup{c} = \frac{1}{C_0} \int_0^{C_0} \kappa_\mathrm{x0}(s) \eta(s)  \mathrm{d} s ,
\end{aligned}
</span></td>
<td style="text-align: right;"><span class="math display">(2.49)</span></td>
</tr>
</tbody>
</table>
</div>
<p>corresponding to the mean value of the product between the curvature of the ideal orbit <span class="math inline">\kappa_\mathrm{x0}(s)</span> and the dispersion function <span class="math inline">\eta(s)</span>.</p>
</section>
</section>
<section id="sec:chromaticity" class="level2" data-number="2.4">
<h2 data-number="2.4"><span class="header-section-number">2.4</span> Chromaticity</h2>
<p>As discussed in the previous section, many effects of beam dynamics can be explained by the analysis of the linear equations of motion. However, certain phenomena can only be understood considering the higher-order terms.</p>
<p>The first subsection discusses the influence of energy deviations on the betatron tune and why they are harmful to the beam quality. Using elements with non-linear field components can limit these effects, described in the following subsection.</p>
<section id="sec:natural-chromaticity" class="level3" data-number="2.4.1">
<h3 data-number="2.4.1"><span class="header-section-number">2.4.1</span> Natural Chromaticity in a Storage Ring</h3>
<p>The number of betatron oscillations per turn, defined by the tune, is determined by the position and strength of the quadrupole and bending magnets. However, as the experienced multipole strength of a particle depends on its momentum, off-momentum particles will complete a different number of betatron oscillations per turn. <a href="#fig:chromaticity-quadrupole">Figure 2.4</a> shows the influence of the momentum deviation on the focal length of a quadrupole. Generally, particles with a higher momentum <span class="math inline">\delta &gt; 0</span> are less deflected by a quadrupole, resulting in fewer betatron oscillations. On the other hand, particles with a negative momentum deviation <span class="math inline">\delta &lt; 0</span> undergo a larger deflection, leading to a higher tune.</p>
<figure>
<img src="figures/chromaticity-quadrupole.svg" id="fig:chromaticity-quadrupole" alt="Figure 2.4: Impact of the momentum deviation on the focal length of a quadrupole. The trajectories were calculated by integrating Equation 2.16. The dashed lines correspond to the particle trajectories without momentum deviation \delta = 0. The stronger deflection for particles with \delta &lt; 0 (red) leads to a shorter focal length. Particles with \delta &gt; 0 (blue) are less deflected, resulting in a longer focal length. In the case of on-momentum particle \delta = 0 (green), the trajectories are identical to the linear case." /><figcaption aria-hidden="true">Figure 2.4: Impact of the momentum deviation on the focal length of a quadrupole. The trajectories were calculated by integrating <a href="#eq:eom-integratable">Equation 2.16</a>. The dashed lines correspond to the particle trajectories without momentum deviation <span class="math inline">\delta = 0</span>. The stronger deflection for particles with <span class="math inline">\delta &lt; 0</span> (red) leads to a shorter focal length. Particles with <span class="math inline">\delta &gt; 0</span> (blue) are less deflected, resulting in a longer focal length. In the case of on-momentum particle <span class="math inline">\delta = 0</span> (green), the trajectories are identical to the linear case.</figcaption>
</figure>
<p>The <em>chromaticity</em></p>
<div id="eq:chromaticity-definition">
<table style="width:99%;">
<colgroup>
<col style="width: 90%" />
<col style="width: 9%" />
</colgroup>
<tbody>
<tr class="odd">
<td style="text-align: center;"><span class="math display">
\xi_\mathrm{u} = \frac{\mathrm{d} Q_\mathrm{u}}{\mathrm{d} \delta}
</span></td>
<td style="text-align: right;"><span class="math display">(2.50)</span></td>
</tr>
</tbody>
</table>
</div>
<p>describes the change in the betatron tune with respect to the relative momentum deviation <span class="math inline">\delta</span>. In linear approximation, the perturbed quadrupole strength caused by the momentum deviation</p>
<div id="eq:quadrupole-strength">
<table style="width:99%;">
<colgroup>
<col style="width: 90%" />
<col style="width: 9%" />
</colgroup>
<tbody>
<tr class="odd">
<td style="text-align: center;"><span class="math display">
k_\mathrm{p}(s, p) = \frac{q}{p}\frac{\mathrm{d}B_\mathrm{y}}{\mathrm{d}x} = \frac{q}{p_0(1 + \delta)}\frac{\mathrm{d}B_\mathrm{y}}{\mathrm{d}x} \approx (1 - \delta)\frac{q}{p_0}\frac{\mathrm{d}B_\mathrm{y}}{\mathrm{d}x} = k + \Delta k
</span></td>
<td style="text-align: right;"><span class="math display">(2.51)</span></td>
</tr>
</tbody>
</table>
</div>
<p>has the same effect as a gradient error</p>
<div id="eq:quadrupole-error">
<table style="width:99%;">
<colgroup>
<col style="width: 90%" />
<col style="width: 9%" />
</colgroup>
<tbody>
<tr class="odd">
<td style="text-align: center;"><span class="math display">
\Delta k = -k\delta .
</span></td>
<td style="text-align: right;"><span class="math display">(2.52)</span></td>
</tr>
</tbody>
</table>
</div>
<p>Therefore, to derive the effect of this gradient error, we introduce a perturbation in form of a thin quadrupole</p>
<div id="eq:quadrupole-pertubation">
<table style="width:99%;">
<colgroup>
<col style="width: 90%" />
<col style="width: 9%" />
</colgroup>
<tbody>
<tr class="odd">
<td style="text-align: center;"><span class="math display"> \mathbf{Q}_\mathrm{p} =
\begin{pmatrix}
1 &amp; 0 \\
-\Delta k \mathrm{d}s &amp; 1
\end{pmatrix}
</span></td>
<td style="text-align: right;"><span class="math display">(2.53)</span></td>
</tr>
</tbody>
</table>
</div>
<p>with the infinite focal lenth <span class="math inline">\frac{1}{\Delta k \mathrm{d}s}</span>. Here we look at the 2×2-sub matrix, which only transforms the horizontal or vertical componentes of the particle vector <span class="math inline">\mathbf{X}</span>. According to <a href="#eq:transfer-matrix-beta">Equation 2.32</a> the 2×2-one-turn-matrix in the horizontal or vertical plane</p>
<div id="eq:one-turn-beta">
<table style="width:99%;">
<colgroup>
<col style="width: 90%" />
<col style="width: 9%" />
</colgroup>
<tbody>
<tr class="odd">
<td style="text-align: center;"><span class="math display"> \mathbf{R} =
\begin{pmatrix}
\cos{\Psi} + \alpha_0 \sin{\Psi} &amp; \beta_0 \sin{\Psi} \\
-\frac{1 + \alpha_0^2}{\beta_0} \sin{\Psi} &amp; \cos{\Psi} - \alpha_0 \sin{\Psi}
\end{pmatrix}
</span></td>
<td style="text-align: right;"><span class="math display">(2.54)</span></td>
</tr>
</tbody>
</table>
</div>
<p>can be written as an expression of the Twiss parameters, where <span class="math inline">\Psi = 2 \pi Q</span>. Hence, we can express the perturbed one-turn-matrix in terms of the unperturbed Twiss parameters:</p>
<div id="eq:one-turn-pertubation">
<table style="width:99%;">
<colgroup>
<col style="width: 90%" />
<col style="width: 9%" />
</colgroup>
<tbody>
<tr class="odd">
<td style="text-align: center;"><span class="math display">
\begin{aligned}
\mathbf{R}_\mathrm{p} &amp;= \mathbf{R} \mathbf{Q}_\mathrm{p} \\
&amp;=
\begin{pmatrix}
\cos \Psi + \alpha_0 \sin{\Psi} &amp; \beta_0 \sin \Psi \\
- \frac{1}{\beta_0} \sin \Psi &amp; \cos \Psi - \alpha_0 \sin{\Psi}
\end{pmatrix}
\begin{pmatrix}
1 &amp; 0 \\
- \Delta k \mathrm{d}s &amp; 1
\end{pmatrix} \\
&amp;= \begin{pmatrix}
\cos \Psi + \alpha_0 \sin{\Psi}  - \beta_0 \Delta k \mathrm{d}s \sin \Psi &amp; \cdots \\
\cdots &amp; \cos \Psi - \alpha_0 \sin{\Psi} 
\end{pmatrix} \\
\end{aligned}
</span></td>
<td style="text-align: right;"><span class="math display">(2.55)</span></td>
</tr>
</tbody>
</table>
</div>
<p>By calculating the trace of the perturbed one-turn-matrix</p>
<div id="eq:trace-one-turn-pertubation">
<table style="width:99%;">
<colgroup>
<col style="width: 90%" />
<col style="width: 9%" />
</colgroup>
<tbody>
<tr class="odd">
<td style="text-align: center;"><span class="math display">
\begin{aligned}
\mathrm{Tr}(\mathbf{R}_\mathrm{p}) &amp;\overset{!}{=} \mathrm{Tr}(\mathbf{R}\mathbf{Q}_\mathrm{p}) \\
2 \cos \Psi_\mathrm{p} &amp;= 2 \cos \Psi - \beta_0 \Delta k \mathrm{d}s \sin \Psi
\end{aligned}
</span></td>
<td style="text-align: right;"><span class="math display">(2.56)</span></td>
</tr>
</tbody>
</table>
</div>
<p>we obtain</p>
<div id="eq:trace-one-turn-pertubation-approx">
<table style="width:99%;">
<colgroup>
<col style="width: 90%" />
<col style="width: 9%" />
</colgroup>
<tbody>
<tr class="odd">
<td style="text-align: center;"><span class="math display">
\cos{\Psi} \cos{\mathrm{d}\Delta\Psi} - \sin{\Psi} \sin{\mathrm{d}\Delta\Psi} = \cos \Psi - \frac{1}{2}\beta_0 \Delta k \mathrm{d}s \sin \Psi,
</span></td>
<td style="text-align: right;"><span class="math display">(2.57)</span></td>
</tr>
</tbody>
</table>
</div>
<p>where <span class="math inline">\Psi_\mathrm{p} = \Psi + \mathrm{d}\Delta\Psi</span>. For small tune pertubations <span class="math inline">\Delta Q</span>, we can use the small-angle approximiation of the trigonometric functions <span class="math inline">\cos{\mathrm{d}\Delta\Psi} \approx 1</span> and <span class="math inline">\sin{\mathrm{d}\Delta\Psi} \approx \mathrm{d}\Delta\Psi</span>, resulting in an expression for the differential of the tune pertubation</p>
<div id="eq:tune-differential">
<table style="width:99%;">
<colgroup>
<col style="width: 90%" />
<col style="width: 9%" />
</colgroup>
<tbody>
<tr class="odd">
<td style="text-align: center;"><span class="math display">
\begin{aligned}
\mathrm{d} \Delta Q &amp;= \frac{1}{4 \pi} \beta_0 \Delta k \mathrm{d}s \\
&amp;= -\frac{1}{4 \pi} \delta \beta_0 k \mathrm{d}s .
\end{aligned}
</span></td>
<td style="text-align: right;"><span class="math display">(2.58)</span></td>
</tr>
</tbody>
</table>
</div>
<p>By integrating <a href="#eq:tune-differential">Equation 2.58</a> and substituting it into <a href="#eq:chromaticity-definition">Equation 2.50</a>, we obtain an expression for the <em>natural chromaticities</em></p>
<div id="eq:natural-chromaticities">
<table style="width:99%;">
<colgroup>
<col style="width: 90%" />
<col style="width: 9%" />
</colgroup>
<tbody>
<tr class="odd">
<td style="text-align: center;"><span class="math display">
\begin{aligned}
\xi_\mathrm{x}^\mathrm{n} &amp;= - \frac{1}{4 \pi} \int_0^C \beta_\mathrm{x}(s) k(s) \mathrm{d} s \\
\xi_\mathrm{y}^\mathrm{n} &amp;= + \frac{1}{4 \pi} \int_0^C \beta_\mathrm{y}(s) k(s) \mathrm{d} s ,
\end{aligned}
</span></td>
<td style="text-align: right;"><span class="math display">(2.59)</span></td>
</tr>
</tbody>
</table>
</div>
<p>which only takes the contribution of the momentum-dependent quadrupole strength into account. Since particles with a positive momentum deviation (<span class="math inline">\delta &gt; 0</span>) experience a weaker focusing, the natural chromaticities <span class="math inline">\xi_u^\mathrm{n}</span> are always negative.</p>
</section>
<section id="chromaticity-correction" class="level3" data-number="2.4.2">
<h3 data-number="2.4.2"><span class="header-section-number">2.4.2</span> Chromaticity Correction</h3>
<p>Two effects cause chromaticities to be undesirable in circular accelerators, making it necessary to correct for these chromatic errors. First, resonances between the betatron oscillation and the magnetic fields arising at specific values of the betatron tune can lead to a beam loss. Thus, for high chromaticities, where even particles with small momentum deviations experience a large tune shift, moving particles into resonance becomes more likely. Moreover, particles have vastly different tunes for high chromaticities, corresponding to a tune spread in the tune diagram. Hence, the accelerator has to be operated at a distance to the nearest resonances larger than the tune spread, imposing strict constraints on possible tunes and making it challenging to choose an operational tune.</p>
<p>Secondly, so-called <em>head-tail instabilities</em>, a collective effect between the electrons of the head and tail of a bunch, grow proportional with the chromaticity.</p>
<figure>
<img src="figures/chromaticity-sextupole.svg" id="fig:chromaticity-sextupole" alt="Figure 2.5: Influence of sextupole placed at a position of non-zero dispersion. Similar to Figure 2.4, the trajectories were calculated by integrating Equation 2.16. The dashed lines correspond to the particle trajectories without momentum deviation \delta = 0. The non-linearity of the sextupole corrects the chromatic error of the quadrupole, resulting in a focal point of the dispersive particle." /><figcaption aria-hidden="true">Figure 2.5: Influence of sextupole placed at a position of non-zero dispersion. Similar to <a href="#fig:chromaticity-quadrupole">Figure 2.4</a>, the trajectories were calculated by integrating <a href="#eq:eom-integratable">Equation 2.16</a>. The dashed lines correspond to the particle trajectories without momentum deviation <span class="math inline">\delta = 0</span>. The non-linearity of the sextupole corrects the chromatic error of the quadrupole, resulting in a focal point of the dispersive particle.</figcaption>
</figure>
<p>Non-linear elements can compensate for the chromaticities introduced by the momentum-dependent quadrupole strength. The goal is to give particles with a positive momentum deviation <span class="math inline">\delta &gt; 0</span> an additional kick and counterbalance the stronger kick, which particles with a negative momentum deviation <span class="math inline">\delta &lt; 0</span> experience. <a href="#fig:chromaticity-sextupole">Figure 2.5</a> shows a sextupole compensating for the chromaticity introduced by a quadrupole. A sextupole magnet behaves in one plane like an amplitude-dependent quadrupole magnet. Therefore, a sextupole has the desired effect at a position of dispersion <span class="math inline">\eta \neq 0</span>, where the particles are sorted by their momentum deviation <span class="math inline">\delta</span>.</p>
<p>Using the additional sextupole kick experienced by a dispersive particle <span class="math inline">\Delta k = m \eta \delta</span>, we can, analog to <a href="#sec:natural-chromaticity">Section 2.4.1</a>, derive an expression for the part of the chromaticity introduced by the sextupole magnets</p>
<div id="eq:natural-chromaticities-sextupoles">
<table style="width:99%;">
<colgroup>
<col style="width: 90%" />
<col style="width: 9%" />
</colgroup>
<tbody>
<tr class="odd">
<td style="text-align: center;"><span class="math display">
\begin{aligned}
\xi_\mathrm{x}^\mathrm{s} &amp;= + \frac{1}{4 \pi} \int_0^C \beta_\mathrm{x}(s) m(s) \eta_\mathrm{x}(s) \mathrm{d} s \\
\xi_\mathrm{y}^\mathrm{s} &amp;= - \frac{1}{4 \pi} \int_0^C \beta_\mathrm{y}(s) m(s) \eta_\mathrm{x}(s) \mathrm{d} s .
\end{aligned}
</span></td>
<td style="text-align: right;"><span class="math display">(2.60)</span></td>
</tr>
</tbody>
</table>
</div>
<p>We obtain the total chromaticity from the sum of the natural chromaticity <span class="math inline">\xi^\mathrm{n}</span> and the chromaticity caused by the sextupole magnets <span class="math inline">\xi^\mathrm{s}</span></p>
<div id="eq:natural-chromaticities-total">
<table style="width:99%;">
<colgroup>
<col style="width: 90%" />
<col style="width: 9%" />
</colgroup>
<tbody>
<tr class="odd">
<td style="text-align: center;"><span class="math display">
\begin{aligned}
\xi_\mathrm{x} &amp;= - \frac{1}{4 \pi} \int_0^C \beta_\mathrm{x}(s) (k(s) - m(s) \eta_\mathrm{x}(s)) \mathrm{d} s \\
\xi_\mathrm{y} &amp;= + \frac{1}{4 \pi} \int_0^C \beta_\mathrm{y}(s) (k(s) - m(s) \eta_\mathrm{x}(s)) \mathrm{d} s .
\end{aligned}
</span></td>
<td style="text-align: right;"><span class="math display">(2.61)</span></td>
</tr>
</tbody>
</table>
</div>
</section>
</section>
<section id="sec:synchrotron-radiation" class="level2" data-number="2.5">
<h2 data-number="2.5"><span class="header-section-number">2.5</span> Synchrotron Radiation</h2>
<p>A resting electron produces a static electric field but does not emit radiation, which would violate the law of conservation of energy since a stationary electron has no kinetic energy to use. The same must hold for a uniformly moving electron as it is stationary in another inertial frame of reference. However, if a charged particle is accelerated, it produces an electromagnetic wave. According to Maxwell’s equations, the change in the electric field results in a magnetic field. In turn, the variations of the magnetic field produce an electric field. These periodical oscillations in the electromagnetic field, which propagate energy at the speed of light <span class="math inline">c</span>, are known as <em>electromagnetic radiation</em>.</p>
<p>In the case of a charged particle in a circular accelerator where it is accelerated radially in a bending magnet, undulator, or wiggler at relativistic speed, this radiation is called <em>synchrotron radiation</em>. The previous sections discussed the beam dynamics while neglecting the emission of synchrotron radiation. However, the random emission of photons of a radially accelerated electron influences the amplitude of its betatron and synchrotron oscillations, which changes the beam emittance.</p>
<p>At first, this might seem like a violation of Liouville’s theorem <span class="citation" data-cites="Nolting2018"><a href="#ref-Nolting2018" role="doc-biblioref">[21]</a></span>: It describes the time evolution of an ensemble of classical systems and states that the phase-space distribution of these systems is constant along any path. However, it is also applicable to a single system of <span class="math inline">N</span> non-interacting electrons as such a system can be seen equivalent to an ensemble of <span class="math inline">N</span> systems. Thus, for non-interacting electrons, the emittance, which corresponds to the occupied volume in phase space, must be conserved. However, as soon as an electron emits a photon, the electron beam emittance only occupies a sub-volume of the total electron-photon phase space, spanned by the coordinates of the electron and photon. Thus due to the synchrotron radiation and consistent with Liouville’s theorem, the beam emittance can change. Nevertheless, Liouville’s theorem still holds for the entire electron-photon system. Therefore, contrary to a proton beam, where the synchrotron radiation is neglectable, the electron beam emittance is not a constant of motion.</p>
<p>In the following, we will derive the influence of synchrotron radiation on the electron beam emittance, where the report of Sands <span class="citation" data-cites="sands1970"><a href="#ref-sands1970" role="doc-biblioref">[22]</a></span> was the primary source for this section. It is convenient to define the five so-called <em>synchrotron radiation integrals</em> <span class="citation" data-cites="helm1973"><a href="#ref-helm1973" role="doc-biblioref">[23]</a></span>, to facilitate the mathematical work:</p>
<div id="eq:i1">
<table style="width:99%;">
<colgroup>
<col style="width: 90%" />
<col style="width: 9%" />
</colgroup>
<tbody>
<tr class="odd">
<td style="text-align: center;"><span class="math display"> I_1 = \int_0^{C} \kappa_\mathrm{x0}(s)\eta_\mathrm{x}(s) \mathrm{d}s
</span></td>
<td style="text-align: right;"><span class="math display">(2.62)</span></td>
</tr>
</tbody>
</table>
</div>
<div id="eq:i2">
<table style="width:99%;">
<colgroup>
<col style="width: 90%" />
<col style="width: 9%" />
</colgroup>
<tbody>
<tr class="odd">
<td style="text-align: center;"><span class="math display"> I_2 = \int_0^{C} \kappa_\mathrm{x0}(s)^2 \mathrm{d}s
</span></td>
<td style="text-align: right;"><span class="math display">(2.63)</span></td>
</tr>
</tbody>
</table>
</div>
<div id="eq:i3">
<table style="width:99%;">
<colgroup>
<col style="width: 90%" />
<col style="width: 9%" />
</colgroup>
<tbody>
<tr class="odd">
<td style="text-align: center;"><span class="math display"> I_3 = \int_0^{C} |\kappa_\mathrm{x0}(s)|^3  \mathrm{d}s
</span></td>
<td style="text-align: right;"><span class="math display">(2.64)</span></td>
</tr>
</tbody>
</table>
</div>
<div id="eq:i4">
<table style="width:99%;">
<colgroup>
<col style="width: 90%" />
<col style="width: 9%" />
</colgroup>
<tbody>
<tr class="odd">
<td style="text-align: center;"><span class="math display"> I_4 = \int_0^{C} \kappa_\mathrm{x0}(s) \eta_\mathrm{x}(s) \left(\kappa_\mathrm{x0}(s)^2 + 2 k(s) \right)\mathrm{d}s
</span></td>
<td style="text-align: right;"><span class="math display">(2.65)</span></td>
</tr>
</tbody>
</table>
</div>
<div id="eq:i5">
<table style="width:99%;">
<colgroup>
<col style="width: 90%" />
<col style="width: 9%" />
</colgroup>
<tbody>
<tr class="odd">
<td style="text-align: center;"><span class="math display"> I_5 = \int_0^{C} |\kappa_\mathrm{x0}(s)|^3 \mathcal{H}_\mathrm{x} (s) \mathrm{d}s
</span></td>
<td style="text-align: right;"><span class="math display">(2.66)</span></td>
</tr>
</tbody>
</table>
</div>
<p>With</p>
<div id="eq:curly-h">
<table style="width:99%;">
<colgroup>
<col style="width: 90%" />
<col style="width: 9%" />
</colgroup>
<tbody>
<tr class="odd">
<td style="text-align: center;"><span class="math display"> \mathcal{H}_\mathrm{x} = \gamma_\mathrm{x} \eta_\mathrm{x}^2 + 2 \alpha_\mathrm{x} \eta_\mathrm{x} \eta_\mathrm{x}&#39; + \beta_\mathrm{x} \eta_\mathrm{x}&#39;^2.
</span></td>
<td style="text-align: right;"><span class="math display">(2.67)</span></td>
</tr>
</tbody>
</table>
</div>
<p>we introduced the so-called <em>curly <span class="math inline">\mathcal{H}</span> function</em>, fully defined by the Twiss parameters. Note that for an accurate calculation of the fourth synchrotron radiation integral in <a href="#eq:i4">Equation 2.65</a> we also have to consider the dipole edge focusing. In the developed code, this was adopted from the MAD-X source <span class="citation" data-cites="madx"><a href="#ref-madx" role="doc-biblioref">[8]</a></span>.</p>
<section id="radiation-damping-of-betatron-oscillations" class="level3" data-number="2.5.1">
<h3 data-number="2.5.1"><span class="header-section-number">2.5.1</span> Radiation Damping of Betatron Oscillations</h3>
<figure>
<img src="figures/betatron-oscillation-damping.svg" id="fig:betatron-oscillation-damping" alt="Figure 2.6: Radiation damping of the betatron oscillation. The emission of a photon changes the transverse and longitudinal components of an electron’s momentum. But as the cavity only refills the longitudinal component, the transverse momentum components decrease over time." /><figcaption aria-hidden="true">Figure 2.6: Radiation damping of the betatron oscillation. The emission of a photon changes the transverse and longitudinal components of an electron’s momentum. But as the cavity only refills the longitudinal component, the transverse momentum components decrease over time.</figcaption>
</figure>
<p>As shown in <a href="#fig:betatron-oscillation-damping">Figure 2.6</a>, a radially accelerated electron emits synchrotron radiation in its general direction of motion, leading to a decrease of the longitudinal and transversal components of its momentum. However, the electric field of the cavity only restores the electron’s longitudinal momentum. Over time, the interplay of both of these effects leads to a damping of the electron’s betatron oscillation. While this effect is commonly called the <em>radiation damping</em>, the damping of the betatron oscillations occurs in the cavity. The emission of synchrotron radiation does not - apart from slightly changing the focusing strength of the magnets due to the energy loss - directly affect the amplitude of the betatron oscillations. However, the damping is still a second-order effect of the synchrotron radiation, as, without it, the cavity would not restore the longitudinal momentum.</p>
<p>To quantify the influence of the synchrotron radiation on the amplitude of the betatron oscillations, we make some assumptions:</p>
<ul>
<li>First, we assume the emission of synchrotron radiation is precisely parallel to the momentum of the electron.</li>
<li>Second, we assume a continuous emission of synchrotron radiation over a given path length.</li>
<li>Finally, we assume the acceleration happens continuously along the ring.</li>
</ul>
<p>Under these assumptions, the betatron oscillations would dampen to zero. However, due to the quantum nature of photons, the emission happens in discrete chunks of energy, making the second assumption not entirely reasonable. The discrete emissions lead to a counteracting excitation which will be considered in <a href="#sec:quantum-excitation">Section 2.5.2</a>.</p>
<p>We recall the definition of the emittance</p>
<div id="eq:phase-space-ellipse-radiation-damping">
<table style="width:99%;">
<colgroup>
<col style="width: 90%" />
<col style="width: 9%" />
</colgroup>
<tbody>
<tr class="odd">
<td style="text-align: center;"><span class="math display"> \epsilon_u = \gamma_u u^2 + 2 \alpha_u uu&#39; + \beta_u u&#39;^2 ,
</span></td>
<td style="text-align: right;"><span class="math display">(2.68)</span></td>
</tr>
</tbody>
</table>
</div>
<p>from <a href="#eq:phase-space-ellipse">Equation 2.29</a>. Note that the coordinates <span class="math inline">u</span> and <span class="math inline">u&#39;</span> correspond to the betatron coordinates, which do not include the offset and slope caused by the momentum dispersion. By using the above definition of the emittance, we obtain an expression for the variation of the emittance with respect to the transverse coordinates <span class="math inline">u</span> and <span class="math inline">u&#39;</span></p>
<div id="eq:variation-emittance">
<table style="width:99%;">
<colgroup>
<col style="width: 90%" />
<col style="width: 9%" />
</colgroup>
<tbody>
<tr class="odd">
<td style="text-align: center;"><span class="math display"> \delta \epsilon_u = (2 \gamma_u u + 2 \alpha_u u&#39;) \delta u + (2 \alpha_u u + 2 \beta_u u&#39;) \delta u&#39; .
</span></td>
<td style="text-align: right;"><span class="math display">(2.69)</span></td>
</tr>
</tbody>
</table>
</div>
<p>Neither the emission of a photon nor the acceleration immediately changes the transverse displacement of an electron <span class="math inline">u</span>, leading to <span class="math inline">\delta u = 0</span>. The sum of the synchrotron radiation and the cavity forces results in a variation of transverse momentum</p>
<div id="eq:resulting-transverse-momentum-change">
<table style="width:99%;">
<colgroup>
<col style="width: 90%" />
<col style="width: 9%" />
</colgroup>
<tbody>
<tr class="odd">
<td style="text-align: center;"><span class="math display">\delta\mathbf{p_\perp} = \delta \mathbf{p_\mathrm{ph}} + \delta \mathbf{p_\mathrm{rf}} .
</span></td>
<td style="text-align: right;"><span class="math display">(2.70)</span></td>
</tr>
</tbody>
</table>
</div>
<p>Therefore the variation of transverse slope <span class="math inline">u&#39;</span> is</p>
<div id="eq:variation-vertical-slope">
<table style="width:99%;">
<colgroup>
<col style="width: 90%" />
<col style="width: 9%" />
</colgroup>
<tbody>
<tr class="odd">
<td style="text-align: center;"><span class="math display"> u&#39; + \delta u&#39; = \frac{p_\perp + \delta p_\perp}{p_\parallel} = u&#39; + \frac{\delta p_\perp}{p_\parallel} .
</span></td>
<td style="text-align: right;"><span class="math display">(2.71)</span></td>
</tr>
</tbody>
</table>
</div>
<p>Furthermore, we have to take into account the influence of the momentum deviation. Therefore, we will first solve the dispersion-free vertical case <span class="math inline">\eta_\mathrm{y} = 0</span> and then add an additional term for the horizontal case <span class="math inline">\eta_\mathrm{x}, where \neq 0</span>.</p>
<p>With <span class="math inline">\delta p_\perp = -y&#39; \delta p_\mathrm{rf}</span> and <span class="math inline">p_\parallel \approx p</span>, we can conclude for the variation of the vertical coordinates</p>
<div id="eq:variation-vertical-coordinates">
<table style="width:99%;">
<colgroup>
<col style="width: 90%" />
<col style="width: 9%" />
</colgroup>
<tbody>
<tr class="odd">
<td style="text-align: center;"><span class="math display"> \delta y = 0, \quad \delta y&#39; = -y&#39; \frac{\delta p_\mathrm{rf}}{p} = -y&#39; \frac{\delta E_\mathrm{rf}}{E_0}
</span></td>
<td style="text-align: right;"><span class="math display">(2.72)</span></td>
</tr>
</tbody>
</table>
</div>
<p>and obtain an expression of the variation of the vertical emittance</p>
<div id="eq:variation-emittance-vertical-1">
<table style="width:99%;">
<colgroup>
<col style="width: 90%" />
<col style="width: 9%" />
</colgroup>
<tbody>
<tr class="odd">
<td style="text-align: center;"><span class="math display"> \delta \epsilon_\mathrm{y} = -(2 \alpha_\mathrm{y} y y&#39; + 2 \beta_\mathrm{y} y&#39;^2) \frac{\delta E_\mathrm{rf}}{E_0},
</span></td>
<td style="text-align: right;"><span class="math display">(2.73)</span></td>
</tr>
</tbody>
</table>
</div>
<p>where <span class="math inline">\delta E_\mathrm{rf}</span> corresponds to the energy refilled by the cavity, not the energy decrease due to the damping <span class="math inline">\delta E = c \sqrt{p_\parallel^2 + (p_\perp + \delta p_\perp)^2} - c \sqrt{p_\parallel^2 + p_\perp^2} \approx c \frac{p_\perp \delta p_\perp}{p} \approx c y&#39; \delta p_\perp</span>. Under the assumption of a uniform distribution of betatron phases <span class="math inline">\psi</span>, we must average over <a href="#eq:variation-emittance-vertical-1">Equation 2.73</a>. Therefore we solve the integrals</p>
<div id="eq:average-y-y-prime">
<table style="width:99%;">
<colgroup>
<col style="width: 90%" />
<col style="width: 9%" />
</colgroup>
<tbody>
<tr class="odd">
<td style="text-align: center;"><span class="math display">
\begin{aligned}
\langle y y&#39; \rangle &amp;= \frac{1}{2 \pi} \int_0^{2 \pi} y y&#39; \mathrm{d} \psi \\
&amp;= - \frac{1}{2 \pi} \int_0^{2 \pi} \epsilon_\mathrm{y} (\alpha_\mathrm{y} (\cos{\psi})^2 + \sin{\psi} \cos{\psi}) \mathrm{d} \psi \\
&amp;= -\frac{\epsilon_\mathrm{y} \alpha_\mathrm{y}}{2}
\end{aligned}
</span></td>
<td style="text-align: right;"><span class="math display">(2.74)</span></td>
</tr>
</tbody>
</table>
</div>
<p>and</p>
<div id="eq:average-y-prime-squared">
<table style="width:99%;">
<colgroup>
<col style="width: 90%" />
<col style="width: 9%" />
</colgroup>
<tbody>
<tr class="odd">
<td style="text-align: center;"><span class="math display">
\begin{aligned}
\langle y&#39;^2 \rangle &amp;= \frac{1}{2 \pi} \int_0^{2 \pi} y&#39;^2 \mathrm{d} \psi \\
&amp;= \frac{1}{2 \pi} \int_0^{2 \pi} \frac{\epsilon_\mathrm{y}}{\beta_\mathrm{y}} (\alpha_\mathrm{y}^2 (\cos{\psi})^2 + \alpha_\mathrm{y} \sin{\psi} \cos{\psi} +(\sin{\psi})^2) \mathrm{d} \psi \\
&amp;= \frac{\epsilon_\mathrm{y}}{2 \beta_\mathrm{y}} (\alpha_\mathrm{y}^2 + 1) \\
&amp;= \frac{\epsilon_\mathrm{y} \gamma_\mathrm{y}}{2}
\end{aligned}
</span></td>
<td style="text-align: right;"><span class="math display">(2.75)</span></td>
</tr>
</tbody>
</table>
</div>
<p>and substitute them into <a href="#eq:variation-emittance-vertical-1">Equation 2.73</a>:</p>
<div id="eq:variation-emittance-vertical-2">
<table style="width:99%;">
<colgroup>
<col style="width: 90%" />
<col style="width: 9%" />
</colgroup>
<tbody>
<tr class="odd">
<td style="text-align: center;"><span class="math display"> \delta \epsilon_\mathrm{y} = \epsilon_\mathrm{y} (\alpha_\mathrm{y}^2 - \beta_\mathrm{y} \gamma_\mathrm{y}) \frac{\delta E_\mathrm{rf}}{E_0} = - \epsilon_\mathrm{y} \frac{\delta E_\mathrm{rf}}{E_0} 
</span></td>
<td style="text-align: right;"><span class="math display">(2.76)</span></td>
</tr>
</tbody>
</table>
</div>
<p>Over the time of one revolution <span class="math inline">T_0</span>, the energy chunks <span class="math inline">\delta E_\mathrm{rf}</span> add up to the total radiation loss <span class="math inline">U_0</span>. Therefore, following our third assumption, we write an expression for the time derivative of the vertical emittance</p>
<div id="eq:emittance-vertical-derivative">
<table style="width:99%;">
<colgroup>
<col style="width: 90%" />
<col style="width: 9%" />
</colgroup>
<tbody>
<tr class="odd">
<td style="text-align: center;"><span class="math display"> \frac{\mathrm{d} \epsilon_\mathrm{y}}{\mathrm{d} t} = \frac{\mathrm{d} \delta \epsilon_\mathrm{y}}{\mathrm{d} t} = -\epsilon_\mathrm{y} \frac{1}{E_0} \frac{\mathrm{d} \delta E_\mathrm{rf}}{\mathrm{d} t} = -\epsilon_\mathrm{y} \frac{U_0}{E_0T_0} .
</span></td>
<td style="text-align: right;"><span class="math display">(2.77)</span></td>
</tr>
</tbody>
</table>
</div>
<p>For the variation of the horizontal emittance</p>
<div id="eq:variation-emittance-horizontal-1">
<table style="width:99%;">
<colgroup>
<col style="width: 90%" />
<col style="width: 9%" />
</colgroup>
<tbody>
<tr class="odd">
<td style="text-align: center;"><span class="math display"> \delta \epsilon_\mathrm{x} = - \epsilon_\mathrm{x} \frac{U_0}{E_0 T_0} + \delta \epsilon_\mathrm{x}^{\delta}
</span></td>
<td style="text-align: right;"><span class="math display">(2.78)</span></td>
</tr>
</tbody>
</table>
</div>
<p>we have to consider an additional term <span class="math inline">\delta \epsilon_\mathrm{x}^{\delta}</span> caused by the momentum dispersion. As discussed in <a href="#sec:dispersion">Section 2.3.4</a>, the total horizontal displacement <span class="math inline">x_\mathrm{tot}</span> is sum of betatron displacement <span class="math inline">x(s) = \sqrt{\epsilon \beta(s)} \cos(\psi(s) + \psi_0)</span> and dispersive displacement <span class="math inline">x_\delta(s) = \eta(s) \delta</span>:</p>
<div id="eq:total-horizontal-offset">
<table style="width:99%;">
<colgroup>
<col style="width: 90%" />
<col style="width: 9%" />
</colgroup>
<tbody>
<tr class="odd">
<td style="text-align: center;"><span class="math display"> x_\mathrm{tot}(s) = x(s) + \eta(s) \delta \quad \mathrm{and} \quad x&#39;_\mathrm{tot}(s) =  x&#39;(s) + \eta&#39;(s) \delta
</span></td>
<td style="text-align: right;"><span class="math display">(2.79)</span></td>
</tr>
</tbody>
</table>
</div>
<p>As the energy loss due to the emission of a photon cannot immediately change the total displacement <span class="math inline">x_\mathrm{tot}</span> or slope <span class="math inline">x&#39;_\mathrm{tot}</span> of an electron, the betatron coordinates <span class="math inline">x</span> and <span class="math inline">x&#39;</span> must compensate the change in the dispersive coordinates <span class="math inline">x_\delta</span> and <span class="math inline">x&#39;_\delta</span>. Therefore the variation of the betatron coordinates <span class="math inline">x</span> and <span class="math inline">x&#39;</span> is</p>
<div id="eq:variation-horizontal-coordinates">
<table style="width:99%;">
<colgroup>
<col style="width: 90%" />
<col style="width: 9%" />
</colgroup>
<tbody>
<tr class="odd">
<td style="text-align: center;"><span class="math display"> \delta x = -x_\delta(s) =  - \eta_\mathrm{x} \frac{\delta E_\mathrm{ph}}{E_0}, \quad \delta x&#39; = -x&#39;_\delta(s) = -\eta_\mathrm{x}&#39; \frac{\delta E_\mathrm{ph}}{E_0} ,
</span></td>
<td style="text-align: right;"><span class="math display">(2.80)</span></td>
</tr>
</tbody>
</table>
</div>
<p>where <span class="math inline">\delta E_\mathrm{ph}</span> is the variation of the electron energy caused by the synchrotron radiation. Substituting <a href="#eq:variation-horizontal-coordinates">Equation 2.80</a> into <a href="#eq:variation-emittance">Equation 2.69</a> yields the additional term of the variation of the horizontal emittance</p>
<div id="eq:variation-emittance-horizontal-2">
<table style="width:99%;">
<colgroup>
<col style="width: 90%" />
<col style="width: 9%" />
</colgroup>
<tbody>
<tr class="odd">
<td style="text-align: center;"><span class="math display"> \delta \epsilon_\mathrm{x}^\delta = -(2 \gamma_\mathrm{x} x + 2 \alpha_\mathrm{x} x&#39;) \eta_\mathrm{x} \frac{\delta E_\mathrm{ph}}{E_0} - (2 \alpha_\mathrm{x} x + 2 \beta_\mathrm{x} x&#39;) \eta_\mathrm{x}&#39; \frac{\delta E_\mathrm{ph}}{E_0} .
</span></td>
<td style="text-align: right;"><span class="math display">(2.81)</span></td>
</tr>
</tbody>
</table>
</div>
<p>From <span class="citation" data-cites="sands1970"><a href="#ref-sands1970" role="doc-biblioref">[22]</a></span>, we use the expression for the radiation power</p>
<div id="eq:radiation-power">
<table style="width:99%;">
<colgroup>
<col style="width: 90%" />
<col style="width: 9%" />
</colgroup>
<tbody>
<tr class="odd">
<td style="text-align: center;"><span class="math display"> P_\gamma(s) = C_\gamma \frac{e^2 c^3}{2 \pi} E^2 B^2 = C_\gamma \frac{c}{2 \pi} E^4 \kappa(s)^2 ,
</span></td>
<td style="text-align: right;"><span class="math display">(2.82)</span></td>
</tr>
</tbody>
</table>
</div>
<p>where <span class="math inline">E</span> and <span class="math inline">B</span> corresponds to the electric and magnetic fields, respectively, and we introduced a constant</p>
<div id="eq:constant-radiation-power">
<table style="width:99%;">
<colgroup>
<col style="width: 90%" />
<col style="width: 9%" />
</colgroup>
<tbody>
<tr class="odd">
<td style="text-align: center;"><span class="math display"> C_\gamma = \frac{e^2}{3 \epsilon_0 (m c^2)^4} .
</span></td>
<td style="text-align: right;"><span class="math display">(2.83)</span></td>
</tr>
</tbody>
</table>
</div>
<p>As <span class="math inline">P \propto E^2 B^2</span>, the radiation power is in linear approximation</p>
<div id="eq:linear-approximation-radiation-power-1">
<table style="width:99%;">
<colgroup>
<col style="width: 90%" />
<col style="width: 9%" />
</colgroup>
<tbody>
<tr class="odd">
<td style="text-align: center;"><span class="math display">
\begin{aligned}
P &amp;\approx P_0 + \frac{\mathrm{d} P}{\mathrm{d} E} \Bigr|_{\substack{E=E_0}} \Delta E + \frac{\mathrm{d} P}{\mathrm{d} B} \Bigr|_{\substack{B=B_0}} \Delta B \\
&amp;= P_0 (1 + 2 \frac{\Delta E}{E_0} + 2 \frac{\Delta B}{B_0}) .
\end{aligned}
</span></td>
<td style="text-align: right;"><span class="math display">(2.84)</span></td>
</tr>
</tbody>
</table>
</div>
<p>Subsituting <span class="math inline">\Delta B \approx \frac{\mathrm{d}B}{\mathrm{d} x} x</span>, <span class="math inline">\frac{\mathrm{d}B}{\mathrm{d} x} = \frac{k}{\kappa_\mathrm{x0}} B</span> and <span class="math inline">\Delta E = E_0 \delta</span> into <a href="#eq:linear-approximation-radiation-power-1">Equation 2.84</a>, yields</p>
<div id="eq:linear-approximation-radiation-power-2">
<table style="width:99%;">
<colgroup>
<col style="width: 90%" />
<col style="width: 9%" />
</colgroup>
<tbody>
<tr class="odd">
<td style="text-align: center;"><span class="math display"> P \approx P_0 (1 + 2 \delta + 2 \frac{k}{\kappa_\mathrm{x0}}x) .
</span></td>
<td style="text-align: right;"><span class="math display">(2.85)</span></td>
</tr>
</tbody>
</table>
</div>
<p>With <span class="math inline">t = z / c</span> and <a href="#eq:linear-approximation-radiation-power-2">Equation 2.85</a> we can write for the variation of the Energy</p>
<div id="eq:energy-loss-variation">
<table style="width:99%;">
<colgroup>
<col style="width: 90%" />
<col style="width: 9%" />
</colgroup>
<tbody>
<tr class="odd">
<td style="text-align: center;"><span class="math display"> \delta E_\mathrm{ph} = - \frac{P}{c} \delta z \approx -\frac{P}{c} (1 + \kappa_\mathrm{x_0} x)\delta s \approx - \frac{1}{c} P_0 (1 + 2 \delta + 2 \frac{k}{\kappa_\mathrm{x0}}x) (1 + \kappa_\mathrm{x_0} x) \delta s .
</span></td>
<td style="text-align: right;"><span class="math display">(2.86)</span></td>
</tr>
</tbody>
</table>
</div>
<p>Using <a href="#eq:energy-loss-variation">Equation 2.86</a>, we can average over all betatron phases <span class="math inline">\psi</span></p>
<div id="eq:average-horizontal-emittance-variation">
<table style="width:99%;">
<colgroup>
<col style="width: 90%" />
<col style="width: 9%" />
</colgroup>
<tbody>
<tr class="odd">
<td style="text-align: center;"><span class="math display">
\begin{aligned}
\langle \delta \epsilon_\mathrm{x}^\delta \rangle &amp;= - \frac{1}{2 \pi} \int_0^{2 \pi} ((2 \gamma_\mathrm{x} x + 2 \alpha_\mathrm{x} x&#39;) \eta_\mathrm{x}  + (2 \alpha_\mathrm{x} x + 2 \beta_\mathrm{x} x&#39;) \eta_\mathrm{x}&#39;) \frac{\delta E}{E_0} \mathrm{d} \psi \\
&amp;= \frac{P_0 \delta s}{\pi c E_0} \int_0^{2 \pi} ((\gamma_\mathrm{x} x + \alpha_\mathrm{x} x&#39;) \eta_\mathrm{x} + (\alpha_\mathrm{x} x + \beta_\mathrm{x} x&#39;) \eta_\mathrm{x}&#39;) (1 + 2 \delta + 2 \frac{k}{\kappa_\mathrm{x0}}x) (1 + \kappa_\mathrm{x_0} x) \mathrm{d} \psi .
\end{aligned}
</span></td>
<td style="text-align: right;"><span class="math display">(2.87)</span></td>
</tr>
</tbody>
</table>
</div>
<p>Only even terms in <span class="math inline">x</span> and <span class="math inline">x&#39;</span> will contribute a finite value, while odd terms in <span class="math inline">x</span> and <span class="math inline">x&#39;</span> vanish. Analogous to <a href="#eq:average-y-y-prime">Equation 2.74</a> we find that <span class="math inline">\langle x x&#39; \rangle = -\frac{\epsilon_\mathrm{x} \alpha_\mathrm{x}}{2}</span> and for average of <span class="math inline">x^2</span> we obtain</p>
<div id="eq:average-x-squared">
<table style="width:99%;">
<colgroup>
<col style="width: 90%" />
<col style="width: 9%" />
</colgroup>
<tbody>
<tr class="odd">
<td style="text-align: center;"><span class="math display">
\langle x^2 \rangle = \frac{1}{2 \pi} \int_0^{2 \pi} x^2 \mathrm{d} \psi
= \frac{1}{2 \pi} \int_0^{2 \pi} \epsilon_\mathrm{x} \beta_\mathrm{x} (\cos{\psi})^2 \mathrm{d} \psi
= \frac{\epsilon_\mathrm{x} \beta_\mathrm{x}}{2} ,
</span></td>
<td style="text-align: right;"><span class="math display">(2.88)</span></td>
</tr>
</tbody>
</table>
</div>
<p>which we substitute into <a href="#eq:energy-loss-variation">Equation 2.86</a>:</p>
<div id="eq:average-horizontal-emittance-variation-2">
<table style="width:99%;">
<colgroup>
<col style="width: 90%" />
<col style="width: 9%" />
</colgroup>
<tbody>
<tr class="odd">
<td style="text-align: center;"><span class="math display">
\begin{aligned}
\langle \delta \epsilon_\mathrm{x}^\delta \rangle 
&amp;= \frac{P_0 \delta s}{\pi c E_0} \int_0^{2 \pi} ((\gamma_\mathrm{x} x^2 + \alpha_\mathrm{x} x x&#39;) \eta_\mathrm{x} + (\alpha_\mathrm{x} x^2 + \beta_\mathrm{x} x x&#39;) \eta_\mathrm{x}&#39;) (\kappa_\mathrm{x0} + 2 \frac{k}{\kappa_\mathrm{x0}}) \mathrm{d} \psi \\
&amp;= \frac{P_0 \delta s}{c E_0} ((\gamma_\mathrm{x} \epsilon_\mathrm{x} \beta_\mathrm{x} - \alpha_\mathrm{x} \epsilon_\mathrm{x} \alpha_\mathrm{x}) \eta_\mathrm{x} + (\alpha_\mathrm{x} \epsilon_\mathrm{x} \beta_\mathrm{x} - \beta_\mathrm{x} \epsilon_\mathrm{x} \alpha_\mathrm{x}) \eta_\mathrm{x}&#39;) (\kappa_\mathrm{x0} + 2 \frac{k}{\kappa_\mathrm{x0}}) \\
&amp;= \frac{P_0 \delta s}{c E_0} \epsilon_\mathrm{x} (\gamma_\mathrm{x} \beta_\mathrm{x} - \alpha_\mathrm{x}^2) \eta_\mathrm{x} (\kappa_\mathrm{x0} + 2 \frac{k}{\kappa_\mathrm{x0}})\\
&amp;= \frac{P_0 \delta s}{c E_0} \epsilon_\mathrm{x} \eta_\mathrm{x} (\kappa_\mathrm{x0} + 2 \frac{k}{\kappa_\mathrm{x0}})\\
\end{aligned}
</span></td>
<td style="text-align: right;"><span class="math display">(2.89)</span></td>
</tr>
</tbody>
</table>
</div>
<p>Using the relationships <span class="math inline">\mathrm{d} t = \mathrm{d} z / c</span>, we define nominal radiation loss per turn</p>
<div id="eq:energy-loss-radiation">
<table style="width:99%;">
<colgroup>
<col style="width: 90%" />
<col style="width: 9%" />
</colgroup>
<tbody>
<tr class="odd">
<td style="text-align: center;"><span class="math display"> U_0 = \int_0^{T_0} P_0 \mathrm{d} t = \frac{1}{c} \int_0^{C_0} P_0 \mathrm{d} s = \frac{C_\gamma E_0^4}{2 \pi} \int_0^{C_0} \kappa_\mathrm{x0}(s)^2 \mathrm{d} s ,
</span></td>
<td style="text-align: right;"><span class="math display">(2.90)</span></td>
</tr>
</tbody>
</table>
</div>
<p>where we made use of the fact that for the nominal particle <span class="math inline">s = z</span>. By comparing <a href="#eq:radiation-power">Equation 2.82</a> and <a href="#eq:energy-loss-radiation">Equation 2.90</a>, we obtain an expression for the nominal radiation power</p>
<div id="eq:nominal-radiation-power">
<table style="width:99%;">
<colgroup>
<col style="width: 90%" />
<col style="width: 9%" />
</colgroup>
<tbody>
<tr class="odd">
<td style="text-align: center;"><span class="math display"> P_0(s) = \mathrm{const} \cdot \kappa_\mathrm{x0}(s)^2 = \frac{U_0 c}{\mathrm{\int_0^C \kappa_\mathrm{x0}(s)^2 \mathrm{d} s}} \kappa_\mathrm{x0}(s)^2
</span></td>
<td style="text-align: right;"><span class="math display">(2.91)</span></td>
</tr>
</tbody>
</table>
</div>
<p>in terms of the curvature of the ideal orbit <span class="math inline">\kappa_\mathrm{x0}</span> and the nominal energy loss per turn <span class="math inline">U_0</span>. Substituting <a href="#eq:nominal-radiation-power">Equation 2.91</a> into <a href="#eq:average-horizontal-emittance-variation-2">Equation 2.89</a> and integrating over one turn yields the change of the horizontal emittance caused by radiation damping</p>
<div id="eq:emittance-horizontal-derivative">
<table style="width:99%;">
<colgroup>
<col style="width: 90%" />
<col style="width: 9%" />
</colgroup>
<tbody>
<tr class="odd">
<td style="text-align: center;"><span class="math display">
\begin{aligned}
\frac{\mathrm{d} \epsilon_\mathrm{x}}{\mathrm{d} t} 
&amp;= -\epsilon_\mathrm{x} \frac{U_0}{E_0 T_0} \left(1 - \frac{\int_0^{C} \kappa_\mathrm{x0} \eta_\mathrm{x} \left(\kappa_\mathrm{x0}^2 + 2 k \right)\mathrm{d}s}{\int_0^{C} \kappa_\mathrm{x0}^2 \mathrm{d}s}\right) \\
&amp;= -\epsilon_\mathrm{x} \frac{U_0}{E_0 T_0} \left(1 - \frac{I_4}{I_2}\right) ,
\end{aligned}
</span></td>
<td style="text-align: right;"><span class="math display">(2.92)</span></td>
</tr>
</tbody>
</table>
</div>
<p>where we inserted the second and fourth synchrotron radiation integrals defined in <a href="#eq:i2">Equation 2.63</a> and <a href="#eq:i4">Equation 2.65</a>.</p>
</section>
<section id="sec:quantum-excitation" class="level3" data-number="2.5.2">
<h3 data-number="2.5.2"><span class="header-section-number">2.5.2</span> Quantum Excitation</h3>
<figure>
<img src="figures/betatron-oscillation-excitation.svg" id="fig:betatron-oscillation-excitation" alt="Figure 2.7: Quantum excitation of the betatron oscillation. When an electron with the reference momentum p = p_0 emits a photon within a bending magnet, it loses energy and will no longer be on the on-energy closed orbit. It will now perform betatron oscillations around a dispersive closed orbit p &lt; p_0. (based on [16])" /><figcaption aria-hidden="true">Figure 2.7: Quantum excitation of the betatron oscillation. When an electron with the reference momentum <span class="math inline">p = p_0</span> emits a photon within a bending magnet, it loses energy and will no longer be on the on-energy closed orbit. It will now perform betatron oscillations around a dispersive closed orbit <span class="math inline">p &lt; p_0</span>. (based on <span class="citation" data-cites="wolski"><a href="#ref-wolski" role="doc-biblioref">[16]</a></span>)</figcaption>
</figure>
<p>Until now, we assumed the radiation would be emitted continuously along a given path length parallel to the particle’s momentum. If this were the case, then after some time, the betatron amplitude would damp to zero. However, due to the quantum nature of photons, the radiation is not emitted continuously but rather happens in discrete chunks of energy, resulting in an excitation of the emittance called <em>quantum excitation</em>. Illustrated in <a href="#fig:betatron-oscillation-excitation">Figure 2.7</a>, the discontinuous jump in energy caused by the emission of a photon of discrete energy forces the electron on a dispersive orbit <span class="math inline">p \neq p_0</span>. Subsequently, the electron now performs betatron oscillations around the new closed orbit.</p>
<p>Furthermore, the photons are not emitted precisely parallel to the electron’s velocity but rather in a cone, resulting in a change in the direction of the momentum. That also excites the betatron oscillation and prevents the emittance from damping to zero, even if the emission of synchrotron radiation would be continuous. However, as the latter effect is much smaller than the former, we will neglect this effect for the following considerations.</p>
<p>For same argument leading to <a href="#eq:variation-horizontal-coordinates">Equation 2.80</a>, the emission of a photon with the discrete energy <span class="math inline">\delta E</span> leads to a variation of the betatron offset and betatron slope:</p>
<div id="eq:variation-emittance-quantum-excitation-1">
<table style="width:99%;">
<colgroup>
<col style="width: 90%" />
<col style="width: 9%" />
</colgroup>
<tbody>
<tr class="odd">
<td style="text-align: center;"><span class="math display"> \delta x = - \eta_\mathrm{x} \frac{\delta E}{E_0}, \quad \delta x&#39; = -\eta_\mathrm{x}&#39; \frac{\delta E}{E_0}
</span></td>
<td style="text-align: right;"><span class="math display">(2.93)</span></td>
</tr>
</tbody>
</table>
</div>
<p>Inserting <span class="math inline">\delta x</span> and <span class="math inline">\delta x&#39;</span> into the definition of the phase space ellipse from <a href="#eq:phase-space-ellipse-radiation-damping">Equation 2.68</a>, we obtain an expression for the variation of the emittance caused by the emission of a discrete photon of the energy <span class="math inline">\delta E</span></p>
<div id="eq:variation-emittance-excitation">
<table style="width:99%;">
<colgroup>
<col style="width: 90%" />
<col style="width: 9%" />
</colgroup>
<tbody>
<tr class="odd">
<td style="text-align: center;"><span class="math display">
\begin{aligned}
\delta \epsilon_\mathrm{x}^\mathrm{q} &amp;= (\gamma_\mathrm{x} \eta_\mathrm{x}^2 + 2 \alpha_\mathrm{x} \eta_\mathrm{x} \eta_\mathrm{x}&#39; + \beta_\mathrm{x} \eta_\mathrm{x}&#39;^2) \left(\frac{\delta E}{E_0}\right)^2 \\
&amp;= \mathcal{H}_\mathrm{x} \left(\frac{\delta E}{E_0}\right)^2 ,
\end{aligned}
</span></td>
<td style="text-align: right;"><span class="math display">(2.94)</span></td>
</tr>
</tbody>
</table>
</div>
<p>where we substituted the curly <span class="math inline">\mathcal{H}</span> function defined in <a href="#eq:curly-h">Equation 2.67</a>. As the photons are emitted randomly with different energies <span class="math inline">\delta E</span>, we have to average <a href="#eq:variation-emittance-excitation">Equation 2.94</a> over the energy distribution of the photons. Therefore, we introduce a new quantity <span class="math inline">\dot{n}(\epsilon)</span> which denotes number of photons emitted per time unit in the energy interval <span class="math inline">[\epsilon, \epsilon + \mathrm{d} \epsilon]</span>.</p>
<p>According to <span class="citation" data-cites="sands1970"><a href="#ref-sands1970" role="doc-biblioref">[22]</a></span>, the squared emitted energy per time unit is</p>
<div id="eq:squared-emitted-energy-per-time">
<table style="width:99%;">
<colgroup>
<col style="width: 90%" />
<col style="width: 9%" />
</colgroup>
<tbody>
<tr class="odd">
<td style="text-align: center;"><span class="math display"> \dot{N} \langle \epsilon^2 \rangle = \int_0^\infty \epsilon^2 \dot{n}(\epsilon) \mathrm{d} \epsilon = 2 C_\mathrm{q} \gamma^2 \frac{U_0 E_0}{T_0} \frac{|\kappa_\mathrm{x0}|^3}{\langle \kappa_\mathrm{x0}^2 \rangle_s} ,
</span></td>
<td style="text-align: right;"><span class="math display">(2.95)</span></td>
</tr>
</tbody>
</table>
</div>
<p>where</p>
<div id="eq:c-q">
<table style="width:99%;">
<colgroup>
<col style="width: 90%" />
<col style="width: 9%" />
</colgroup>
<tbody>
<tr class="odd">
<td style="text-align: center;"><span class="math display"> C_\mathrm{q} = \frac{55}{32\sqrt{3}} \frac{\hbar}{mc}
</span></td>
<td style="text-align: right;"><span class="math display">(2.96)</span></td>
</tr>
</tbody>
</table>
</div>
<p>is to the so-called <em>quantum constant</em>.</p>
<p>Using <a href="#eq:squared-emitted-energy-per-time">Equation 2.95</a>, we can integrate <a href="#eq:variation-emittance-excitation">Equation 2.94</a> along the length of the ring to obtain an expression for change of the horizontal emittance caused by the quantum excitation</p>
<div id="eq:emittance-horizontal-derivative-excitation">
<table style="width:99%;">
<colgroup>
<col style="width: 90%" />
<col style="width: 9%" />
</colgroup>
<tbody>
<tr class="odd">
<td style="text-align: center;"><span class="math display">
\begin{aligned}
\frac{\mathrm{d} \epsilon_\mathrm{x}^\mathrm{q}}{\mathrm{d} t}
&amp;= \frac{1}{E_0^2} \int_0^C \mathcal{H}_\mathrm{x} \dot{N}\langle (\delta E)^2 \rangle \mathrm{d} s \\
&amp;= \frac{2}{E_0^2} \int_0^C \mathcal{H}_\mathrm{x} C_\mathrm{q} \gamma^2 \frac{U_0 E_0}{T_0} \frac{|\kappa_\mathrm{x0}|^3}{\langle \kappa_\mathrm{x0}^2 \rangle_s} \mathrm{d} s \\
&amp;= 2 C_\mathrm{q} \gamma^2 \frac{U_0}{E_0 T_0} \frac{\int_0^C \mathcal{H}_\mathrm{x} |\kappa_\mathrm{x0}|^3 \mathrm{d} s}{\int_0^C \kappa_\mathrm{x0}^2 \mathrm{d} s} \\
&amp;= 2 C_\mathrm{q} \gamma^2 \frac{U_0}{E_0 T_0} \frac{I_5}{I_2},
\end{aligned}
</span></td>
<td style="text-align: right;"><span class="math display">(2.97)</span></td>
</tr>
</tbody>
</table>
</div>
<p>where in the last step, we substituted the second and fifth synchrotron radiation integrals <span class="math inline">I_2</span> and <span class="math inline">I_5</span> defined in <a href="#eq:i2">Equation 2.63</a> and <a href="#eq:i5">Equation 2.66</a>. Note that the change of the emittance is positive, which corresponds to an excitation of the emittance.</p>
</section>
<section id="sec:emittance" class="level3" data-number="2.5.3">
<h3 data-number="2.5.3"><span class="header-section-number">2.5.3</span> Equilibrium Emittance</h3>
<p>As discussed in the last two subsections, two counteracting effects are changing the amplitude of the betatron oscillations. The total time derivative of the emittance corresponds to the sum of both, i.e., <a href="#eq:emittance-horizontal-derivative">Equation 2.92</a> and <a href="#eq:emittance-horizontal-derivative-excitation">Equation 2.97</a>:</p>
<div id="eq:total-time-derivative-emittance">
<table style="width:99%;">
<colgroup>
<col style="width: 90%" />
<col style="width: 9%" />
</colgroup>
<tbody>
<tr class="odd">
<td style="text-align: center;"><span class="math display">
\begin{aligned}
\frac{\mathrm{d} \epsilon_\mathrm{x}}{\mathrm{d} t} &amp;= \frac{\mathrm{d} \epsilon_\mathrm{x}^\mathrm{q}}{\mathrm{d} t} + \frac{\mathrm{d} \epsilon_\mathrm{x}^\mathrm{r}}{\mathrm{d} t} \\
&amp;= 2 C_\mathrm{q} \gamma^2 \frac{U_0}{E_0 T_0} \frac{I_5}{I_2} - \epsilon_\mathrm{x} \frac{U_0}{E_0 T_0} \left(1 - \frac{I_4}{I_2}\right) \\
&amp;= \frac{U_0}{E_0 T_0} \left(2 C_\mathrm{q} \gamma^2 \frac{I_5}{I_2} - \epsilon_\mathrm{x} \left(1 - \frac{I_4}{I_2}\right)\right)
\end{aligned}
</span></td>
<td style="text-align: right;"><span class="math display">(2.98)</span></td>
</tr>
</tbody>
</table>
</div>
<p>While the synchrotron damping leads to an exponential decay of the emittance, the quantum excitation is independent of the amplitude causing the emittance to grow constantly. Therefore eventually, both effects become equally strong, leading to a zero time derivative of the emittance</p>
<div id="eq:total-time-derivative-equilibrium-emittance">
<table style="width:99%;">
<colgroup>
<col style="width: 90%" />
<col style="width: 9%" />
</colgroup>
<tbody>
<tr class="odd">
<td style="text-align: center;"><span class="math display">
\begin{aligned}
\frac{\mathrm{d} \epsilon_\mathrm{x}}{\mathrm{d} t} \Bigr|_{\substack{\epsilon_\mathrm{x}=\epsilon_\mathrm{x}^\mathrm{eq}}} &amp;= 0 \\
\epsilon_\mathrm{x}^\mathrm{eq} \left(1 - \frac{I_4}{I_2}\right) &amp;= 2 C_\mathrm{q} \gamma^2 \frac{I_5}{I_2}
\end{aligned}
</span></td>
<td style="text-align: right;"><span class="math display">(2.99)</span></td>
</tr>
</tbody>
</table>
</div>
<p>at a value known as <em>equilibrium emittance</em></p>
<div id="eq:equilibrium-emittance">
<table style="width:99%;">
<colgroup>
<col style="width: 90%" />
<col style="width: 9%" />
</colgroup>
<tbody>
<tr class="odd">
<td style="text-align: center;"><span class="math display">
\epsilon_\mathrm{x}^\mathrm{eq} = 2 C_\mathrm{q} \gamma^2 \frac{I_5}{I_2 - I_4} .
</span></td>
<td style="text-align: right;"><span class="math display">(2.100)</span></td>
</tr>
</tbody>
</table>
</div>
<p>Note that the magnetic lattice fully defines <a href="#eq:equilibrium-emittance">Equation 2.100</a>. For electron storage rings, this has a very practical consequence: The equilibrium emittance is unrelated and therefore not limited by the emittance of the source. Consequently, any arbitrary injected particle distribution damps to the value of the equilibrium emittance.</p>
<p>In the literature, the expression for the equilibrium emittance often differs by a factor of two from <a href="#eq:equilibrium-emittance">Equation 2.100</a>. The reason is that many books use the root-mean-square of the horizontal betatron displacement</p>
<div id="eq:rms-horionztal-displacement">
<table style="width:99%;">
<colgroup>
<col style="width: 90%" />
<col style="width: 9%" />
</colgroup>
<tbody>
<tr class="odd">
<td style="text-align: center;"><span class="math display"> \sigma_{\mathrm{x}\beta}(s) = \langle x_\beta(s)^2 \rangle = \frac{1}{2 \pi} \int_0^{2 \pi} \epsilon_\mathrm{x} \beta_\mathrm{x}(s) \cos(\psi_\mathrm{x}(s) + \psi_\mathrm{x0})^2 = \frac{1}{2} \epsilon_\mathrm{x} \beta_\mathrm{x}(s)
</span></td>
<td style="text-align: right;"><span class="math display">(2.101)</span></td>
</tr>
</tbody>
</table>
</div>
<p>to establish an alternative definition of the emittance</p>
<div id="eq:alternative-equilibrium-emittance">
<table style="width:99%;">
<colgroup>
<col style="width: 90%" />
<col style="width: 9%" />
</colgroup>
<tbody>
<tr class="odd">
<td style="text-align: center;"><span class="math display"> \frac{\sigma_{\mathrm{x}\beta}^\mathrm{eq}(s)}{\beta_\mathrm{x}(s)} = \frac{1}{2} \epsilon_\mathrm{x}^\mathrm{eq} = C_\mathrm{q} \gamma^2 \frac{I_5}{I_2 - I_4} .
</span></td>
<td style="text-align: right;"><span class="math display">(2.102)</span></td>
</tr>
</tbody>
</table>
</div>
</section>
</section>
<section id="sec:lattice-design" class="level2" data-number="2.6">
<h2 data-number="2.6"><span class="header-section-number">2.6</span> Lattice Design</h2>
<p>As shown in the last section, the choice of magnetic lattice for a circular electron ring defines the magnitude of synchrotron radiation and the equilibrium emittance of the particle beam. The previous sections introduced the most important analytical parameters of electron beam dynamics. In this section, we want to discuss the concepts introduced at the example of different periodic lattices. At first, we will cover the FODO lattice, which is the most simple, strong-focusing lattice. However, it has some disadvantages, making it an unfavorable choice for modern high-energy synchrotron radiation facilities. Therefore, in the following subsection, we move on to the double bend achromat lattice (DBA). Due to its dispersion-free straights, it is a more suitable choice for insertion devices, and it has compared to the FODO lattice a lower equilibrium emittance. All plots are created by the developed code.</p>
<section id="the-fodo-lattice" class="level3" data-number="2.6.1">
<h3 data-number="2.6.1"><span class="header-section-number">2.6.1</span> The FODO Lattice</h3>
<p>The FODO cell is the simplest possible strong-focusing lattice. It consists out of alternating horizontal and vertical focusing quadrupoles with drift spaces in between, which give the cell its name: A horizontal <strong>F</strong>ocusing quadrupole, a drift space (<strong>0</strong> force), a horizontal <strong>D</strong>efocusing, and a drift space (<strong>0</strong> force). A schematic of the FODO lattice is shown in <a href="#fig:fodo-schematic">Figure 2.8</a>.</p>
<figure>
<img src="figures/fodo-schematic.svg" id="fig:fodo-schematic" alt="Figure 2.8: Schematic of a FODO cell" /><figcaption aria-hidden="true">Figure 2.8: Schematic of a FODO cell</figcaption>
</figure>
<p>We can use the periodic condition of <a href="#sec:transformation-twiss-parameter">Section 2.3.3</a> to calculate the optical functions <span class="math inline">\beta(s)</span> and <span class="math inline">\eta(s)</span>. The periodic solution of the Twiss parameters <span class="math inline">\beta(s)</span> and <span class="math inline">\eta(s)</span> for a FODO lattice without dipoles (<span class="math inline">R = 0</span>) are shown in the upper plot of <a href="#fig:fodo-twiss">Figure 2.9</a>.</p>
<figure>
<img src="figures/fodo-twiss.svg" id="fig:fodo-twiss" alt="Figure 2.9: Top: Twiss parameters of the FODO cell without dipoles. Bottom: Twiss parameters of a FODO cell with dipoles (solid) compared to a cell without dipoles (dashed, from top)." /><figcaption aria-hidden="true">Figure 2.9: Top: Twiss parameters of the FODO cell without dipoles. Bottom: Twiss parameters of a FODO cell with dipoles (solid) compared to a cell without dipoles (dashed, from top).</figcaption>
</figure>
<p>While the horizontal beta function <span class="math inline">\beta_\mathrm{x}(s)</span> reaches its maximum at the center of the horizontal focusing quadrupole <em>q1</em>, the vertical beta function <span class="math inline">\beta_\mathrm{y}(s)</span> has its maximum at the center of the vertical focusing quadrupole <em>q2</em>. As the dispersion is introduced by bending magnets, this FODO cell has a vanishing dispersion function <span class="math inline">\eta_\mathrm{x}(s)</span>. A high dispersion function is especially undesirable at the location of insertion devices, which would significantly increase the quantum excitation. A circular accelerator must have bending magnets, as - by definition - it has to close at some point, which makes a non-vanishing dispersion function <span class="math inline">\eta_\mathrm{x}(s)</span> inevitable. However, as discussed in the following subsection, it is still possible to design a lattice with no dispersion within certain sections of the ring.</p>
<p>The simplest way to create a FODO-based circular accelerator is to place a bending magnet in the center of every drift space. The Twiss parameters <span class="math inline">\beta(s)</span> and <span class="math inline">\eta(s)</span> for such a FODO cell with dipoles (<span class="math inline">R = \frac{\pi}{8}</span>) are shown in the lower plot of <a href="#fig:fodo-twiss">Figure 2.9</a>. <a href="#tbl:fodo-parameter">Table 2.1</a> lists a comparison of the lattice parameters for both FODO cells.</p>
<div id="tbl:fodo-parameter">
<table>
<caption>Table 2.1: Lattice parameter of the FODO cell from <a href="#fig:fodo-twiss">Figure 2.9</a></caption>
<thead>
<tr class="header">
<th style="text-align: left;"></th>
<th style="text-align: right;">without dipoles</th>
<th style="text-align: right;">with dipoles</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Cell length <span class="math inline">L</span> / m</td>
<td style="text-align: right;">8.00</td>
<td style="text-align: right;">8.00</td>
</tr>
<tr class="even">
<td style="text-align: left;">Bending angle <span class="math inline">\varphi</span></td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;"><span class="math inline">\frac{\pi}{8}</span></td>
</tr>
<tr class="odd">
<td style="text-align: left;">Quadrupole strength <span class="math inline">k</span> / m<span class="math inline">^{-2}</span></td>
<td style="text-align: right;">0.80</td>
<td style="text-align: right;">0.80</td>
</tr>
<tr class="even">
<td style="text-align: left;">Horizontal tune <span class="math inline">Q_\mathrm{x}</span></td>
<td style="text-align: right;">0.28</td>
<td style="text-align: right;">0.28</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Vertical tune <span class="math inline">Q_\mathrm{y}</span></td>
<td style="text-align: right;">0.28</td>
<td style="text-align: right;">0.30</td>
</tr>
<tr class="even">
<td style="text-align: left;">Max. horizontal beta <span class="math inline">\beta_\mathrm{x,max}</span> / m</td>
<td style="text-align: right;">14.11</td>
<td style="text-align: right;">14.05</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Max. vertical beta <span class="math inline">\beta_\mathrm{y,max}</span> / m</td>
<td style="text-align: right;">14.11</td>
<td style="text-align: right;">13.82</td>
</tr>
<tr class="even">
<td style="text-align: left;">Max. dispersion <span class="math inline">\eta_\mathrm{x,max}</span> / m</td>
<td style="text-align: right;">0.00</td>
<td style="text-align: right;">1.85</td>
</tr>
</tbody>
</table>
</div>
<p>As one can see, the dipoles introduced a non-zero dispersion function <span class="math inline">\eta_\mathrm{x}(s)</span> with a graph similar to the horizontal beta function: A maximum of 1.8 meters at the center of the horizontal focusing quadrupole <em>q1</em> and a minimum of 0.8 meters at the center of the vertical focusing quadrupole <em>q2</em>. Due to the horizontal weak-focusing of the dipoles and vertical focusing of the dipole edges, the maxima of the horizontal and vertical beta functions are slightly smaller than in the FODO cell without dipoles. For the same reasons, the vertical tune <span class="math inline">Q_\mathrm{y}</span> is a bit larger.</p>
<figure>
<img src="figures/fodo-twiss-2.svg" id="fig:fodo-twiss-2" alt="Figure 2.10: Top: The horizontal and vertical beta functions \beta(s). Middle: The horizontal and vertical alpha functions \alpha(s). Bottom: The betatron phase \psi(s)" /><figcaption aria-hidden="true">Figure 2.10: Top: The horizontal and vertical beta functions <span class="math inline">\beta(s)</span>. Middle: The horizontal and vertical alpha functions <span class="math inline">\alpha(s)</span>. Bottom: The betatron phase <span class="math inline">\psi(s)</span></figcaption>
</figure>
<p>Discussed in <a href="#sec:betatron-oscillation">Section 2.3.2</a>, the evolution of phase space ellipse of the beam is fully defined by the <span class="math inline">\beta_u(s)</span>, <span class="math inline">\alpha_u(s)</span> and <span class="math inline">\gamma_u(s)</span> functions. <a href="#fig:fodo-twiss-2">Figure 2.10</a> shows the graph of the <span class="math inline">\beta_u(s)</span> and <span class="math inline">\alpha_u(s)</span> functions together with betatron phases <span class="math inline">\psi_u(s)</span>. According to their definition <span class="math inline">\alpha_u(s) = -\beta_u&#39;(s) / 2</span> , the alpha functions <span class="math inline">\alpha_u(s)</span> become zero when the beta functions <span class="math inline">\beta_u(s)</span> are maximum and reach their maximum when the beta functions <span class="math inline">\beta_u(s)</span> change the most. The horizontal betatron phase <span class="math inline">\psi_\mathrm{x}(s)</span> changes the most in the vertical focusing quadrupole <em>q2</em> and its adjacent drift spaces. In contrast, the changes within the starting and ending <em>q1</em> quadrupoles are almost negligible. For the vertical betatron phase <span class="math inline">\psi_\mathrm{y}(s)</span>, it is the other way around. However, due to the edge focusing of the bending magnets, the total vertical phase advance <span class="math inline">Q_\mathrm{y}</span> is slightly larger than in the horizontal plane.</p>
<figure>
<img src="figures/fodo-twiss-floquet.svg" id="fig:fodo-twiss-floquet" alt="Figure 2.11: Top: exemplary trajectory of a single particle (solid blue) and beam envelope (dashed black). Middle: Normalized particle trajectory along the orbit position (floquet transformation). Bottom: Normalized particle trajectory as a function of the betatron phase." /><figcaption aria-hidden="true">Figure 2.11: Top: exemplary trajectory of a single particle (solid blue) and beam envelope (dashed black). Middle: Normalized particle trajectory along the orbit position (floquet transformation). Bottom: Normalized particle trajectory as a function of the betatron phase.</figcaption>
</figure>
<p>The product of the periodic beam amplitude <span class="math inline">\sqrt{\epsilon\beta(s)}</span> and the cosine of the betatron phase <span class="math inline">\psi_u(s)</span> defines the trajectory of a particle in a strictly linear lattice</p>
<div>
<table style="width:99%;">
<colgroup>
<col style="width: 90%" />
<col style="width: 9%" />
</colgroup>
<tbody>
<tr class="odd">
<td style="text-align: center;"><span class="math display"> u(s) = \sqrt{\epsilon\beta_u(s)}\cos{(\psi_u(s) + \psi_0)} ,
</span></td>
<td style="text-align: right;"><span class="math display">(2.103)</span></td>
</tr>
</tbody>
</table>
</div>
<p>as shown at the example of four consecutive FODO cells in the upper part of <a href="#fig:fodo-twiss-floquet">Figure 2.11</a>. The particle performs betatron oscillations according to its betatron phase <span class="math inline">\psi_u(s) + \psi_{u,0}</span> within the beam envelope <span class="math inline">\sqrt{\epsilon\beta(s)}</span>. The second plot of <a href="#fig:fodo-twiss-floquet">Figure 2.11</a> shows the same trajectory using Floquet’s coordinates <span class="math inline">u(s) / \sqrt{\beta(s)}</span>. In these coordinates, the beam envelope <span class="math inline">\sqrt{\epsilon\beta(s)}</span> becomes a constant and the particle performs oscillations distorted by the betatron phase <span class="math inline">\psi_u(s)</span>. When plotting the particle trajectory against the betatron phase <span class="math inline">\psi_u</span>(s) instead of the orbit position <span class="math inline">s</span>, shown in the third plot of <a href="#fig:fodo-twiss-floquet">Figure 2.11</a>, the oscillation has a perfect sinusoidal shape. Note that in this representation, the elements of magnetic lattice become distorted according to their phase advance <span class="math inline">\psi_u(s_1,s_2)</span>.</p>
<figure>
<img src="figures/necktie-plot.svg" id="fig:necktie-plot" alt="Figure 2.12: Mean beta function for different configurations of a FODO cell. For the FODO lattice, the space of stable quadrupole configurations has the form of a necktie and is therefore often called Necktie-Plot." /><figcaption aria-hidden="true">Figure 2.12: Mean beta function for different configurations of a FODO cell. For the FODO lattice, the space of stable quadrupole configurations has the form of a necktie and is therefore often called Necktie-Plot.</figcaption>
</figure>
<p><a href="#fig:necktie-plot">Figure 2.12</a> shows a scan over possible quadrupole settings for FODO cells with different lengths <span class="math inline">L</span> and deflection angles, where we used the stability condition from <a href="#eq:stability-condition">Equation 2.40</a>. Not all configurations of quadrupole strengths result in a stable lattice. One condition is that the focal length of a quadrupole must be greater than its distance to the next quadrupole. Assuming the focal length would be smaller, then the transverse displacement <span class="math inline">u</span> of a particle and its derivative <span class="math inline">\frac{du}{ds}</span> would have the same sign at the start of the following quadrupole, leading to a negative feedback loop. For each pass-through, the deflection would become stronger and stronger in the next quadrupole, eventually leading to the loss of the particle beam.</p>
<p>The area of stable solutions for a FODO cell without bending magnets is symmetrical to the diagonal. For low quadrupole strengths, both quadrupoles need to have a similar strength to create a stable lattice. With increasing quadrupole strength, a larger deviation of both quadrupole strengths is possible, leading to the stable area’s necktie shape. The maximum quadrupole strength is limited by the condition that the focal length of the quadrupoles must be greater than their distance from each other. The smallest average beta function <span class="math inline">\beta_\mathrm{mean}</span> for a FODO cell with a length of 6 meters without bending magnets is achieved when both quadrupoles are set to about 1.1 m<span class="math inline">^{-2}</span>.</p>
<p>With increasing cell length the area of stable solutions decreases. This is again due to the requirement that the focal length of the quadrupoles must be larger than their distance. This means that moving the quadrupoles closer together allows for greater field strengths.</p>
<p>The second and third row of <a href="#fig:necktie-plot">Figure 2.12</a> shows the stability plots for different FODO cells with dipoles with bending angle per cell of <span class="math inline">\pi / 8</span> and <span class="math inline">\pi / 4</span>, respectively. The dipoles edges lead to an additional defocusing in the horizontal plane and focusing in the vertical plane. Therefore, the necktie plot is shifted towards smaller values on the axis of the vertical focusing quadrupole <em>q2</em> depending on the dipole’s deflection angle. Furthermore, dipole edge’s vertical focusing widens the space of stable configurations for lower quadrupole strengths, as a stable solution is possible even if the quadrupole <em>q2</em> is turned off.</p>
<p>The smallest average beta function <span class="math inline">\beta_\mathrm{mean}</span> for a FODO cell with a deflection angle of <span class="math inline">\pi / 8</span> per cell and with a length of 6 meters is achieved when the horizontal focusing quadrupole is set to 0.8 m<span class="math inline">^{-2}</span> and the vertical focusing quadrupole is set to 1.1 m<span class="math inline">^{-2}</span>. Similar to the FODO cell without dipoles, the area of stable solutions is increases when the cell length decreases.</p>
<figure>
<img src="figures/fodo-chromaticity-emittance.svg" id="fig:fodo-chromaticity-emittance" alt="Figure 2.13: Chromaticity and equilibrium emittance of a FODO lattice at 1 GeV." /><figcaption aria-hidden="true">Figure 2.13: Chromaticity and equilibrium emittance of a FODO lattice at 1 GeV.</figcaption>
</figure>
<p>The left part of <a href="#fig:fodo-chromaticity-emittance">Figure 2.13</a> shows the influence of the quadrupole strength on the equilibrium emittance of a FODO cell, where both the horizontal and vertical focusing quadrupoles have the same strength. As one can see, due to the choice of stronger quadrupole, it is possible to reduce the emittance by multiple orders of magnitude. Unfortunately, as shown in the right part of <a href="#fig:fodo-chromaticity-emittance">Figure 2.13</a>, the chromaticity rises with stronger quadrupole values, limiting the achievable emittance as the compensation of the chromaticities leads to a limitation of the dynamic aperture.</p>
<p>All in all, the FODO lattice is less optimal for modern low-emittance synchrotron light sources. For high-energy colliders, the FODO lattice is useful as it maximizes the ratio of bendings magnets per circumference. However, in a synchrotron facility, one generally wants to maximize the ratio of free straights per circumference to utilize insertion devices. Furthermore, the high dispersion function of the FODO lattice leads to a large equilibrium emittance, which is increased even more due to the additional quantum excitation of insertion devices at the location of high dispersion functions. Therefore, the following section presents a lattice with a smaller equilibrium emittance that is more suitable for insertion devices.</p>
</section>
<section id="sec:the-dba-lattice" class="level3" data-number="2.6.2">
<h3 data-number="2.6.2"><span class="header-section-number">2.6.2</span> The DBA Lattice</h3>
<p>As discussed in <a href="#sec:quantum-excitation">Section 2.5.2</a>, quantum excitation increases the emittance of the particle beam, which is a crucial quantity for synchrotron radiation users. The <em>double bend achromat</em> (DBA) lattice, also known as <em>Chasman–Green lattice</em> <span class="citation" data-cites="Chasman1975"><a href="#ref-Chasman1975" role="doc-biblioref">[24]</a></span>, is one type of lattice to achieve a lower emittance than with the FODO lattice presented in the last subsection. In addition, the DBA lattice’s dispersion-free sections are suitable for placing insertion devices, minimizing their contribution to the quantum excitation.</p>
<figure>
<img src="figures/dba-schematic.svg" id="fig:dba-schematic" alt="Figure 2.14: Schematic of the DBA. The dispersive particle trajectories are highlighted in red." /><figcaption aria-hidden="true">Figure 2.14: Schematic of the DBA. The dispersive particle trajectories are highlighted in red.</figcaption>
</figure>
<p><a href="#fig:dba-schematic">Figure 2.14</a> shows the working principle of a DBA cell: In its simplest form, the DBA consists of two dipoles and one quadrupole. The horizontal focusing quadrupole stands between two bending magnets. The quadruple strength is chosen in such a way that it reverses the gradient of the dispersion function <span class="math inline">\eta_\mathrm{x}&#39;(s)</span> so that the second bending magnet cancels out the dispersion <span class="math inline">\eta_\mathrm{x}(s)</span> introduced by the first dipole.</p>
<figure>
<img src="figures/dba-distance.svg" id="fig:dba-distance" alt="Figure 2.15: Three DBA cells with different distances between bending and quadrupole magnet." /><figcaption aria-hidden="true">Figure 2.15: Three DBA cells with different distances between bending and quadrupole magnet.</figcaption>
</figure>
<p>Not only the quadrupole’s strength but also its distance to the surrounding dipoles must be chosen correctly to fulfill the achromatic condition. <a href="#fig:dba-distance">Figure 2.15</a> shows the dispersion function <span class="math inline">\eta_\mathrm{x}</span>, its derivative with respect to the orbit position <span class="math inline">\eta_\mathrm{x}&#39;</span> and the trajectory of multiple dispersive particles for three different DBA cells, where the quadrupole strengths <span class="math inline">k</span> are identical, but the distance between bending magnets and quadrupole is different. The color of the particle trajectories indicates if the momentum deviation is positive or negative. In analogy with the rainbow spectrum of visible light, a particle trajectory drawn in color towards purple represents a positive momentum deviation <span class="math inline">\delta &gt; 0</span>. In contrast, a color towards red corresponds to a negative momentum deviation <span class="math inline">\delta &lt; 0</span>.</p>
<p>In the upper plot, the distance between the dipole magnets and the quadrupole is too short. Here, the dispersion function <span class="math inline">\eta_\mathrm{x}</span> did not have enough space to build up so that the quadrupole could fully reverse the gradient of the dispersion function <span class="math inline">\eta_\mathrm{x}&#39;</span>. Consequently, after the beam exits the cell, there is a non-vanishing dispersion function <span class="math inline">\eta_\mathrm{x} &gt; 0</span>. Alternatively, one could increase the quadrupole strength <span class="math inline">k</span> to meet the achromatic condition. In the second case, the quadrupole strength <span class="math inline">k</span> and the distance between the dipole magnets and the quadrupole match perfectly. As a result, the quadrupole exactly reverses the gradient of the dispersion function <span class="math inline">\eta_\mathrm{x}&#39;</span> so that the dispersion <span class="math inline">\eta_\mathrm{x}</span> outside the cell vanishes. In the last plot, the distance between the bending magnets and the quadrupole is too large, resulting in a negative dispersion function <span class="math inline">\eta_\mathrm{x} &lt; 0</span> at the end of the cell. In this case, choosing a lower quadrupole strength <span class="math inline">k</span> would satisfy the achromatic condition.</p>
<figure>
<img src="figures/dba-twiss.svg" id="fig:dba-twiss" alt="Figure 2.16: Twiss parameters of the DBA cell." /><figcaption aria-hidden="true">Figure 2.16: Twiss parameters of the DBA cell.</figcaption>
</figure>
<p>Usually, there are additional quadrupoles outside the achromat to form a complete DBA cell. <a href="#fig:dba-twiss">Figure 2.16</a> shows the graphs of the beta functions <span class="math inline">\beta_u(s)</span>, the dispersion functions <span class="math inline">\eta_\mathrm{x}(s)</span> and <span class="math inline">\eta_\mathrm{x}&#39;(s)</span> and the betatron phases <span class="math inline">\psi_u(s)</span> of a DBA cell with two additional quadrupoles <em>q1</em> and <em>q2</em> outside of the achromat. Additionally, <a href="#tbl:dba-parameter">Table 2.2</a> lists important lattice parameters of this DBA cell.</p>
<div id="tbl:dba-parameter">
<table>
<caption>Table 2.2: DBA lattice parameters</caption>
<thead>
<tr class="header">
<th style="text-align: left;"></th>
<th style="text-align: right;">DBA</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Cell length <span class="math inline">L</span> / m</td>
<td style="text-align: right;">8.00</td>
</tr>
<tr class="even">
<td style="text-align: left;">Bending angle <span class="math inline">\varphi</span></td>
<td style="text-align: right;"><span class="math inline">\frac{\pi}{16}</span></td>
</tr>
<tr class="odd">
<td style="text-align: left;">Quadrupole strength <span class="math inline">k_\mathrm{Q1}</span> / m<span class="math inline">^{-2}</span></td>
<td style="text-align: right;">4.10</td>
</tr>
<tr class="even">
<td style="text-align: left;">Quadrupole strength <span class="math inline">k_\mathrm{Q2}</span> / m<span class="math inline">^{-2}</span></td>
<td style="text-align: right;">-6.05</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Quadrupole strength <span class="math inline">k_\mathrm{Q3}</span> / m<span class="math inline">^{-2}</span></td>
<td style="text-align: right;">7.82</td>
</tr>
<tr class="even">
<td style="text-align: left;">Horizontal tune <span class="math inline">Q_\mathrm{x}</span></td>
<td style="text-align: right;">0.75</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Vertical tune <span class="math inline">Q_\mathrm{y}</span></td>
<td style="text-align: right;">0.57</td>
</tr>
<tr class="even">
<td style="text-align: left;">Maximum horizontal beta <span class="math inline">\beta_\mathrm{x,max}</span> / m</td>
<td style="text-align: right;">27.57</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Maximum vertical beta <span class="math inline">\beta_\mathrm{y,max}</span> / m</td>
<td style="text-align: right;">27.88</td>
</tr>
<tr class="even">
<td style="text-align: left;">Maximum dispersion <span class="math inline">\eta_\mathrm{x,max}</span> / m</td>
<td style="text-align: right;">0.26</td>
</tr>
</tbody>
</table>
</div>
<p>Here the quadrupoles <em>q1</em> and <em>q2</em> provide the horizontal and vertical focusing of the particle beam. As discussed above, the quadrupole <em>q3</em> reverses the gradient of the dispersion function <span class="math inline">\eta_\mathrm{x}&#39;</span>. For the second dipole to have precisely the opposite effect on dispersion as the first, the particles must perform exactly half a betatron oscillation from the center of the first dipole to the center of the second dipole. This condition corresponds to a phase advance of <span class="math inline">\psi_\mathrm{x}(s_\mathrm{center_1}, s_\mathrm{center_2}) = \pi</span>, marked in the bottom plot of <a href="#fig:dba-twiss">Figure 2.16</a>.</p>
<figure>
<img src="figures/dba-quad_scan_3_families.svg" id="fig:dba-quad-scan" alt="Figure 2.17: Quadrupole scan for a DBA with three quadrupole families. In constrast to the Necktie-plot here, different islands of stable lattice configurations emerge." /><figcaption aria-hidden="true">Figure 2.17: Quadrupole scan for a DBA with three quadrupole families. In constrast to the Necktie-plot here, different islands of stable lattice configurations emerge.</figcaption>
</figure>
<p>Not all quadrupole configurations satisfy the stability condition from <a href="#eq:stability-condition">Equation 2.40</a>, making it significantly more difficult to find the optimal quadrupole setting for a given objective. In the case of the FODO cell, which has only two parameters, it is relatively straightforward as it is possible to scan over all possible quadrupole settings, as shown in <a href="#fig:necktie-plot">Figure 2.12</a>. Furthermore, even though unstable lattice configurations exist, there is only one contiguous area of stable configurations. However, as shown in <a href="#fig:dba-quad-scan">Figure 2.17</a>, even for the simple DBA lattice of <a href="#fig:dba-twiss">Figure 2.16</a>, which only has three different quadrupole families, there emerge multiple areas where a stable solution exists. While it is for three quadrupole families still possible to scan over all possible values, this becomes unfeasible for six or more magnets <span class="citation" data-cites="andreas_ba"><a href="#ref-andreas_ba" role="doc-biblioref">[5]</a></span>. These discontinuities, leading to the islands of stable lattice configurations, make optimizers only useable within a given island and therefore pose one of the most challenging tasks in lattice development. <a href="#sec:turning-off-the-q5t2-quadrupoles">Section 4.1.3</a> discusses how some of these problems have been dealt with for the Q5T2off lattice of the BESSY II storage ring.</p>
<p>Overall, the DBA lattice is suitable for a low emittance synchrotron light source and therefore was a very common choice among many third-generation light sources, including BESSY II. However, the multi-bend achromat (MBA) lattice allows for even smaller emittances, making it a popular choice for fourth-generation light sources. The additional quadrupoles placed between the bending magnets keep the dispersion function further down, resulting in a smaller emittance.</p>
<p>Note that the achromatic condition does not necessarily lead to the smallest equilibrium emittance, as defined in <a href="#eq:equilibrium-emittance">Equation 2.100</a>. As demonstrated in <span class="citation" data-cites="farvacque"><a href="#ref-farvacque" role="doc-biblioref">[25]</a></span>, another trend is to break the achromatic condition and leak a finite value of the dispersion function <span class="math inline">\eta_\mathrm{x}</span> into the straight sections. That effectively distributes the dispersion function <span class="math inline">\eta_\mathrm{x}</span> along the ring and reduces it within the dipole magnets. As long as the dispersion function <span class="math inline">\eta_\mathrm{x}</span> does not become too large within the insertion devices, distributing the dispersion function over the entire ring can reduce the equilibrium emittance.</p>
</section>
</section>
</section>
<section id="implementation" class="level1" data-number="3">
<h1 data-number="3"><span class="header-section-number">3</span> Implementation</h1>
<p>This chapter covers the challenges and considerations made in implementing the developed optics code <em>apace</em>. The first section presents a brief overview of the used technologies. <a href="#sec:improving-performance">Section 3.2</a> presents the optimizations made to improve the performance of the computation of the Twiss parameters. While a high-level overview of the functionality of the accelerator model is given in <a href="#sec:accelerator-model">Section 3.3</a>, <a href="#sec:implementation-usage">Section 3.4</a> goes into more detail on a usage example. Finally, <a href="#sec:latticejson">Section 3.5</a> introduces the new JSON-based lattice file format <em>LatticeJSON</em>.</p>
<p>The complete documentation of the developed code is provided by <a href="#sec:appendix-documentation">Section 11</a> or at:</p>
<blockquote>
<p><a href="https://apace.readthedocs.io">https://apace.readthedocs.io</a></p>
</blockquote>
<p>The source code is available at:</p>
<blockquote>
<p><a href="https://github.com/andreasfelix/apace">https://github.com/andreasfelix/apace</a></p>
</blockquote>
<section id="overview-of-used-technology" class="level2" data-number="3.1">
<h2 data-number="3.1"><span class="header-section-number">3.1</span> Overview of Used Technology</h2>
<p>The new lattice development tool is implemented in the Python language. While Python’s large ecosystem of scientific libraries and high-level syntax, sometimes almost similar to plain English, are major benefits, its dynamic nature makes it necessary to make considerations concerning the performance. For example, in Python, even numbers are rich objects at runtime, and integers can hold values of arbitrary size. In addition, collection types like lists only hold references to objects, leading to non-contiguous chunks of data and, therefore, to less efficient memory layouts. Python’s dynamic type system offers much flexibility but provides fewer guarantees, leading to many lookups, inefficient loops, and generally involves more steps for any operation than in a statically typed language. Furthermore, the most widely used Python implementation CPython <span class="citation" data-cites="cpython"><a href="#ref-cpython" role="doc-biblioref">[14]</a></span> does not compile to native machine code but instead translates Python files to an intermediate format called bytecode and then executes it on a virtual machine, leading to a performance penalty.</p>
<p>There are various ongoing efforts to improve the performance of CPython <span class="citation" data-cites="faster-cpython mypyc cinder"><a href="#ref-faster-cpython" role="doc-biblioref">[26]</a>–<a href="#ref-cinder" role="doc-biblioref">[28]</a></span> or to create an alternative faster implementation of the Python language <span class="citation" data-cites="pypy nuitka"><a href="#ref-pypy" role="doc-biblioref">[29]</a>, <a href="#ref-nuitka" role="doc-biblioref">[30]</a></span>. Nevertheless, even with these optimizations, pure Python cannot compete with low-level languages in numerical performance, making it not well suited to implement a computational-heavy library.</p>
<p>One popular solution to this performance problem is the NumPy package <span class="citation" data-cites="numpy"><a href="#ref-numpy" role="doc-biblioref">[31]</a></span>, which is so widely used that it can be almost considered part of Python when it comes to scientific computing. NumPy provides a highly efficient multidimensional array type, which is, contrary to Python’s built-in list, fixed in size, a contiguous chunk of memory, and restricts all elements to be the same type with a fixed bit length. In addition, NumPy comes with a collection of mathematical routines implemented in lower-level languages like C or Fortran. These routines, like matrix multiplication or element-wise operations, are not run by Python’s bytecode interpreter but separated from the language runtime at native speed. Thus, using the NumPy package, scientists get the best of both worlds: Python’s flexibility and short development times and the performance of natively compiled libraries when working with numerical data.</p>
<p>All data represented by arrays like the beta or dispersion functions utilize NumPy’s array type in the developed code. A limiting factor is when an operation is not expressible by a single NumPy function but has to be composed out of many function calls. Crossing the boundaries between NumPy and Python worlds imposes a performance cost. This performance penalty is minimized the more time is spent within a NumPy routine. For the computation of the Twiss product or the one-turn-matrix of the storage ring, which includes many consecutive multiplications of small 6x6-matrices, the cost of crossing the boundaries, therefore, becomes a limiting factor. For algorithms requiring much indexing, using a Numpy array can even be slower than pure Python code.</p>
<p>Solutions to improve the performance of algorithms in combination with NumPy arrays are the Numba <span class="citation" data-cites="numba"><a href="#ref-numba" role="doc-biblioref">[32]</a></span> or Pythran <span class="citation" data-cites="pythran"><a href="#ref-pythran" role="doc-biblioref">[33]</a></span> compilers, which can translate a subset of the Python language and some NumPy operations to native machine code. However, to achieve maximum performance, it was decided to implement the time-critical parts of the developed code in C. Therefore, the CFFI package <span class="citation" data-cites="cffi"><a href="#ref-cffi" role="doc-biblioref">[34]</a></span> was used to call the C functions from Python. Furthermore, to fully utilize the hardware, some of the C routines were written with multithreading using the OpenMP API <span class="citation" data-cites="openmp"><a href="#ref-openmp" role="doc-biblioref">[35]</a></span>.</p>
<p>With a share of about 95 percent, most of the code is still implemented in Python. All of this should be invisible to a user of the developed library.</p>
<p>Another popular Python package is the matplotlib library <span class="citation" data-cites="matplotlib"><a href="#ref-matplotlib" role="doc-biblioref">[36]</a></span>, which provides a framework to create scientific plots. It is very common when plotting the Twiss parameters to visualize the magnetic lattice or annotate the different accelerator sections. Therefore, the developed code provides some functions for this purpose utilizing the matplotlib framework. Furthermore, a function to draw a floorplan for a given magnetic lattice is included.</p>
</section>
<section id="sec:improving-performance" class="level2" data-number="3.2">
<h2 data-number="3.2"><span class="header-section-number">3.2</span> Improving the Performance of the Twiss Calculation</h2>
<p>This section discusses some optimizations to improve the performance of the computation of the one-turn-matrix and the Twiss parameters. The steps for calculating the Twiss parameters can be summarized:</p>
<ol type="1">
<li><p>Choose an arbitrary point on the orbit as an initial position for the periodicity condition</p></li>
<li><p>Create an array of <span class="math inline">N</span> elements starting from the initial point</p>
<div>
<table style="width:99%;">
<colgroup>
<col style="width: 90%" />
<col style="width: 9%" />
</colgroup>
<tbody>
<tr class="odd">
<td style="text-align: center;"><span class="math display">[\mathrm{A}, \mathrm{B}, \mathrm{C}, \mathrm{D}, ...]</span></td>
<td style="text-align: right;"><span class="math display">(3.1)</span></td>
</tr>
</tbody>
</table>
</div></li>
<li><p>Map the array of elements to an array of transfer matrices (transfer matrices for individual elements)</p>
<div>
<table style="width:99%;">
<colgroup>
<col style="width: 90%" />
<col style="width: 9%" />
</colgroup>
<tbody>
<tr class="odd">
<td style="text-align: center;"><span class="math display">[\mathbf{R}_\mathrm{A}, \mathbf{R}_\mathrm{B}, \mathbf{R}_\mathrm{C}, \mathbf{R}_\mathrm{D}, ...]</span></td>
<td style="text-align: right;"><span class="math display">(3.2)</span></td>
</tr>
</tbody>
</table>
</div></li>
<li><p>Accumulate the transfer matrices to the different orbit positions (transfer matrics from starting point to orbit position of given element). The last matrix of this array <span class="math inline">\mathbf{R}_N</span> corresponds to the one-turn-matrix.</p>
<div>
<table style="width:99%;">
<colgroup>
<col style="width: 90%" />
<col style="width: 9%" />
</colgroup>
<tbody>
<tr class="odd">
<td style="text-align: center;"><span class="math display">
 [\mathbf{R}_1, \mathbf{R}_2, \mathbf{R}_3, ..., \mathbf{R}_N] \; \textrm{with} \;
 \mathbf{R}_1 = \mathbf{R}_\mathrm{A}, \;
 \mathbf{R}_2 = \mathbf{R}_\mathrm{B} \mathbf{R}_1, \;
 \mathbf{R}_3 = \mathbf{R}_\mathrm{C}  \mathbf{R}_2 , ...
 </span></td>
<td style="text-align: right;"><span class="math display">(3.3)</span></td>
</tr>
</tbody>
</table>
</div></li>
<li><p>Calculate initial Twiss parameters from one-turn-matrix <span class="math inline">\mathbf{R}_N</span> using (periodic solution)</p></li>
<li><p>Calculate the Twiss product of the initial Twiss matrix with the accumulated transfer matrix at every orbit position</p>
<div>
<table style="width:99%;">
<colgroup>
<col style="width: 90%" />
<col style="width: 9%" />
</colgroup>
<tbody>
<tr class="odd">
<td style="text-align: center;"><span class="math display">
 \mathbf{B}_n = \mathbf{R}_n \cdot \mathbf{B}_0 \cdot \mathbf{R}_n^\mathrm{T},
 </span></td>
<td style="text-align: right;"><span class="math display">(3.4)</span></td>
</tr>
</tbody>
</table>
</div>
<p>where <span class="math inline">\mathbf{B}_0</span> corresponds to the Twiss parameters at the initial position.</p></li>
</ol>
<p>During a scan or optimization, the Twiss parameters are calculated multiple times in a row, which allows for a relatively simple but effective optimization in step 3: Supposing not every magnet of the lattice changes during each iteration. Then, if the code keeps track of the changed elements, only the transfer matrices for changed elements must be recomputed. The transfer matrices of the remaining elements can be cached.</p>
<figure>
<img src="figures/matrix-multiplication.svg" id="fig:matrix-multiplication" alt="Figure 3.1: The calculation of the accumulated transfer matrices has to be serial (top). Alternatively the one-turn-matrix \mathbf{R}_N can be calculated in parallel." /><figcaption aria-hidden="true">Figure 3.1: The calculation of the accumulated transfer matrices has to be serial (top). Alternatively the one-turn-matrix <span class="math inline">\mathbf{R}_N</span> can be calculated in parallel.</figcaption>
</figure>
<p>The calculation of the Twiss parameters is inherently a not fully parallelizable problem because either step 4 or step 6 have to be computed sequentially, leading to two options:</p>
<p>In the first case, calculating the accumulated transfer matrices <span class="math inline">\mathbf{R}_n</span> for every orbit position makes step 6 parallelizable. However, as each accumulated transfer matrix <span class="math inline">\mathbf{R}_n</span> depends on the previous transfer matrix <span class="math inline">\mathbf{R}_{n-1}</span>, step 4 must be sequential, shown in the upper part of <a href="#fig:matrix-multiplication">Figure 3.1</a>.</p>
<p>Alternatively, the calculation of the accumulated transfer matrices could be skipped, and the one-turn-matrix <span class="math inline">\mathbf{R}_N</span> could be computed in parallel as shown in the bottom part of <a href="#fig:matrix-multiplication">Figure 3.1</a>. But, this would make it necessary to calculate the Twiss product using the individual transfer matrices, for example</p>
<div>
<table style="width:99%;">
<colgroup>
<col style="width: 90%" />
<col style="width: 9%" />
</colgroup>
<tbody>
<tr class="odd">
<td style="text-align: center;"><span class="math display">
\mathbf{B}_\mathrm{3} = \mathbf{R}_\mathrm{C} \cdot \mathbf{B}_2 \cdot \mathbf{R}_\mathrm{C}^\mathrm{T},
</span></td>
<td style="text-align: right;"><span class="math display">(3.5)</span></td>
</tr>
</tbody>
</table>
</div>
<p>which would require step 6 to be sequential.</p>
<p>There are two reasons to choose the first option over the second: First, the Twiss product contains two matrix multiplications, while the accumulation of the transfer matrix contains only one. Consequently, the first option performs more work in parallel. Secondly, in option 1, the Twiss product is fully parallelizable with a step complexity of 1 and limited only by the number of threads. On the other hand, the calculation of the one-turn-matrix using parallel reduction has a step complexity of <span class="math inline">\log_2(N)</span>.</p>
<figure>
<img src="figures/benchmark-twiss-calculation.svg" id="fig:benchmark-twiss-calculation" alt="Figure 3.2: Performance comparison of different implemenations of the Twiss product" /><figcaption aria-hidden="true">Figure 3.2: Performance comparison of different implemenations of the Twiss product</figcaption>
</figure>
<p>As most of the time is spent in steps 4 and 6, it is critical to make them as fast as possible. <a href="#fig:benchmark-twiss-calculation">Figure 3.2</a> shows a benchmark of different implementations of the Twiss product (step 6). <code>numpy_dot</code> corresponds to the naive NumPy implementation where the Twiss product is calculated using <code>numpy.dot</code>, leading to <span class="math inline">2 N</span> function calls. The <code>numpy.einsum</code> or <code>opt_einsum</code> functions allow calculating any arbitrary operation expressible in index notation within a single function call. For the Twiss product</p>
<div>
<table style="width:99%;">
<colgroup>
<col style="width: 90%" />
<col style="width: 9%" />
</colgroup>
<tbody>
<tr class="odd">
<td style="text-align: center;"><span class="math display">
\mathbf{B}_{nij} = \sum_{kl} \mathbf{R}_{nik} \mathbf{B}_{0kl} \mathbf{R}_{njl}
</span></td>
<td style="text-align: right;"><span class="math display">(3.6)</span></td>
</tr>
</tbody>
</table>
</div>
<p>this corresponds to:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>numpy.einsum(<span class="st">&quot;nik,kl,njl-&gt;nij&quot;</span>, matrices, b0, matrices)</span></code></pre></div>
<p>The Twiss product was also implemented in C. Once as the full matrix product corresponding to <a href="#eq:transformation-beta-matrix">Equation 2.36</a> and once as a reduced version corresponding to <a href="#eq:betatron-function-transformation">Equation 2.37</a>, which takes advantage of the symmetry of the transfer matrices. Furthermore, the C versions were implemented as sequential and parallel versions, taking advantage of all CPU cores. Finally, the C code was called once using the ctypes package, included in the standard library, and once with the aforementioned CFFI package.</p>
<p>The implementations vastly vary in execution speed. The <code>numpy.einsum</code> version is below <span class="math inline">N=2000</span> significantly faster than the naive NumPy implementation <code>numpy_dot</code>. This can probably be attributed to the much fewer function calls. Surprisingly, there is a large performing decrease at about <span class="math inline">N \approx 2000</span>, making the <code>numpy.einsum</code> as about as fast as the <code>numpy_dot</code> version.</p>
<p>The custom C versions are significantly faster. One reason for that is that the C compiler knows the size of the matrix array is <span class="math inline">(N, 6, 6)</span> and can therefore produce optimized code for this operation. Furthermore, modern C compilers can automatically take advantage of the <em>Single Instruction, Multiple Data</em> (SIMD) instructions shipped with modern CPUs. SIMD instructions allow performing vectorized operations on up to 512 bits at once. By looking at the generated code, it was verified that these SIMD instructions were present in the resulting binary.</p>
<p>Two of the parallel C versions are below <span class="math inline">N \approx 1500</span> slower than their sequential counterpart. There is some cost in setting up the different threads. If the time spent within the thread is too short, this initial cost limits the executions speed, explaining why the sequential versions are faster for a lower number of matrices <span class="math inline">N</span>. Looking at the graphs of the parallel version, one can see multiple spikes. This is because the slowest core limits the total runtime of a parallel operation. If the CPU is fully utilized, the operating system might briefly stop one core to schedule a background process, leading one thread to be significantly slower than the others.</p>
<p>Finally, the CFFI package has a lower overhead in calling a C function than the ctypes packages. The difference of this overhead is significant up to <span class="math inline">N \approx 5000</span>. For this reason and because CFFI is compatible with more Python implementations, it was decided to use the CFFI package instead of the built-in ctypes package.</p>
</section>
<section id="sec:accelerator-model" class="level2" data-number="3.3">
<h2 data-number="3.3"><span class="header-section-number">3.3</span> Representation of the Magnetic Lattice</h2>
<p>Besides implementing the physical simulation methods, a major difficulty is the representation of the particle accelerator within the simulation software. The goal is to facilitate the usage of existing optimization and learning algorithms. A good conceptual approach is to model the programming interface after the real machine, in a sense, by creating a digital representation of the accelerator. Different simulation methods like tracking or Twiss calculation implementations are built on top of this digital representation.</p>
<p>Together with a simulation method, the interaction of digital representation of the accelerator and the optimizer can be considered an <em>environment-agent</em> relationship, visualized in <a href="#fig:workflow-optimizer">Figure 3.3</a>. In that sense, the optimizer is an <em>agent</em> changing configuration of the <em>environment</em>, the digital representation of the accelerator, and observes the new state corresponding to the result of the simulation method. An event system powers the underlying implementation. Supposing the optimizer changes the strength of a quadrupole. Then, the digital representation of the accelerator informs the simulation method that it must recompute a new state. Next, the optimizer accesses the updated state and accordingly takes another action on the environment. These steps repeat until they reach a satisfactory condition.</p>
<figure>
<img src="figures/workflow-optimizer.svg" id="fig:workflow-optimizer" alt="Figure 3.3: Relationship between the lattice file, the digital representation of the accelerator, the simulation methods, and the optimizer." /><figcaption aria-hidden="true">Figure 3.3: Relationship between the lattice file, the digital representation of the accelerator, the simulation methods, and the optimizer.</figcaption>
</figure>
<p>The description of the accelerator is stored in a so-called lattices file. This file has to be parsed by the simulation software. The different constituents of the accelerator have to be represented by data types available in the given programming language. To provide a convenient interface, this was done in an object-oriented way, primarily using two base classes:</p>
<ol type="1">
<li><code>Element</code> class</li>
<li><code>Lattice</code> class</li>
</ol>
<p>An instance of the <code>Element</code> class is a fundamental building block of the particle accelerator. This could be, for example, a <code>Drift</code> space, a <code>Dipole</code> magnet, or a <code>Cavity</code> object. On the other hand, an instance of the <code>Lattice</code> class is a sequence of <code>Element</code> objects or even other (sub-)<code>Lattice</code> objects.</p>
<p>Each element type is a subclass of the <code>Element</code> class, which provides common attributes like a <code>length</code> or a <code>name</code> that uniquely identifies the element. Furthermore, each subclass implements additional attributes to describe the given element type.</p>
<figure>
<img src="figures/lattice-tree.svg" id="fig:lattice-tree" alt="Figure 3.4: A representation of the BESSY II storage ring design lattice. At the top tree is the BESSY II lattice, which consists out of the Doublet and Triplet sub-lattices. The Doublet and Triplet again consist out of two Achromat sub-lattices, one Straight sub-lattice and two dipole elements." /><figcaption aria-hidden="true">Figure 3.4: A representation of the BESSY II storage ring design lattice. At the top tree is the <em>BESSY II</em> lattice, which consists out of the <em>Doublet</em> and <em>Triplet</em> sub-lattices. The <em>Doublet</em> and <em>Triplet</em> again consist out of two <em>Achromat</em> sub-lattices, one <em>Straight</em> sub-lattice and two dipole elements.</figcaption>
</figure>
<p>The representation of the particle accelerator can be thought of as a tree-like structure, as shown in <a href="#fig:lattice-tree">Figure 3.4</a>, where the <code>Element</code> objects are the leaves, the <code>Lattice</code> objects are the nodes, and the main <code>Lattice</code> object is the root of the tree.</p>
<p>As this object-orient way comes at a price, the simulation methods should use more primitive data structures like arrays. Only the interface to the digital representation of the accelerator should use these higher-level data structures. Moreover, the simulation methods should be implemented as fast as possible.</p>
</section>
<section id="sec:implementation-usage" class="level2" data-number="3.4">
<h2 data-number="3.4"><span class="header-section-number">3.4</span> Usage</h2>
<p>This section gives a small overview of the usage of the developed code. The reader is encouraged to start an interactive Python shell or IPython shell, which has multiline support, and follow along by copying the following code snippets.</p>
<p>The only requirements are Python 3.6 or higher and a C compiler. Then, the most recent version of the developed code, which is 0.1.0 at the moment, can be installed with:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="ex">pip</span> install <span class="at">-U</span> apace</span></code></pre></div>
<p>The first step is to import the library:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> apace <span class="im">as</span> ap</span></code></pre></div>
<p>Next, we will build a FODO-ring consisting out of 8 FODO cells. Therefore we create a drift, a bending magnet, one horizontal and one vertical focusing quadrupole.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>d1 <span class="op">=</span> ap.Drift(<span class="st">&quot;d1&quot;</span>, length<span class="op">=</span><span class="fl">0.55</span>)</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>b1 <span class="op">=</span> ap.Dipole(<span class="st">&quot;b1&quot;</span>, length<span class="op">=</span><span class="fl">1.5</span>, angle<span class="op">=</span><span class="fl">0.392699</span>, e1<span class="op">=</span><span class="fl">0.1963505</span>, e2<span class="op">=</span><span class="fl">0.1963505</span>)</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>q1 <span class="op">=</span> ap.Quadrupole(<span class="st">&quot;q1&quot;</span>, length<span class="op">=</span><span class="fl">0.2</span>, k1<span class="op">=</span><span class="fl">1.2</span>)</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>q2 <span class="op">=</span> ap.Quadrupole(<span class="st">&quot;q2&quot;</span>, length<span class="op">=</span><span class="fl">0.4</span>, k1<span class="op">=-</span><span class="fl">1.2</span>)</span></code></pre></div>
<p>The first argument corresponds to the name of the element, while the other parameters are self-explaining. By arranging the just created elements, we can build a FODO cell. Copying this cell eight times, we end up with a ring with 8-fold symmetry.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>fodo <span class="op">=</span> ap.Lattice(<span class="st">&quot;FODO&quot;</span>, [q1, d1, b1, d1, q2, d1, b1, d1, q1])</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>ring <span class="op">=</span> ap.Lattice(<span class="st">&quot;RING&quot;</span>, <span class="dv">8</span> <span class="op">*</span> [fodo])</span></code></pre></div>
<p>To get more information on a specific element, we can use the <code>print</code> function to output a table of attributes:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;&gt;&gt;</span> print<span class="kw">(</span><span class="ex">b1</span><span class="kw">)</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="bu">type</span>            : Dipole</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="ex">angle</span>           : 0.392701</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="ex">e1</span>              : 0.1963505</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a><span class="ex">e2</span>              : 0.1963505</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a><span class="ex">k0</span>              : 0.2618006666666667</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a><span class="ex">length</span>          : 1.5</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a><span class="ex">name</span>            : b1</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a><span class="ex">parent_lattices</span> : {FODO}</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a><span class="ex">radius</span>          : 3.8196999752992733</span></code></pre></div>
<p>These attributes can be accessed using Python’s usual <code>.</code>-operator.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;&gt;&gt;</span> d1.length</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="fl">0.55</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;&gt;&gt;</span> fodo.length</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="fl">6.0</span></span></code></pre></div>
<p>What is notable is that attributes like the length of a lattice, which depends on its elements’ lengths, are automatically updated when one of its elements changes its length.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;&gt;&gt;</span> d1.length <span class="op">=</span> <span class="fl">0.6</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;&gt;&gt;</span> fodo.length</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="fl">6.2</span></span></code></pre></div>
<p>Next, our goal is to plot the Twiss parameters of the FODO ring. Therefore, we create an instance of the <code>Twiss</code> class, which takes a <code>Lattice</code> object as its argument.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>twiss <span class="op">=</span> ap.Twiss(ring)</span></code></pre></div>
<p>We can use matplotlib to plot the beta and dispersion functions:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> apace.plot <span class="im">as</span> aplot</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots()</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>ax.plot(twiss.s, twiss.beta_x, label<span class="op">=</span><span class="vs">r&quot;$\beta_\mathrm</span><span class="sc">{x}</span><span class="vs">$ / m&quot;</span>)</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>ax.plot(twiss.s, twiss.beta_y, label<span class="op">=</span><span class="vs">r&quot;$\beta_\mathrm</span><span class="sc">{x}</span><span class="vs">$ / m&quot;</span>)</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>ax.plot(twiss.s, twiss.eta_x, label<span class="op">=</span><span class="vs">r&quot;$\eta_\mathrm</span><span class="sc">{x}</span><span class="vs">$ / m&quot;</span>)</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>ax.<span class="bu">set</span>(xlabel<span class="op">=</span><span class="st">&quot;orbit position $s$ / m&quot;</span>)</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>ax.legend(loc<span class="op">=</span><span class="st">&quot;upper center&quot;</span>, bbox_to_anchor<span class="op">=</span>(<span class="fl">0.5</span>, <span class="fl">1.1</span>), ncol<span class="op">=</span><span class="dv">3</span>, frameon<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>fig.show()</span></code></pre></div>
<p>The developed code comes with a set of convenience functions, which allows us to draw the magnetic lattice and annotate the locations of the individual FODO cells.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>aplot.draw_elements(ax, ring, location<span class="op">=</span><span class="st">&quot;bottom&quot;</span>)</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>aplot.draw_sub_lattices(ax, ring, location<span class="op">=</span><span class="st">&quot;bottom&quot;</span>)</span></code></pre></div>
<p>After calling these functions, we end up with the plot shown in <a href="#fig:fodo-twiss-apace">Figure 3.5</a>.</p>
<figure>
<img src="figures/fodo-twiss-apace.svg" id="fig:fodo-twiss-apace" alt="Figure 3.5: Twiss parameters for a FODO ring with 8-fold symmetry" /><figcaption aria-hidden="true">Figure 3.5: Twiss parameters for a FODO ring with 8-fold symmetry</figcaption>
</figure>
<p>In the following example, we will create the famous necktie plot, which marks the regions of quadrupole configurations leading to a stable lattice. We will use an interval <span class="math inline">0 &lt; k &lt; 2</span> with a sample size of 100. The results will be stored in a 2-dimensional NumPy array.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>samples <span class="op">=</span> <span class="dv">100</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>start, end <span class="op">=</span> <span class="dv">0</span>, <span class="dv">2</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>results <span class="op">=</span> np.empty((samples, samples))</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>interval <span class="op">=</span> np.linspace(start, end, samples)</span></code></pre></div>
<p>Next, we loop over the quadrupole strength of the horizontal focusing Q1 and vertical focusing Q2 quadrupoles. In the body of the loop we, store the average beta function if a stable solution exists. Otherwise, we store the <em>not a number</em> (nan) value.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, q1.k1 <span class="kw">in</span> <span class="bu">enumerate</span>(interval):</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> j, q2.k1 <span class="kw">in</span> <span class="bu">enumerate</span>(<span class="op">-</span>interval):</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span>:</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>            results[i, j] <span class="op">=</span> np.mean([twiss.beta_x, twiss.beta_y])</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>        <span class="cf">except</span> ap.UnstableLatticeError:</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>            results[i, j] <span class="op">=</span> np.nan</span></code></pre></div>
<p>Again, we can use matplotlib to visualize the results.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots()</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>extent <span class="op">=</span> start, end, start, <span class="op">-</span>end</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>image <span class="op">=</span> ax.imshow(results.T, extent<span class="op">=</span>extent, origin<span class="op">=</span><span class="st">&quot;lower&quot;</span>, vmin<span class="op">=</span><span class="dv">0</span>, vmax<span class="op">=</span><span class="dv">30</span>)</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>ax.<span class="bu">set</span>(xlabel<span class="op">=</span><span class="vs">r&quot;$k_\mathrm</span><span class="sc">{q1}</span><span class="vs">$ / m$^{-2}$&quot;</span>, ylabel<span class="op">=</span><span class="vs">r&quot;$k_\mathrm</span><span class="sc">{q2}</span><span class="vs">$ / m$^{-2}$&quot;</span>)</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>fig.colorbar(image, ax<span class="op">=</span>ax).ax.set_title(<span class="vs">r&quot;$\beta_\mathrm</span><span class="sc">{mean}</span><span class="vs">$&quot;</span>)</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>fig.show()</span></code></pre></div>
<p>Executing this code gives the plot in <a href="#fig:necktie-plot-apace">Figure 3.6</a>.</p>
<figure>
<img src="figures/necktie-plot-apace.svg" id="fig:necktie-plot-apace" alt="Figure 3.6: Necktie plot - The region of quadrupole configurations leading to a stable lattice has the shape of a necktie" /><figcaption aria-hidden="true">Figure 3.6: Necktie plot - The region of quadrupole configurations leading to a stable lattice has the shape of a necktie</figcaption>
</figure>
<p>In the last example, we will use a more complex lattice. Lattices can not only be constructed manually as shown above but also loaded from a lattice file. The developed code can load lattice files in the LatticeJSON format, discussed in more detail in the next section, and all formats where converters to the LatticeJSON format exist. At the time of this thesis, these are the elegant and MAD-X lattice file formats.</p>
<p>The <code>ap.Lattice.from_file</code> method can be used to create a <code>Lattice</code> object from a file. The argument can be a local path or the URL to the lattice file. In our case, we use this function to load the BESSY II standard user lattice from a URL.</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>url <span class="op">=</span> <span class="st">&quot;https://raw.githubusercontent.com/andreasfelix/master-thesis/main/code/demo/accelerator-model/bessy2_stduser.json&quot;</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>bessy2 <span class="op">=</span> ap.Lattice.from_file(url)</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>twiss <span class="op">=</span> ap.Twiss(bessy2)</span></code></pre></div>
<p>We obtain a reference to an individual element by passing its name to the BESSY II <code>Lattice</code> object. In this case, we want a reference to the Q5 quadrupole in the T2 section.</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>q5t2 <span class="op">=</span> bessy2[<span class="st">&quot;Q5T2&quot;</span>]</span></code></pre></div>
<p>Besides the beta and dispersion functions, the <code>Twiss</code> has attributes for the tunes, alpha and gamma functions, emittance, natural chromaticity, and synchrotron radiation integrals. For example, the horizontal and vertical tunes of the BESSY II standard user lattices are given:</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;&gt;&gt;</span> twiss.tune_x, twiss.tune_y</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>(<span class="fl">17.830955250872567</span>, <span class="fl">6.725123956032014</span>)</span></code></pre></div>
<p>Also, attributes like the tunes, which depend on the strength of the quadrupoles, are automatically updated when a magnet is changed. For example, reducing the strength of the Q5T2 quadrupole leads to a slightly lower horizontal but slightly larger vertical tune:</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;&gt;&gt;</span> q5t2.k1 <span class="op">-=</span> <span class="fl">0.1</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;&gt;&gt;</span> twiss.tune_x, twiss.tune_y</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>(<span class="fl">17.80617444219928</span>, <span class="fl">6.745445862447529</span>)</span></code></pre></div>
<p>Finally, the <code>stable</code> attribute indicates if a lattice fulfills the stability condition, defined by <a href="#eq:stability-condition">Equation 2.40</a>.</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;&gt;&gt;</span> twiss.stable</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="va">True</span></span></code></pre></div>
<p>Turning off the Q5T2 quadrupole leads to an unstable lattice.</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;&gt;&gt;</span> q5t2.k1 <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;&gt;&gt;</span> twiss.stable</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a><span class="va">False</span></span></code></pre></div>
<p>How to achieve a working machine with the Q5T2 quadrupoles turned off is discussed in <a href="#sec:q5t2off-bessy-vsr-optics">Section 4.1</a>.</p>
</section>
<section id="sec:latticejson" class="level2" data-number="3.5">
<h2 data-number="3.5"><span class="header-section-number">3.5</span> LatticeJSON: An Attempt towards a Universal Lattice File Format</h2>
<p>The definition of the magnetic lattice is stored in a so-called lattice file. There are several of these data formats, and often only their corresponding simulation software can process them. The variety of lattice file formats is such a big issue of the accelerator physics community that it even has its dedicated Wikipedia section <span class="citation" data-cites="lattice-file-issues"><a href="#ref-lattice-file-issues" role="doc-biblioref">[37]</a></span>. Several converters between these files can do the heavy lifting but often still require manual adjustments made by a human. Nevertheless, even if the lattice file is available in all common formats, there is still no straightforward way to load the data into an arbitrary programming language. As the most mature accelerator simulation codes come bundled with a scripting language and optimization routines, this was a lesser problem in the past. However, there has been an uprise of powerful scripting languages and modern optimization libraries in the last several years. To leverage these tools, it would be is necessary to have convenient access to the lattice data.</p>
<p>One solution would be to write a robust parser for an existing lattice file format. Candidates would be the MAD-X <span class="citation" data-cites="madx"><a href="#ref-madx" role="doc-biblioref">[8]</a></span> or elegant <span class="citation" data-cites="elegant"><a href="#ref-elegant" role="doc-biblioref">[9]</a></span> lattice file formats, which are very similar but not compatible. Both file formats have the problem that their syntax is ambiguous. Without further context, the parser cannot infer an attribute type. For example in</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode txt"><code class="sourceCode default"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>TWISS, FILE=optics;</span></code></pre></div>
<p><code>optics</code> is a string and not a variable name. In another case</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode txt"><code class="sourceCode default"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>RFC: RFCAVITY, HARMON=num;</span></code></pre></div>
<p><code>num</code> refers to a variable and not a string. In these cases, the parser has to know the type of <code>FILE</code> and <code>HARMON</code> to parse the file correctly, making implementing a parser non-trivial. Both lattice file formats also support variables and arithmetic expressions. MAD-X even supports more advanced constructs like loops, macros, and if-else statements, making implementing such a parser even more complex and error-prone. If the goal is to be 100% compatible, one would have to reimplement a whole programming language to load the lattice data. A more feasible solution would be to define a restricted subset of the MAD-X input file, which would contain only data and no logic. <a href="#sec:elegant-grammar">Section 10.1</a> and <a href="#sec:madx-grammar">Section 10.2</a> contain grammar files allowing to load simple elegant and a subset of MAD-X lattice files into Python. They work for simple cases but fail for more advanced lattice files because of the reasons mentioned above.</p>
<p>A better solution for a plain lattice data format would be to define a schema for an existing data format, which already has parsers implemented for the most popular programming languages. One attempt of such a universal lattice file format was the Accelerator Markup language (AML) <span class="citation" data-cites="aml"><a href="#ref-aml" role="doc-biblioref">[38]</a></span> and the Universal Accelerator Parser (UAP) <span class="citation" data-cites="uap"><a href="#ref-uap" role="doc-biblioref">[39]</a></span>. The AML is based on the eXtensible Markup Language (XML), which is syntactically similar to HTML, the standard markup language for web documents. AML’s goal was to support the evaluation of arithmetic expressions and two different representations of the magnetic lattice: An <em>unevaluated representation</em> containing nested sub-lattices and variables and a <em>flat representation</em>, where the sub-lattices are expanded into a flattened array of elements. Furthermore, it aimed to support information beyond the lattice description, like control system configurations, magnet history, or other documentary data. This way, AML could be used as an all-in-one solution for an accelerator facility database. Unfortunately, as of March 2020, AML and the UAP are no longer maintained.</p>
<p>The AML had high ambitions, which made it challenging to implement: The number of features, like variables and a complex representation of the magnetic lattice, made it, even though it is based on XML, necessary to implement a custom parser for every programming language.</p>
<p>This thesis takes a simpler approach: The lattice file should not implement variables or other dependency relations. This functionality is already available in programming languages and should not be reimplemented in the lattice file. The definition of a lattice file should not rely on different representations of the magnetic lattice. The lattice file should be easy to load and should not require an additional parser. The primary target of this lattice file should be simulation codes, and the implementation should not be made more complicated by making it suitable for control system usage.</p>
<p>Further requirements are: The lattice file format should be independent of the simulation tool and programming language. The underlying file format should be commonly used, so there is no need to implement it for different programming languages. Furthermore, it should be easy to generate elegant and MAD-X files from this intermediate format. Finally, shown in <a href="#fig:lattice-tree">Figure 3.4</a>, the magnetic lattice has a tree-like structure: It consists of different elements, like drifts, magnets, cavities, and sub-lattices, which in turn consist of other elements. A universal lattice file format should take this structure into account.</p>
<p>Storing the description of the magnetic lattice raises effectively two questions (<a href="#fig:lattice-representation">Figure 3.7</a>):</p>
<ol type="1">
<li>How to store the lattice file persistently on disk?</li>
<li>How to represent the lattice file within a programming language?</li>
</ol>
<p>As data structures and object types vary between programming languages, it is impossible to choose arbitrary data types. However, practically every programming language supports primitives like <em>strings</em>, <em>numbers</em>, <em>bools</em>, <em>null</em>, and some containers structures like <em>arrays</em> and <em>key-value stores</em>. So the goal should be to provide a consistent way to represent the information stored in the lattice files using these generic data types. This representation should not try to invent the next scripting language, but it should be a pure data format. That way, the lattice data can be used by any programming language.</p>
<figure>
<img src="figures/lattice-representation.svg" id="fig:lattice-representation" alt="Figure 3.7: The lattice file has to be stored on disk. Therefore the representation of the lattice file within the programming language has to be serialized into a format that can be stored permanently. Conversely, this persistent data format has to be deserialized into a data structure when the lattice is loaded into a program." /><figcaption aria-hidden="true">Figure 3.7: The lattice file has to be stored on disk. Therefore the representation of the lattice file within the programming language has to be serialized into a format that can be stored permanently. Conversely, this persistent data format has to be deserialized into a data structure when the lattice is loaded into a program.</figcaption>
</figure>
<p>Fortunately, these issues are already solved by JSON <span class="citation" data-cites="json"><a href="#ref-json" role="doc-biblioref">[40]</a></span>, which is an acronym for JavaScript Object Notation. Even though it has its origins in JavaScript, it is a language-independent and open data file format. It can describe complex data and is the de-facto standard for exchanging data between web applications. There already exist a huge amount of tools for validating and working with JSON.</p>
<p>JSON answers both questions as the is a 1:1 correspondence between JSON data types and the generic data types available in almost all programming languages. Once parsed, the lattice description is represented by the same abstraction of data types as when the lattice information was stored on disk. One problem of AML was, that the parsed lattice data, returned by the UAP, had a different structure than the stored XML file. So there were effectively two different representations of the same information.</p>
<p>JSON provides a convenient way to serialize and deserialize generic data types. To make use of JSON, the description of the magnetic lattice has still to be defined in terms of these generic data types. Such a definition can be achieved with a so-called JSON schema <span class="citation" data-cites="json-schema"><a href="#ref-json-schema" role="doc-biblioref">[41]</a></span>. A first definition of such a JSON-based lattice file format was done and called LatticeJSON. The LatticeJSON schema file and more information on LatticeJSON are available at <span class="citation" data-cites="lattice-json"><a href="#ref-lattice-json" role="doc-biblioref">[42]</a></span>.</p>
<p>For example, the definition of a FODO lattice as LatticeJSON file is given by:</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;version&quot;</span><span class="fu">:</span> <span class="st">&quot;2.2&quot;</span><span class="fu">,</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;title&quot;</span><span class="fu">:</span> <span class="st">&quot;FODO Lattice&quot;</span><span class="fu">,</span></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;info&quot;</span><span class="fu">:</span> <span class="st">&quot;This is the simplest possible strong focusing lattice.&quot;</span><span class="fu">,</span></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;root&quot;</span><span class="fu">:</span> <span class="st">&quot;ring&quot;</span><span class="fu">,</span></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;elements&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;d1&quot;</span><span class="fu">:</span> <span class="ot">[</span><span class="st">&quot;Drift&quot;</span><span class="ot">,</span> <span class="fu">{</span><span class="dt">&quot;length&quot;</span><span class="fu">:</span> <span class="fl">0.55</span><span class="fu">}</span><span class="ot">]</span><span class="fu">,</span></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;q1&quot;</span><span class="fu">:</span> <span class="ot">[</span><span class="st">&quot;Quadrupole&quot;</span><span class="ot">,</span> <span class="fu">{</span><span class="dt">&quot;length&quot;</span><span class="fu">:</span> <span class="fl">0.2</span><span class="fu">,</span> <span class="dt">&quot;k1&quot;</span><span class="fu">:</span> <span class="fl">1.2</span><span class="fu">}</span><span class="ot">]</span><span class="fu">,</span></span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;q2&quot;</span><span class="fu">:</span> <span class="ot">[</span><span class="st">&quot;Quadrupole&quot;</span><span class="ot">,</span> <span class="fu">{</span><span class="dt">&quot;length&quot;</span><span class="fu">:</span> <span class="fl">0.4</span><span class="fu">,</span> <span class="dt">&quot;k1&quot;</span><span class="fu">:</span> <span class="fl">-1.2</span><span class="fu">}</span><span class="ot">]</span><span class="fu">,</span></span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;b1&quot;</span><span class="fu">:</span> <span class="ot">[</span><span class="st">&quot;Dipole&quot;</span><span class="ot">,</span> <span class="fu">{</span><span class="dt">&quot;length&quot;</span><span class="fu">:</span> <span class="fl">1.5</span><span class="fu">,</span> <span class="dt">&quot;angle&quot;</span><span class="fu">:</span> <span class="fl">0.392701</span><span class="fu">,</span> <span class="dt">&quot;e1&quot;</span><span class="fu">:</span> <span class="fl">0.1963505</span><span class="fu">,</span> <span class="dt">&quot;e2&quot;</span><span class="fu">:</span> <span class="fl">0.1963505</span><span class="fu">}</span><span class="ot">]</span></span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">},</span></span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;lattices&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;cell&quot;</span><span class="fu">:</span> <span class="ot">[</span><span class="st">&quot;q1&quot;</span><span class="ot">,</span> <span class="st">&quot;d1&quot;</span><span class="ot">,</span> <span class="st">&quot;b1&quot;</span><span class="ot">,</span> <span class="st">&quot;d1&quot;</span><span class="ot">,</span> <span class="st">&quot;q2&quot;</span><span class="ot">,</span> <span class="st">&quot;d1&quot;</span><span class="ot">,</span> <span class="st">&quot;b1&quot;</span><span class="ot">,</span> <span class="st">&quot;d1&quot;</span><span class="ot">,</span> <span class="st">&quot;q1&quot;</span><span class="ot">]</span><span class="fu">,</span></span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;ring&quot;</span><span class="fu">:</span> <span class="ot">[</span><span class="st">&quot;cell&quot;</span><span class="ot">,</span> <span class="st">&quot;cell&quot;</span><span class="ot">,</span> <span class="st">&quot;cell&quot;</span><span class="ot">,</span> <span class="st">&quot;cell&quot;</span><span class="ot">,</span> <span class="st">&quot;cell&quot;</span><span class="ot">,</span> <span class="st">&quot;cell&quot;</span><span class="ot">,</span> <span class="st">&quot;cell&quot;</span><span class="ot">,</span> <span class="st">&quot;cell&quot;</span><span class="ot">]</span></span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">}</span></span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
<p>To read the quadrupole strength of the Q1 quadrupole in Python, one can use:</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> json</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="bu">open</span>(<span class="st">&quot;/path/to/lattice.json&quot;</span>) <span class="im">as</span> <span class="bu">file</span>:</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>    lattice <span class="op">=</span> json.load(<span class="bu">file</span>)</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>type_, attributes <span class="op">=</span> lattice[<span class="st">&quot;elements&quot;</span>][<span class="st">&quot;Q1&quot;</span>]</span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;Quadrupole strength&quot;</span>, attributes[<span class="st">&quot;k1&quot;</span>])</span></code></pre></div>
<p>Alternatively, one can use the LatticeJSON library, which validates the lattice file and can load lattices files from URLs.</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> latticejson</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>lattice <span class="op">=</span> latticejson.load(<span class="st">&quot;https://lattice-database.org/bessy2?mode=stduser&quot;</span>)</span></code></pre></div>
<p>The URL <em>lattice-database.io</em> is chosen as an illustrative filler in this example. However, it should be a goal to establish a central database of magnetic lattice files, where the operation mode or file format can be passed as a URL parameter. This would give physicists access to a large number of lattice files without the overhead of maintaining their own set of lattices. Furthermore, as it is straightforward to generate different versions of a JSON file automatically, LatticeJSON could simplify the implementation of such a database significantly.</p>
</section>
</section>
<section id="applications" class="level1" data-number="4">
<h1 data-number="4"><span class="header-section-number">4</span> Applications</h1>
<p>This chapter covers the applications of the developed optics simulation program. The first section comprises the development and optimization of the Q5T2-off optics of the BESSY II storage ring, which enlargens the available installation length of the cavity module of the BESSY-VSR project. The second section shows how the beta functions within a straight section of the BESSY II storage ring were adjusted for an emittance exchange experiment. Finally, the third section presents the development of a framework to automatically generate summaries for a given set of lattice files.</p>
<section id="sec:q5t2off-bessy-vsr-optics" class="level2" data-number="4.1">
<h2 data-number="4.1"><span class="header-section-number">4.1</span> Modifying the BESSY II Optics for the VSR project</h2>
<p>The motivation of enlarging the installation length for the cavity module was already set out in <a href="#sec:introduction-q5t2off-bessy-vsr-optics">Section 1.2.1</a>. One solution is to turn off the Q5 quadrupoles in the T2 section of the storage ring to gain about 0.7 meters of installation length. The first steps towards such a Q5T2off-optics are described in my bachelor’s thesis <span class="citation" data-cites="andreas_ba"><a href="#ref-andreas_ba" role="doc-biblioref">[5]</a></span>. With the best solution found, it was possible to achieve a working machine with reasonable injection efficiency and lifetime. The goal should be to improve upon this solution.</p>
<p>The following three subsections provide a summarization of my bachelor’s thesis. The first subsection gives an overview of the lattice development of the BESSY II storage ring. The second subsection discusses the constraints for the development of an optics with a turned-off Q5T2 magnet. In <a href="#sec:turning-off-the-q5t2-quadrupoles">Section 4.1.3</a>, the results of the bachelor’s thesis are presented. The fourth subsection shows how the Q5T2off-optics was further optimized using the developed code of this thesis. The last subsection summarizes the results of a user operation acceptance test of the improved Q5T2off-optics.</p>
<section id="lattice-design-of-the-bessy-storage-ring" class="level3" data-number="4.1.1">
<h3 data-number="4.1.1"><span class="header-section-number">4.1.1</span> Lattice Design of the BESSY Storage Ring</h3>
<figure>
<img src="figures/design-lattice.svg" id="fig:bessy2-design-lattice" alt="Figure 4.1: The design lattice of the BESSY II storage ring 1996. Full lattice (top), unit cell (bottom) - (extracted from [5])" /><figcaption aria-hidden="true">Figure 4.1: The design lattice of the BESSY II storage ring 1996. Full lattice (top), unit cell (bottom) - (extracted from <span class="citation" data-cites="andreas_ba"><a href="#ref-andreas_ba" role="doc-biblioref">[5]</a></span>)</figcaption>
</figure>
<div id="tbl:quadrupole-strengths-design">
<table>
<caption>Table 4.1: The quadrupole strength of the BESSY II design lattice</caption>
<thead>
<tr class="header">
<th>Magnet</th>
<th style="text-align: center;">Quadrupole strength <span class="math inline">k</span> / m²</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Q1</td>
<td style="text-align: center;">+2.45190</td>
</tr>
<tr class="even">
<td>Q2</td>
<td style="text-align: center;">-1.89757</td>
</tr>
<tr class="odd">
<td>Q3D</td>
<td style="text-align: center;">-2.02025</td>
</tr>
<tr class="even">
<td>Q4D</td>
<td style="text-align: center;">+1.40816</td>
</tr>
<tr class="odd">
<td>Q3T</td>
<td style="text-align: center;">-2.46319</td>
</tr>
<tr class="even">
<td>Q4T</td>
<td style="text-align: center;">+2.62081</td>
</tr>
<tr class="odd">
<td>Q5T</td>
<td style="text-align: center;">-2.60000</td>
</tr>
</tbody>
</table>
</div>
<p>The BESSY II storage ring has a double bend achromat lattice with 16 straight sections. The injection requires high horizontal beta functions. At the same time, the superconducting wavelength shifter needs a small horizontal beta function. That led to the decision to develop a lattice with alternating high and low horizontal beta straights <span class="citation" data-cites="latticedesignbessy2"><a href="#ref-latticedesignbessy2" role="doc-biblioref">[43]</a></span>. As a result, the 240 m storage ring has an 8-fold symmetry with the unit cell shown in <a href="#fig:bessy2-design-lattice">Figure 4.1</a>. The seven quadrupole families of the design-lattice are listed in <a href="#tbl:quadrupole-strengths-design">Table 4.1</a>.</p>
<p>The two horizontal focusing Q1 quadrupoles in the center of the DBA reverse the gradient of the dispersion function as discussed in <a href="#sec:the-dba-lattice">Section 2.6.2</a>. The two vertical focusing Q2 quadrupoles are necessary to limit the vertical beam size. The high beta straights have the quadrupole doublet Q3D and Q4D, which are vertical and horizontal focusing, respectively. The low beta straights have the vertical focusing Q3T, horizontal focusing Q4T, and vertical focusing Q5T quadrupole families, which form a triplet. In order to achieve the low horizontal beta function, the Q4T quadrupoles must be significantly stronger than the Q4D quadrupoles. The additional Q5T quadruples are needed to compensate for the stronger vertical defocusing introduced by the Q4T quadrupoles.</p>
<figure>
<img src="figures/bessy-emil-femto-slicing.svg" id="fig:bessy-emil-femto-slicing" alt="Figure 4.2: The Twiss parameters in D6 (Emil) and T6 (femto slicing) straights (extracted from [5])" /><figcaption aria-hidden="true">Figure 4.2: The Twiss parameters in D6 (Emil) and T6 (femto slicing) straights (extracted from <span class="citation" data-cites="andreas_ba"><a href="#ref-andreas_ba" role="doc-biblioref">[5]</a></span>)</figcaption>
</figure>
<p>Turning off the Q5T2 quadrupoles means turning the T2 triplet section into another doublet section. As the BESSY II storage ring has undergone several modifications since the design lattices from 1996, there are additional constraints that have to be taken into account:</p>
<p>Since 2005, a femto-slicing facility, producing ultra-short x-ray pulses, is commissioned in the D6 section of the BESSY II storage ring <span class="citation" data-cites="femto1 femto2"><a href="#ref-femto1" role="doc-biblioref">[44]</a>, <a href="#ref-femto2" role="doc-biblioref">[45]</a></span>. A femtosecond laser pulse modulates the electron energy in a wiggler called the modulator. The off-momentum electrons are extracted by the transverse displacement of a bending magnet, and the synchrotron radiation is emitted in the following undulator called the radiator. This femto-slicing experiment required the installation of three additional bending magnets, which together form a dipole chicane, the wiggler U139, and the undulator UE56. Another significant alteration of the BESSY II storage ring was carried out as part of the EMIL project <span class="citation" data-cites="emil1"><a href="#ref-emil1" role="doc-biblioref">[46]</a></span>, which is dedicated to researching materials for renewable energy. It provides multiple beamlines with simultaneous access to soft and hard x-rays. These are provided by the two UE-48 and CPMU-17 undulators, which are canted to separate the generated beam cones. In order to support this setup of the two canted undulators, the vertical focusing quadrupole QIT6 was installed in the center of the T6 straight, which shifts the vertical beam waist to the center of the CPMU-17 device. The Twiss parameters in D6 (Emil) and T6 (femto-slicing) straights are shown in <a href="#fig:bessy-emil-femto-slicing">Figure 4.2</a>.</p>
<p>Another modification of the BESSY II storage ring was the introduction of the so-called injection optics <span class="citation" data-cites="kuskeli"><a href="#ref-kuskeli" role="doc-biblioref">[47]</a></span>: The horizontal beta function <span class="math inline">\beta_x</span> was increased in the injection-straight D1 and decreased in all other doublet straights to improve the injection efficiency.</p>
</section>
<section id="sec:q5t2off-constraints" class="level3" data-number="4.1.2">
<h3 data-number="4.1.2"><span class="header-section-number">4.1.2</span> Constraints for the Development of the Q5T2off-optics</h3>
<p>The Twiss parameters of the BESSY II storage ring were carefully tuned to support the mentioned changes. New modifications should not conflict with the lattice development of the last several years. Therefore, when turning off the Q5T2 quadrupoles, it should be made sure that the changes are as local as possible with respect to the T2 section, and perturbations of the Twiss parameters outside of the T2 should be as small as possible.</p>
<figure>
<img src="figures/beta-function-in-t2.svg" id="fig:beta-function-in-t2" alt="Figure 4.3: The horizontal and vertical beta functions \beta_{x,y} of the current standard user lattice. The value of has to be kept below 4 m to avoid coupled bunch instabilities (based on [1] and extracted from [5])" /><figcaption aria-hidden="true">Figure 4.3: The horizontal and vertical beta functions <span class="math inline">\beta_{x,y}</span> of the current standard user lattice. The value of has to be kept below 4 m to avoid coupled bunch instabilities (based on <span class="citation" data-cites="ruprecht-phd"><a href="#ref-ruprecht-phd" role="doc-biblioref">[1]</a></span> and extracted from <span class="citation" data-cites="andreas_ba"><a href="#ref-andreas_ba" role="doc-biblioref">[5]</a></span>)</figcaption>
</figure>
<p>The VSR cavities set another requirement for the Q5T2off-optics. As addressed by <span class="citation" data-cites="ruprecht-phd"><a href="#ref-ruprecht-phd" role="doc-biblioref">[1]</a></span> beam-cavity interactions can cause coupled bunch instabilities, which spoil the beam quality. For a fixed threshold transverse cavity impedance</p>
<div>
<table style="width:99%;">
<colgroup>
<col style="width: 90%" />
<col style="width: 9%" />
</colgroup>
<tbody>
<tr class="odd">
<td style="text-align: center;"><span class="math display">
Z_\mathrm{th}^{\perp}(\tau_{\mathrm{d}}^{-1}) = \frac{\tau_\mathrm{d}^{-1}}{\beta} \frac{4 \pi E / e}{\omega_\mathrm{rev} I_\mathrm{DC}}
</span></td>
<td style="text-align: right;"><span class="math display">(4.1)</span></td>
</tr>
</tbody>
</table>
</div>
<p>the average beam current <span class="math inline">I_{\mathrm{DC}}</span> is determined by the energy <span class="math inline">E</span>, the damping rate <span class="math inline">\tau_{\mathrm{d}}^{-1}</span>, the angular beam revolution frequency <span class="math inline">\omega_\mathrm{rev}</span> and the value of the beta function <span class="math inline">\beta</span> within the cavity. As the requirements of the users of the synchrotron radiation restrain the energy <span class="math inline">E</span>, the circumference of the ring defines the angular beam revolution frequency <span class="math inline">\omega_\mathrm{rev}</span> and increasing the damping rate <span class="math inline">\tau_{\mathrm{d}}^{-1}</span> might conflict with aspects of the machine operation, the value of the beta function within the cavity module effectively limits the average beam current <span class="math inline">I_{\mathrm{DC}}</span>. By the estimations of <span class="citation" data-cites="ruprecht-phd"><a href="#ref-ruprecht-phd" role="doc-biblioref">[1, p. 83]</a></span>, a beta function of below 4 m within the cavity module would be sufficient to store the required current.</p>
<figure>
<img src="figures/beta-t2-max-average.svg" id="fig:beta-t2-max-average" alt="Figure 4.4: Maxium and average beta functions \beta_{x,y} at the 1.50 GHz and 1.75 GHz cavites as a function of the minimum beta function \beta_{min} (based on [M. Ries, priv. comm., 2017] and extracted from [5])" /><figcaption aria-hidden="true">Figure 4.4: Maxium and average beta functions <span class="math inline">\beta_{x,y}</span> at the 1.50 GHz and 1.75 GHz cavites as a function of the minimum beta function <span class="math inline">\beta_{min}</span> (based on [M. Ries, priv. comm., 2017] and extracted from <span class="citation" data-cites="andreas_ba"><a href="#ref-andreas_ba" role="doc-biblioref">[5]</a></span>)</figcaption>
</figure>
<p>Assuming a symmetry point, the beta function <span class="math inline">\beta(s)</span> at the distance from the center of T2 is fully defined by the minimum beta function <span class="math inline">\beta_{min}</span> at symmetry point:</p>
<div id="eq:beta-function-at-symmetry">
<table style="width:99%;">
<colgroup>
<col style="width: 90%" />
<col style="width: 9%" />
</colgroup>
<tbody>
<tr class="odd">
<td style="text-align: center;"><span class="math display"> \beta(s) = \beta_{\mathrm{min}} + \frac{s^2}{\beta_{\mathrm{min}}}
</span></td>
<td style="text-align: right;"><span class="math display">(4.2)</span></td>
</tr>
</tbody>
</table>
</div>
<p>Therefore it is possible to calculate the required minimum beta function <span class="math inline">\beta_{min}</span> to keep the beta function belows 4 m within the cavity moduel. <a href="#fig:beta-t2-max-average">Figure 4.4</a> shows the maximum and average beta function at the 1.50 GHz and 1.75 GHz cavities as a function of the minimum beta function <span class="math inline">\beta_{\mathrm{min}}</span>. A minimum beta function <span class="math inline">\beta_{\mathrm{min}}</span> between 0.6 m and 3.4 m is sufficient to keep the average beta below 4 m. A minimum beta function <span class="math inline">\beta_{\mathrm{min}}</span> between 1 m and 2 m would be optimal to keep the average beta function within the cavity module as small as possible.</p>
</section>
<section id="sec:turning-off-the-q5t2-quadrupoles" class="level3" data-number="4.1.3">
<h3 data-number="4.1.3"><span class="header-section-number">4.1.3</span> Turning off the Q5T2 Quadrupoles</h3>
<p>As stated above, the goal is to minimize the beta functions’ perturbation compared to the current standard user optics and keep the changes as local as possible. This can be accomplished by an optimizer that minimizes a fitness function chosen to satisfy the stated objective. However, the fact that not all quadruple settings result in a stable lattice poses a unique challenge: As an unstable quadrupole setting has no solution, all of them are equally bad. Therefore, choosing an objective function that provides a practical value to the optimizer in such a case is not easy. It seems reasonable to return a high constant or infinity. However, this leads to a problem when starting an optimizer in a region of unstable quadrupole settings. Usually, all other quadrupole settings in configuration space in the direct vicinity of an unstable lattice configuration are unstable as well. Therefore, the objective function always returns the same value regardless of which direction the optimizer chooses in the configuration space. Thus, the optimizer is practically left in the dark, and the possibility to converge is left to chance.</p>
<p>Just switching off the Q5T2 quadrupoles in the current standard user optics leads to an unstable lattice. That means that a quadrupole setting with only the Q5T2 quadrupoles turned off cannot be used as a starting configuration for optimization. So first, a stable lattice configuration has to be found, which can then be further improved by an optimizer.</p>
<p>A reasonable approach seems to start by only using quadrupoles in the T2 section to find a stable quadrupole setting. This was directly tested at the machine and also afterward checked by doing a quadrupole scan in simulations. The stability condition of the Twiss parameters</p>
<div id="eq:stabilty-requirement">
<table style="width:99%;">
<colgroup>
<col style="width: 90%" />
<col style="width: 9%" />
</colgroup>
<tbody>
<tr class="odd">
<td style="text-align: center;"><span class="math display"> 2 - R_{11}^2 - 2 R_{12} R_{21} - R_{22}^2 &gt; 0
</span></td>
<td style="text-align: right;"><span class="math display">(4.3)</span></td>
</tr>
</tbody>
</table>
</div>
<p>was derived in <a href="#sec:transformation-twiss-parameter">Section 2.3.3</a>. The quadrupole scan in <a href="#fig:stability-q3-q4">Figure 4.5</a> shows the stable regions for different settings of the Q3T2, Q4T2, and Q5T2 magnets.</p>
<figure>
<img src="figures/stability-q3-q4.svg" id="fig:stability-q3-q4" alt="Figure 4.5: The stability of the BESSY II storage ring lattices for different configurations of the quadrupoles in the T2 section. Areas where no stable solution of the Twiss parameters exists, are shaded with diagonal lines. The left plot shows the different quadrupole configurations of the Q5T2 and the Q3T2 quadrupoles. The right plot shows the different quadrupole configurations of the Q5T2 and the Q4T2 quadrupoles. The current standard user optics is marked in red. The blue cross marks the attempt to compensate the turn-off solely with the Q3T2 quadrupoles, which eventually led to an unstable lattice. A stable solution, compensated by the decrease of the Q4T2s quadrupole strength, is shown in green. (extracted from [5])" /><figcaption aria-hidden="true">Figure 4.5: The stability of the BESSY II storage ring lattices for different configurations of the quadrupoles in the T2 section. Areas where no stable solution of the Twiss parameters exists, are shaded with diagonal lines. The left plot shows the different quadrupole configurations of the Q5T2 and the Q3T2 quadrupoles. The right plot shows the different quadrupole configurations of the Q5T2 and the Q4T2 quadrupoles. The current standard user optics is marked in red. The blue cross marks the attempt to compensate the turn-off solely with the Q3T2 quadrupoles, which eventually led to an unstable lattice. A stable solution, compensated by the decrease of the Q4T2s quadrupole strength, is shown in green. (extracted from <span class="citation" data-cites="andreas_ba"><a href="#ref-andreas_ba" role="doc-biblioref">[5]</a></span>)</figcaption>
</figure>
<p>At the machine, the first idea was to use the other vertical focusing Q3T2 quadrupoles to compensate for the turn-off of the Q5T2 quadrupoles. Increasing the Q3T2 quadrupoles made it possible to slightly more decrease the Q5T2 quadrupoles. However, at about 94 % of the initial strength of the Q5T2 quadrupoles, the beam was lost. That seems to be consistent with the results of the quadrupole scan. The blue cross in <a href="#fig:stability-q3-q4">Figure 4.5</a> marks this unstable quadrupole setting.</p>
<p>The next idea was to compensate for the turn-off of the Q5T2 quadrupoles by reducing the strength of the vertical defocusing Q4T2 quadrupoles. That led to a working machine but resulted in a very low injection efficiency. <a href="#fig:q5t2off-v1">Figure 4.6</a> shows the Twiss parameters where only the Q3T2 and Q4T2 quadrupoles were changed to compensate for the turn-off of the Q5T2 magnets. Compared to the standard user optics, the perturbation of the beta functions is significant all around the ring, which probably led to the low injection efficiency. In particular, the vertical beta function increases substantially in the T1, T3, and T6 sections.</p>
<figure>
<img src="figures/twiss_ba_q5t2off_v1_sim_vs_std_cropped.svg" id="fig:q5t2off-v1" alt="Figure 4.6: Beta functions with turned off Q5T2 quadrupoles compensated with the Q3T and Q4T quadrupoles of the T2 section (highlighted in blue). The Twiss parameters of the current standard user are shown in comparison with a dashed line." /><figcaption aria-hidden="true">Figure 4.6: Beta functions with turned off Q5T2 quadrupoles compensated with the Q3T and Q4T quadrupoles of the T2 section (highlighted in blue). The Twiss parameters of the current standard user are shown in comparison with a dashed line.</figcaption>
</figure>
<p>The first and most local solution provides a starting point to improve the optics further using an optimizer. The average relative change of the beta function</p>
<div id="eq:objectiv-function-bachelor">
<table style="width:99%;">
<colgroup>
<col style="width: 90%" />
<col style="width: 9%" />
</colgroup>
<tbody>
<tr class="odd">
<td style="text-align: center;"><span class="math display"> F(\beta) = \frac{1}{L} \int_0^L \frac{\beta(s)}{\beta_{\mathrm{ref}}(s)}\mathrm{d}s
</span></td>
<td style="text-align: right;"><span class="math display">(4.4)</span></td>
</tr>
</tbody>
</table>
</div>
<p>was chosen as the objective function. Different combinations of quadrupoles were used to compensate for the turn-off of the Q5T2 quadrupoles. Motivation for selecting the different quadrupole sets and a detailed overview of the solutions can be found in my bachelor thesis <span class="citation" data-cites="andreas_ba"><a href="#ref-andreas_ba" role="doc-biblioref">[5]</a></span>. <a href="#fig:q5t2off-v4">Figure 4.7</a> shows the best solution obtained within the scope of the bachelor thesis. The optics was tested at the storage ring, and a high current with reasonable lifetime and injection efficiency was stored.</p>
<figure>
<img src="figures/twiss_ba_q5t2off_sim_vs_std.svg" id="fig:q5t2off-v4" alt="Figure 4.7: Twiss parameters of the best solution of my bachelor’s thesis (solid) in comparison to the standard user optics (dashed)." /><figcaption aria-hidden="true">Figure 4.7: Twiss parameters of the best solution of my bachelor’s thesis (solid) in comparison to the standard user optics (dashed).</figcaption>
</figure>
</section>
<section id="sec:optimizing-the-q5t2off-optics" class="level3" data-number="4.1.4">
<h3 data-number="4.1.4"><span class="header-section-number">4.1.4</span> Optimizing the Q5T2off-optics in Simulations</h3>
<p>As stated in the conclusion of my bachelor’s thesis, further improvements to the optics are necessary: First, the presented solution has a non-negligible <span class="math inline">\beta</span>-beat outside of the T2 section. The standard user optics is fine-tuned in the injection straight, EMIL and, femto-slicing sections. Therefore, changes introduced by the Q5T2off optics should be as local as possible to avoid conflicting with previously made considerations. The goal is to limit the <span class="math inline">\beta</span>-beat to the T2 and its adjacent neighboring sections. Another issue is that the vertical beta function in the center of the T2 section is with 3.6 m still too high. As stated before, the minimum beta function must be a least 3.4 m and would optimally be between one and two meters. Furthermore, the optics have to be further optimized regarding the non-linear dynamics. Different sextupole settings can be used to optimize the momentum acceptance.</p>
<p>Adjusting the objective function can reduce the <span class="math inline">\beta</span>-beat. My bachelor’s thesis used the mean relative residual of the beta function. That meant that a change from 4 m to 2 m corresponding to -50 % had the same weight as a change from 20 m to 30 m (+50 %). Therefore, this incentivized the optimizer to reduce the beta function below the value of the standard user optics at certain positions, resulting in a larger <span class="math inline">\beta</span>-beat. This can be solved by composing the relative change of the beta function <span class="math inline">\frac{\beta(s)}{\beta_\mathrm{ref}(s)}</span> with a rectified linear unit (ReLU) function <span class="math inline">R(x) = \mathrm{max}(1,x)</span>, which maps every value below one to one. This has the effect of a lower threshold, which disincentivizes to lower the beta function below the reference value at the expense of making it larger somewhere else. Larger changes can be more disincentivized by squaring the relative change. To ensure the vertical beta function <span class="math inline">\beta_\mathrm{y}</span> is small enough at the center of the T2 section <span class="math inline">s_\mathrm{T2}</span>, it can be included in the objective function.</p>
<p>Taking the mentioned considerations into account, leads to the new objective function:</p>
<div id="eq:objectiv-function">
<table style="width:99%;">
<colgroup>
<col style="width: 90%" />
<col style="width: 9%" />
</colgroup>
<tbody>
<tr class="odd">
<td style="text-align: center;"><span class="math display"> F(\beta) = \frac{1}{L} \int_0^L R\left(\frac{\beta(s)}{\beta_\mathrm{ref}(s)}\right)^2 \mathrm{d}s + \beta_\mathrm{y}(s_\mathrm{T2}) \:\: \textrm{with } R(x) = \begin{cases} 1, &amp;\textrm{for } x &lt; 1\\ x, &amp;\textrm{else} \end{cases}
</span></td>
<td style="text-align: right;"><span class="math display">(4.5)</span></td>
</tr>
</tbody>
</table>
</div>
<p>With the developed code, this roughly translates to:</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> objective_function(values, quads):</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> quad, value <span class="kw">in</span> <span class="bu">zip</span>(quads, values):</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>        quad.k1 <span class="op">=</span> value</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> twiss.stable:</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> np.inf</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>    beta_beat_x <span class="op">=</span> np.maximum(<span class="dv">1</span>, twiss.beta_x <span class="op">/</span> twiss_ref.beta_x) <span class="op">**</span> <span class="dv">2</span></span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>    beta_beat_y <span class="op">=</span> np.maximum(<span class="dv">1</span>, twiss.beta_y <span class="op">/</span> twiss_ref.beta_y) <span class="op">**</span> <span class="dv">2</span></span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> np.mean([beta_beat_x, beta_beat_y]) <span class="op">+</span> twiss.beta_y[t2_center]</span></code></pre></div>
<p>The optimization procedure was run for different combinations of quadrupoles. Due to the improvements made to the Twiss calculation code, it was now possible to do much more iterations in a much shorter time. Furthermore, it was possible to run the optimization procedure multiple times in a row, using the last optimization result as a starting point for the next. <a href="#fig:twiss_q5t2off_sim_vs_std">Figure 4.8</a> shows the Twiss parameters of the best obtained Q5T2off optics compared to the current standard user optics. A complete code snippet that reproduces the Q5T2off optics and explanation is included in the <a href="#sec:code-to-reproduce-q5t2off-optics">Section 7</a>.</p>
<figure>
<img src="figures/twiss_q5t2off_sim_vs_std.svg" id="fig:twiss_q5t2off_sim_vs_std" alt="Figure 4.8: Twiss parameters of the best Q5T2off optics (solid) in comparison to the current standard user optics (dashed)" /><figcaption aria-hidden="true">Figure 4.8: Twiss parameters of the best Q5T2off optics (solid) in comparison to the current standard user optics (dashed)</figcaption>
</figure>
<p><a href="#fig:q5t2off_ba_vs_ma.svg">Figure 4.9</a> shows the <span class="math inline">\beta</span>-beat of the new Q5T2off optics compared to the old Q5T2off optics. The old Q5T2off optics has a high horizontal <span class="math inline">\beta_\mathrm{x}</span>-beat in the injection straight and a high vertical <span class="math inline">\beta_\mathrm{y}</span>-beat all around the ring, including the femto-slicing section D6 and EMIL section T6. With the improvements to the Q5T2off optics, the <span class="math inline">\beta</span>-beat outside of T2 and its adjacent sections is effectively negligible. For the horizontal plane, the changes within the T2 and its adjacent sections are primarily negative. For the vertical plane, there are two peaks at the beginning of the adjacent DBA. Furthermore, the vertical beta function at the center of the T2 section was reduced from 3.6 m to 1.8 m.</p>
<figure>
<img src="figures/q5t2off_ba_vs_ma.svg" id="fig:q5t2off_ba_vs_ma.svg" alt="Figure 4.9: Beta beat of the Q5T2off optics with the standard user optics (blue) compared to the beta beat of the best solution of the bachelors thesis (orange)" /><figcaption aria-hidden="true">Figure 4.9: Beta beat of the Q5T2off optics with the standard user optics (blue) compared to the beta beat of the best solution of the bachelors thesis (orange)</figcaption>
</figure>
</section>
<section id="sec:user-acceptance-test" class="level3" data-number="4.1.5">
<h3 data-number="4.1.5"><span class="header-section-number">4.1.5</span> User Operation Acceptance Test of the Q5T2 Optics</h3>
<p>With improvements made to the Q5T2off optics, the following steps are to transfer the optics to the machine and test if it is ready for standard user operation. According to <span class="citation" data-cites="hinterberger"><a href="#ref-hinterberger" role="doc-biblioref">[18]</a></span>, the quadrupole strength is proportional to the current <span class="math inline">I</span></p>
<div id="eq:k-prop-to-I">
<table style="width:99%;">
<colgroup>
<col style="width: 90%" />
<col style="width: 9%" />
</colgroup>
<tbody>
<tr class="odd">
<td style="text-align: center;"><span class="math display"> k \approx 2 \frac{\mu_0 n I}{a^2} \frac{q}{p} \propto I,
</span></td>
<td style="text-align: right;"><span class="math display">(4.6)</span></td>
</tr>
</tbody>
</table>
</div>
<p>where <span class="math inline">\mu_0</span> is the vacuum permeability, <span class="math inline">a</span> is the aperture radius and <span class="math inline">n</span> corresponds to the winding number. Therefore, the new power supply values can be calculated by the ratio of the new and old quadrupole strength times the old power supply value:</p>
<div id="eq:new-ps-values">
<table style="width:99%;">
<colgroup>
<col style="width: 90%" />
<col style="width: 9%" />
</colgroup>
<tbody>
<tr class="odd">
<td style="text-align: center;"><span class="math display"> I_\mathrm{new} = \frac{k_\mathrm{new}}{k_\mathrm{old}} I_\mathrm{old}
</span></td>
<td style="text-align: right;"><span class="math display">(4.7)</span></td>
</tr>
</tbody>
</table>
</div>
<p>To make sure that the optics is transferred correctly to the machine, a precise measurement of the current quadrupole strengths <span class="math inline">k_\mathrm{old}</span> is necessary. Therefore, the Linear Optics From Closed Orbits (LOCO) method <span class="citation" data-cites="locosafranek mmlbasedloco"><a href="#ref-locosafranek" role="doc-biblioref">[48]</a>, <a href="#ref-mmlbasedloco" role="doc-biblioref">[49]</a></span> from the MatLab Middle Layer <span class="citation" data-cites="mmlpaper"><a href="#ref-mmlpaper" role="doc-biblioref">[50]</a></span> can be used to determine the linear optics. The LOCO method first measures the orbit response matrix and the dispersion function. Afterward, the data is fitted to a lattice model to calculate the individual quadrupole strengths.</p>
<p>LOCO-measuring the current standard user optics started of the machine commissioning. Then a new Q5T2off optics was fitted based on the just LOCO-measured standard user optics. Next, the new power supply values were transferred to the machine using a program developed for this purpose, shown in <a href="#sec:gui-power-supply-values">Section 8</a>. After the machine was set to the new Q5T2off optics, another LOCO measurement was carried out to ensure the optics was transferred to the machine correctly. <a href="#fig:twiss_q5t2off_loco_vs_q5t2off_sim">Figure 4.10</a> shows the Twiss parameters of the LOCO measured Q5T2off optics compared to the Twiss parameters of the Q5T2off optics obtained from the optimization. There seem to be some deviations in the horizontal beta function. Especially within some of the doublet sections, the beta function is slightly asymmetric to the center. However, the vertical beta function matches very closely with the one from the simulation. Overall, it can be said that the optics was transferred correctly. Finally, the quadrupole setting of the Q5T2off optics was saved in the control software to make it available for future machine commissions. <a href="#fig:twiss_q5t2off_loco_vs_std">Figure 4.11</a> shows the LOCO-measured Q5T2off optics compared to the current standard user optics.</p>
<figure>
<img src="figures/twiss_q5t2off_loco_vs_q5t2off_sim.svg" id="fig:twiss_q5t2off_loco_vs_q5t2off_sim" alt="Figure 4.10: Twiss parameters of loco measured Q5T2off optics (solid) in comparison to the Q5T2off optics obtained from the optimization (dashed)" /><figcaption aria-hidden="true">Figure 4.10: Twiss parameters of loco measured Q5T2off optics (solid) in comparison to the Q5T2off optics obtained from the optimization (dashed)</figcaption>
</figure>
<figure>
<img src="figures/twiss_q5t2off_loco_vs_std.svg" id="fig:twiss_q5t2off_loco_vs_std" alt="Figure 4.11: Twiss parameters of loco measured Q5T2off optics (solid) in comparison to the current standard user optics (dashed)" /><figcaption aria-hidden="true">Figure 4.11: Twiss parameters of loco measured Q5T2off optics (solid) in comparison to the current standard user optics (dashed)</figcaption>
</figure>
<p>In another machine commissioning session, the Q5T2off optics was audited for standard user operation. During this user acceptance test, several smaller checks were performed. First, a small injection with low current was done to verify that the optics was correctly restored from the control software. Then, the quadrupoles were cycled to eliminate possible hysteresis effects. The orbit correction was used to improve the orbit. Next, a high current test was carried out. The current was injected up to 250 mA with injection efficiencies between 90% to 95%.</p>
<figure>
<img src="figures/lifetime-measurement.png" id="fig:lifetime-measurement" alt="Figure 4.12: Lifetime as a function of the vertical noise V_\mathrm{N}" /><figcaption aria-hidden="true">Figure 4.12: Lifetime as a function of the vertical noise <span class="math inline">V_\mathrm{N}</span></figcaption>
</figure>
<p><a href="#fig:lifetime-measurement">Figure 4.12</a> shows the lifetime measurement. A vertical noise is used to inflate the vertical beam size, which reduces the probability of electron collisions within a bunch and therefore increases the lifetime. Touschek lifetime <span class="math inline">\tau_\mathrm{T}</span> and gas lifetime <span class="math inline">\tau_\mathrm{G}</span> are 8.5 and 21.4 hours, respectively. All in all, the measured lifetimes are close to the lifetimes of standard user optics.</p>
<p>Up next was the measurement of the kicker lifetimes. Here the kicker magnets of the orbit bump are fired rapidly without actually injecting a beam. If the lifetime is decreased during this process, electrons are lost at the septum, which would limit the possible injection efficiency. However, no effect on lifetime could be detected, which indicates an infinite kicker lifetime.</p>
<p><a href="#tbl:chromaticity-measurement">Table 4.2</a> list the results of the chromaticity measurement, containing the values of the tune, first and second-order chromaticity for the Q5T2off optics compared to the standard user optics. The horizontal, vertical, and longitudinal tunes are unchanged. However, the vertical and longitudinal chromaticities of the Q5T2off optics are slightly smaller than in the standard user optics. Also, the 2ⁿᵈ order chromaticities are slightly smaller in the horizontal and vertical plane.</p>
<div id="tbl:chromaticity-measurement">
<table>
<caption>Table 4.2: Tune, first and second order chromaticity of the Q5T2off optics (left) and the standard user optics (right)</caption>
<thead>
<tr class="header">
<th></th>
<th>Tune</th>
<th>Chroma</th>
<th>Chroma 2ⁿᵈ</th>
<th>Tune</th>
<th>Chroma</th>
<th>Chroma 2ⁿᵈ</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><span class="math inline">x</span></td>
<td>0.8485</td>
<td>1.9245</td>
<td>-43.2045</td>
<td>0.8427</td>
<td>2.0929</td>
<td>-47.2121</td>
</tr>
<tr class="even">
<td><span class="math inline">y</span></td>
<td>0.7259</td>
<td>3.1846</td>
<td>-63.0949</td>
<td>0.7264</td>
<td>3.1098</td>
<td>-67.7113</td>
</tr>
<tr class="odd">
<td><span class="math inline">z</span></td>
<td>0.0061</td>
<td>0.0034</td>
<td>0.2384</td>
<td>0.0061</td>
<td>0.0058</td>
<td>-0.7480</td>
</tr>
</tbody>
</table>
</div>
<p>The streak camera was used to measure the length of the different bunches of the BESSY II fill pattern. Single bunch, PPRE bunch, slicing bunch, and multi-bunches had the same length as in the standard user optics. That was expected as the Q5T2off optics did not change the momentum compaction factor <span class="math inline">\alpha_\mathrm{c}</span>.</p>
<figure>
<img src="figures/phase_acceptance_q5t2off.svg" id="fig:phase_acceptance_q5t2off" alt="Figure 4.13: Phase acceptance scan off the Q5T2off optics compared to the standard user optics." /><figcaption aria-hidden="true">Figure 4.13: Phase acceptance scan off the Q5T2off optics compared to the standard user optics.</figcaption>
</figure>
<p>As demonstrated in <span class="citation" data-cites="kuskeli"><a href="#ref-kuskeli" role="doc-biblioref">[47]</a></span>, improving the phase acceptance can increase the momentum acceptance, injection efficiency, and Touschek lifetime. At BESSY II, the longitudinal phase between the booster synchrotron and the storage ring can be varied. This allows measuring the injection efficiency as a function of the phase offset, also called a phase acceptance scan. The resulting curve’s full width at half maximum (FWHM) can then define the phase acceptance. <a href="#fig:phase_acceptance_q5t2off">Figure 4.13</a> shows the phase acceptance of Q5T2off optics compared to the standard user optics. Surprisingly, even with non-optimized sextuples, the phase acceptance seems wider but slightly lower than in the standard user optics. The FWHM of the curves are 1.2 ns and 0.9 ns, respectively. The fact that the phase acceptance of the standard optics was so small leaves the suspicion that the sextupole setting was not fully optimized during machine commissioning. Also demonstrated in <span class="citation" data-cites="kuskeli"><a href="#ref-kuskeli" role="doc-biblioref">[47]</a></span>, a phase acceptance of 1.5 ns FWHM for standard user optics is possible with an optimized sextupole setting.</p>
<p>The optics was run overnight as a long-term test. One thing that remains is to optimize the harmonic sextupole setting. However, all in all, the user acceptance test can be considered a success. Important beam parameters like lifetime, injection efficiency, phase acceptance, chromaticity, and kicker lifetime are as good as in the standard user optics.</p>
</section>
</section>
<section id="sec:emittance-exchange-experiment" class="level2" data-number="4.2">
<h2 data-number="4.2"><span class="header-section-number">4.2</span> Emittance Exchange Experiment</h2>
<p>Besides optimizing the Q5T2-off optics, the developed code was also used to modify the BESSY II storage ring optics for an emittance exchange experiment. The experiment required a high horizontal beta function of 15 m at the center of the T2 straight while keeping the perturbation of the beta function small around the rest of the storage ring. The goal was to study if raising the beta function at the position of a skew quadrupole, set up by four striplines, would increase its resonant excitation. In theory, the higher amplitude due to the higher beta function should lead to a stronger skew quadrupole kick, increasing the transverse emittance exchange.</p>
<p>The standard user optics was modified using the objective function</p>
<div id="eq:objectiv-function-emittance-exchange">
<table style="width:99%;">
<colgroup>
<col style="width: 90%" />
<col style="width: 9%" />
</colgroup>
<tbody>
<tr class="odd">
<td style="text-align: center;"><span class="math display"> F(\beta) = \frac{1}{L} \int_0^L R\left(\frac{\beta(s)}{\beta_\mathrm{ref}(s)}\right)^2 \mathrm{d}s + (15 \mathrm{m} - \beta_\mathrm{x}(s_\mathrm{T2})) ^ 2  + \lvert\frac{\mathrm{d \beta_\mathrm{x}}}{\mathrm{d} s}(s_\mathrm{T2})\rvert ,
</span></td>
<td style="text-align: right;"><span class="math display">(4.8)</span></td>
</tr>
</tbody>
</table>
</div>
<p>where <span class="math inline">R(x) = \mathrm{max}(1,x)</span> is the ReLU function thresholding at one. Similar to optimizing the Q5T2off optics, the first term is used to reduce the <span class="math inline">\beta_\mathrm{x}</span>-beat around the rest of the ring. Moreover, the region between 40 m and 50 m is excluded from the integral as this would be in conflict with the second term. The ReLU function R(x) is composed with the relative residual of the beta function <span class="math inline">\frac{\beta(s)}{\beta_\mathrm{ref}(s)}</span> to disincentivize lowering the beta function below the reference value at the expense of making it larger somewhere else. The second term is used to raise the beta function to 15 m. The first derivative of the beta function <span class="math inline">\frac{\mathrm{d \beta_\mathrm{x}}}{\mathrm{d} s}(s_\mathrm{T2})</span> ensures the resulting optics is symmetrical at the center of T2 section.</p>
<figure>
<img src="figures/twiss_t2_high_beta_x.svg" id="fig:emittance-exchange-optics-1" alt="Figure 4.14: Optics 1 - High horizontal and low vertical beta and function in the T2 straight." /><figcaption aria-hidden="true">Figure 4.14: Optics 1 - High horizontal and low vertical beta and function in the T2 straight.</figcaption>
</figure>
<p><a href="#fig:emittance-exchange-optics-1">Figure 4.14</a> shows an optics where all quadrupoles from the D2 to the D3 section were used for the optimization. Already described in <a href="#sec:user-acceptance-test">Section 4.1.5</a>, the optics was transferred to the machine by calculating the new power supply values from the old and new quadrupole strength ratio, using the tool shown in <a href="#sec:gui-power-supply-values">Section 8</a>. Afterward, the optics was LOCO-measured to ensure it was transferred correctly.</p>
<div id="tbl:beam-size-emittance-exchange">
<table style="width:100%;">
<caption>Table 4.3: Beam size depending on resonant skew excitations for the different optics</caption>
<colgroup>
<col style="width: 16%" />
<col style="width: 16%" />
<col style="width: 16%" />
<col style="width: 16%" />
<col style="width: 16%" />
<col style="width: 16%" />
</colgroup>
<thead>
<tr class="header">
<th style="text-align: center;">Optics</th>
<th style="text-align: center;">Skew Excitation</th>
<th style="text-align: center;"><span class="math inline">\sigma_\mathrm{x}</span> / μm</th>
<th style="text-align: center;"><span class="math inline">\sigma_\mathrm{x} / \sigma_\mathrm{x,off}</span></th>
<th style="text-align: center;"><span class="math inline">\sigma_\mathrm{y}</span> / μm</th>
<th style="text-align: center;"><span class="math inline">\sigma_\mathrm{y} / \sigma_\mathrm{y,off}</span></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">Standard User</td>
<td style="text-align: center;">off</td>
<td style="text-align: center;">62.4</td>
<td style="text-align: center;"></td>
<td style="text-align: center;">37.0</td>
<td style="text-align: center;"></td>
</tr>
<tr class="even">
<td style="text-align: center;">Standard User</td>
<td style="text-align: center;">on</td>
<td style="text-align: center;">57.0</td>
<td style="text-align: center;">0.91</td>
<td style="text-align: center;">169.0</td>
<td style="text-align: center;">4.57</td>
</tr>
<tr class="odd">
<td style="text-align: center;">⎯</td>
<td style="text-align: center;">⎯</td>
<td style="text-align: center;">⎯</td>
<td style="text-align: center;">⎯</td>
<td style="text-align: center;">⎯</td>
<td style="text-align: center;">⎯</td>
</tr>
<tr class="even">
<td style="text-align: center;">Optics 1</td>
<td style="text-align: center;">off</td>
<td style="text-align: center;">58.0</td>
<td style="text-align: center;"></td>
<td style="text-align: center;">41.3</td>
<td style="text-align: center;"></td>
</tr>
<tr class="odd">
<td style="text-align: center;">Optics 1</td>
<td style="text-align: center;">on</td>
<td style="text-align: center;">52.8</td>
<td style="text-align: center;">0.91</td>
<td style="text-align: center;">227.0</td>
<td style="text-align: center;">5.54</td>
</tr>
<tr class="even">
<td style="text-align: center;">⎯</td>
<td style="text-align: center;">⎯</td>
<td style="text-align: center;">⎯</td>
<td style="text-align: center;">⎯</td>
<td style="text-align: center;">⎯</td>
<td style="text-align: center;">⎯</td>
</tr>
<tr class="odd">
<td style="text-align: center;">Optics 2</td>
<td style="text-align: center;">off</td>
<td style="text-align: center;">58.8</td>
<td style="text-align: center;"></td>
<td style="text-align: center;">44.3</td>
<td style="text-align: center;"></td>
</tr>
<tr class="even">
<td style="text-align: center;">Optics 2</td>
<td style="text-align: center;">on</td>
<td style="text-align: center;">54.2</td>
<td style="text-align: center;">0.92</td>
<td style="text-align: center;">267.0</td>
<td style="text-align: center;">6.03</td>
</tr>
</tbody>
</table>
</div>
<p>The stripline in the center of the T2 section was set up as a skew quadrupole to excite the beam resonantly. A pinhole at the dipole at the end of the D5 section was used to measure the beam size. <a href="#tbl:beam-size-emittance-exchange">Table 4.3</a> list the beam sizes for the standard user optics and the optics with the high horizontal beta function with the skew excitation turned on and off. Without any excitation, the standard user optics’ horizontal and vertical beam sizes at the pinhole are 62.4 μm and 37.0 μm, respectively. Despite the small coupling of below 2%, the vertical beam size is <span class="math inline">\sigma_\mathrm{y}</span> comparable to the horizontal beam size <span class="math inline">\sigma_\mathrm{x}</span>, since the vertical beta function <span class="math inline">\beta_\mathrm{y}</span> is many times larger than the horizontal beta function <span class="math inline">\beta_\mathrm{x}</span> at the pinhole position. With the resonant skew excitation turned on, the horizontal beam size decreases to 57.0 μm while the vertical beam size increases to 169.0 μm. As the beam size is defined by <span class="math inline">\sigma_\mathrm{u} = \sqrt{\epsilon_\mathrm{u} \beta_\mathrm{u}}</span>, this change corresponds to a decrease of the horizontal emittance to <span class="math inline">0.91^2 = 0.83</span>.</p>
<p>Without the excitation, the optics with the high horizontal beta function has a slightly smaller horizontal beam size <span class="math inline">\sigma_\mathrm{x}</span> of 58.0 μm and a slightly larger vertical beam size <span class="math inline">\sigma_\mathrm{y}</span> of 41.3 μm. While the Twiss parameters seem to have been unaffected in the D5 section in simulation, this change can probably still be attributed to a change of the beta functions when the optics was transfered to the machine. Surprisingly, with the skew excitation turned on, the horizontal emittance only decreased to 52.8 μm, corresponding to 91 %, which is the same value as in the standard user optics. Thus, in contradiction to the expected results, the additional horizontal amplitude at the skew quadrupole did not seem influence the emittance exchange.</p>
<figure>
<img src="figures/twiss_t2_high_beta_x_y.svg" id="fig:emittance-exchange-optics-2" alt="Figure 4.15: Optics 2 - High horizontal and high vertical function in the T2 straight." /><figcaption aria-hidden="true">Figure 4.15: Optics 2 - High horizontal and high vertical function in the T2 straight.</figcaption>
</figure>
<p>Therefore, during the same machine commissioning session, it was decided to fit a second optics where also the vertical beta function is raised to 15 m. For this, the objective function was extended by the vertical analog of the second and third terms of <a href="#eq:objectiv-function-emittance-exchange">Equation 4.8</a>. <a href="#fig:emittance-exchange-optics-2">Figure 4.15</a> shows the Twiss parameters of the optics with both beta functions raised to 15 m in the center of the T2 section. The optics was again LOCO-measured to ensure it was transferred to the machine correctly. Again, the horizontal and vertical beam sizes were measured with the skew excitation on and off. Also, this time, the horizontal beam size was decreased to 0.92 of its size without excitation.</p>
<p>While it requires more investigation in simulations as well as in experiments why the larger amplitude at the skew quadrupole did not increase the emittance exchange, the experiment showed that the developed code is flexible enough to support various lattice development tasks.</p>
</section>
<section id="sec:lattice-summaries" class="level2" data-number="4.3">
<h2 data-number="4.3"><span class="header-section-number">4.3</span> Automated Lattice Summaries</h2>
<p><a href="#sec:automated-lattice-summaries">Section 1.2.3</a> outlined the need for a shared database of lattice files and automatically generated summaries: Physicists often repeat the cumbersome work of manually translating between different lattice file formats. In addition, simulations results are often difficult to reproduce or transfer to similar lattice development tasks. Finally, a standardized visualization of the simulation results would make lattices easier to compare.</p>
<p>An infrastructure that makes not only the lattices files sharable but also the simulation routines and visualization of the results could solve these problems. Ideally, a user only has to add a lattices file to the database. Then, a set of routines leveraging different simulation codes would be run locally or in the cloud. Finally, the simulation results would be summarized by a standardized lattice report. Due to the lattice summarizes being contentwise and visually consistent, the user could conveniently compare different lattices.</p>
<p>Such a framework could be valuable in different scenarios: It could facilitate collaborative lattice development within a facility. For example, in the case of HZB, it could be used to benchmark BESSY III lattice candidates. Furthermore, it could also facilitate the exchange of lattice files between different facilities. One tangible idea would be to create an updated version of the Synchrotron Light Source Data Book <span class="citation" data-cites="murphy_1996"><a href="#ref-murphy_1996" role="doc-biblioref">[7]</a></span>. That could be realized by a website where every facility could contribute to. Even in cases of smaller lattice development tasks, which do not involve several people, a standardized interface to set up routines and organize lattice files is still beneficial. Using the same framework for local lattice development incentives collaboration as no extra work is required to share custom simulation routines. Reproducing the simulation result and plots of a colleague would then come down to running one command with the name of the routine and lattice file as arguments:</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="ex">lattice-summaries</span> <span class="op">&lt;</span>name-of-routine<span class="op">&gt;</span> <span class="op">&lt;</span>name-of-lattice<span class="op">&gt;</span></span></code></pre></div>
<p>This section presents the prove-of-concept framework <em>lattice-summaries</em>, developed based on the lattice file format LatticeJSON. Currently, it provides routines to calculate the Twiss parameters using elegant <span class="citation" data-cites="elegant"><a href="#ref-elegant" role="doc-biblioref">[9]</a></span>, MAD-X <span class="citation" data-cites="madx"><a href="#ref-madx" role="doc-biblioref">[8]</a></span>, or the simulation code developed for this thesis. <a href="#sec:lattice-summaries-architecture">Section 4.3.1</a> outlines the architecture of the <em>lattice-summaries</em> framework. The following subsections provide a more detailed overview of the different components of the framework.</p>
<section id="sec:lattice-summaries-architecture" class="level3" data-number="4.3.1">
<h3 data-number="4.3.1"><span class="header-section-number">4.3.1</span> Architecture</h3>
<p>The source code of the <em>lattice-summaries</em> framework can be found on GitHub under the <em>nobeam</em> organization (<a href="https://github.com/nobeam">https://github.com/nobeam</a>).</p>
<p>The framework is split up into three different repositories:</p>
<ol type="1">
<li><a href="https://github.com/nobeam/lattice-summaries-data">lattice-summaries-data</a>: A database of lattices files and optional run parameters</li>
<li><a href="https://github.com/nobeam/lattice-summaries">lattice-summaries</a>: A set of routines leveraging different simulation codes</li>
<li><a href="https://github.com/nobeam/lattice-summaries-website">lattice-summaries-website</a>: A website to inspect the simulation results</li>
</ol>
<figure>
<img src="figures/lattice-summaries-how-it-works.svg" id="fig:lattice-summaries-how-it-works" alt="Figure 4.16: Schematic overview of the lattice summaries architecture" /><figcaption aria-hidden="true">Figure 4.16: Schematic overview of the lattice summaries architecture</figcaption>
</figure>
<p><a href="#fig:lattice-summaries-how-it-works">Figure 4.16</a> gives a schematic overview of the lattice summaries architecture. A user uploads a new lattice file and optional run files to the <em>lattice-summaries-data</em> repository, which functions as the database. Then routines defined in the <em>lattice-summaries</em> repository are run for all selected lattices. Next, the simulation results are uploaded and served by a static web server. Now the simulation results can be viewed through a website, which dynamically creates the summary views for the given simulation data. The <em>lattice-summaries-website</em> repository contains the source code of the website.</p>
<p>The presented architecture was chosen to offer maximum flexibility: Keeping the data repository and repository containing the simulation routines separate makes it possible to support multiple instances. This way, the data repository can be switched out so that different facilities can create their own instances for private lattice development. A public instance, for example, could be used to create an updated version of the Synchrotron Light Source Data Book. Furthermore, this allows the framework to be used for local lattice development, as a local instance of the data repository can be used.</p>
<p>The repository containing the website and the simulations results are also kept separate. That has the advantage that the website does not have to be updated when new simulation results are computed. That is convenient in the case of local lattice development, where the simulation results change frequently.</p>
</section>
<section id="sec:database-of-lattice-files" class="level3" data-number="4.3.2">
<h3 data-number="4.3.2"><span class="header-section-number">4.3.2</span> Database of Lattice Files</h3>
<p>As most lattice file formats are plain text files, using Git seemed reasonable to build the database. The alternative would have been to use some NoSQL database and built a small API on top of it so that people could contribute and review new lattices. However, this seemed like unnecessary work as most of the functionality is already provided by the Git ecosystem. For example, hosting systems for Git repositories like GitHub or GitLab already provide the functionality to contribute, review contributions and run custom code in the event of a new contribution. Furthermore, Git has the advantage that it is ubiquitous, and many physicists are already familiar with how to use it.</p>
<p>The lattices are split into different namespaces so that multiple physicists can work on similar lattices without creating a name collision. In general, the lattice files follow the naming schema:</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;</span>namespace<span class="op">&gt;</span> / <span class="op">&lt;</span>machine<span class="op">&gt;</span>_<span class="op">&lt;</span>familiy<span class="op">&gt;</span>_v_<span class="op">&lt;</span>version<span class="op">&gt;</span></span></code></pre></div>
<p>An exemplary folder structure of a lattice database looks like:</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="ex">database</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a><span class="ex">├──</span> namespace-1</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a><span class="ex">│</span>  ├── bessy2_design-1996_v_1.json</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a><span class="ex">│</span>  ├── bessy2_stduser-2019-05-07-v_1.json</span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a><span class="ex">│</span>  └── info.toml</span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a><span class="ex">├──</span> namespace-2</span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a><span class="ex">│</span>  ├── bessy3_5ba-20p_v_long-bend-tgrb.lte</span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a><span class="ex">│</span>  ├── bessy3_5ba-20p_v_reference.lte</span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a><span class="ex">│</span>  └── info.toml</span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a><span class="ex">...</span></span></code></pre></div>
<p>Every namespace contains an <code>info.toml</code> file, which contains additional metadata. That includes the human-readable title, an optional description, a list of authors, a list of labels, and a list of simulation routines that should be run for the given lattice. The list of simulation routines is necessary because a lattice file might contain special elements unique to a given simulation, not available for the other simulation routines. Possible labels, for example, could be if the lattice contains anti-bends, combined functions magnets, or longitudinal gradient bends. A detailed explanation of adding a lattice to the database can be found in the <code>README.md</code> file of the <a href="https://github.com/nobeam/lattice-summaries-data">lattice-summaries-data</a> repository.</p>
</section>
<section id="set-of-routines" class="level3" data-number="4.3.3">
<h3 data-number="4.3.3"><span class="header-section-number">4.3.3</span> Set of Routines</h3>
<p>The set of routines are responsible for generating the simulation results. This is arguably the most complex part. These routines can be dependent on each other. For example, to run the routine that plots the Twiss parameters, a routine that calculates them must be run first. If the lattice is not available in the necessary format, another routine has to be run before translating the lattice file to the needed format.</p>
<p>The goal is that different simulation codes can power these routines, with more routines being added over time. Currently, the <em>lattice-summaries</em> framework provides the following routines: One routine that translates lattice files between the LatticeJSON format and the lattice file formats used by elegant and MAD-X. One routine extracts general information about the lattice, such as the circumference, energy, number of sections, section length, or bends per section. Three routines that compute the Twiss parameters using either elegant, MAD-X, or the developed code for this thesis. Furthermore, three routines that plot the Twiss parameters, a floor plan, or the higher-order chromaticity.</p>
<p>For local lattice development, the users change a config file to use their private version of the lattice database if they need a lattice not available in the shared database. Another convenience feature is that the dependency relation between the routines is lazy evaluated, which means that simulation is not rerun if a user only adjusts code, which is part of a visualization routine. Detailed instructions on the setup and usage are provided in <code>README.md</code> file of the <a href="https://github.com/nobeam/lattice-summaries">lattice-summaries</a> repository.</p>
</section>
<section id="lattice-summaries-website" class="level3" data-number="4.3.4">
<h3 data-number="4.3.4"><span class="header-section-number">4.3.4</span> Lattice Summaries Website</h3>
<p>This website provides a frontend to view the simulation results. The website is developed as a Single Page Application (SPA) using the JavaScript Framework <a href="https://vuejs.org/">Vue.js 3</a> <span class="citation" data-cites="vuejs"><a href="#ref-vuejs" role="doc-biblioref">[51]</a></span> and the build tool <a href="https://vitejs.dev/">Vite</a> <span class="citation" data-cites="vitejs"><a href="#ref-vitejs" role="doc-biblioref">[52]</a></span>. A SPA is a website that, on user interaction, dynamically rewrites the current web page instead of fetching a pre-rendered page from a server. The advantage is that the website does not have to be updated if new simulation results are uploaded. Instead, new pages are created dynamically in the frontend. Furthermore, it makes it possible to use the website for local development. By changing the <code>DATA_URL</code> environment variable, the user can display local simulation results.</p>
<p>Currently, the website consists out of three views:</p>
<ol type="1">
<li>A landing page that lists all lattices</li>
<li>A lattice view, which lists an overview of the available summaries for that lattice</li>
<li>Different types of summary views depending on the simulation routine</li>
</ol>
<figure>
<img src="figures/lattice-summaries-landing-page.png" id="fig:lattice-summaries-landing-page" alt="Figure 4.17: Screenshot of the landing page of the lattice summaries website" /><figcaption aria-hidden="true">Figure 4.17: Screenshot of the landing page of the lattice summaries website</figcaption>
</figure>
<p><a href="#fig:lattice-summaries-landing-page">Figure 4.17</a> shows a screenshot of the landing page. It provides a search bar where lattices can be filtered by name. Furthermore, lattices can be filtered by <em>Namespace</em>, <em>Machine</em>, and <em>Author</em>. The search results are displayed as cards. These cards provide a short description, links to the corresponding lattice file in different formats, and links to the different types of summaries available for the given lattice.</p>
<figure>
<img src="figures/lattice-summaries-design-lattice.png" id="fig:lattice-summaries-design-lattice" alt="Figure 4.18: Screenshot of an examplary lattice summary of the BESSY II design lattice" /><figcaption aria-hidden="true">Figure 4.18: Screenshot of an examplary lattice summary of the BESSY II design lattice</figcaption>
</figure>
<p><a href="#fig:lattice-summaries-design-lattice">Figure 4.18</a> shows an exemplary lattice summary of the BESSY II design lattice generated by the apace simulation code. The lattice summary consists out of different cards which provide different information. Independent of the type of summary, the first card is an info-card identical to the card shown in the search results. All other cards are specific to the type of summary. For example, in the case of the Twiss summary generated by the apace code, the second card provides some general information on the lattice. That includes energy, circumference, number of bends, number of sections or, section length. The third card provides a plot with the beta function and horizontal dispersion function for the unit cell. Other lattice parameters like the momentum compaction factor, emittance, or the synchrotron radiation integrals are listed in a table on the fourth card. The last card shows a floor plan of the unit cells.</p>
</section>
</section>
</section>
<section id="conclusion" class="level1" data-number="5">
<h1 data-number="5"><span class="header-section-number">5</span> Conclusion</h1>
<p>This thesis presents the development of a new lattice design tool developed in the Python language and a new JSON-based lattice file format. The introduction outlines the technical obstacles physicists have to overcome during lattice development. Ranging from the problems of exchanging lattice files to the challenges of interfacing existing accelerator codes from a modern programming language, forcing physicists to write complicated and error-prone wrapper scripts.</p>
<p>Since Python has evolved to the lingua franca of the scientific community, it is an obvious candidate to form the basis of a new lattice design tool. In addition, the native interface to Python’s ecosystem gives particle accelerator physics access to a large pool of scientific libraries, easy to integrate into lattice development workflows. While the capabilities at the moment are limited to linear beam dynamics, which corresponds only to a fraction of what mature accelerator physics codes like elegant or MAD-X are capable of, the developed code has been successfully used for several applications:</p>
<p>The Q5T2off optics presented in my bachelor’s thesis was significantly improved. The <span class="math inline">\beta</span>-beat outside the T2 section and its adjacent sections is negligible. The reduced vertical beta function in the center of the T2 section now clearly fulfills the requirements to avoid coupled bunch instabilities. Finally, a successful user acceptance test showed that the optics is ready for standard user operation.</p>
<p>In the context of an emittance exchange experiment, the BESSY II storage ring’s optics was modified. First, the horizontal beta function was raised in the center of a triplet section to increase the influence of resonant skew excitation. Then, during the experiment, a second optics change was needed. The developed code was used throughout the same machine commissioning session to fit another optics where both beta functions were raised to 15 m in the center of the triplet section. While the experiment itself did not lead to the expected effect, it showed that the developed code is flexible enough to support a variety of lattice development tasks.</p>
<p>The developed code <em>apace</em> and the <em>LatticeJSON</em> lattice file format form the basis of a prove-of-concept framework to generate standardized lattice reports for a given set of lattice files. While much work still has to be done, automated routines to calculate the Twiss parameters using elegant <span class="citation" data-cites="elegant"><a href="#ref-elegant" role="doc-biblioref">[9]</a></span>, MAD-X <span class="citation" data-cites="madx"><a href="#ref-madx" role="doc-biblioref">[8]</a></span>, or code developed for this thesis have been set up. The simulation results can be inspected via a website. The framework could be used to facilitate the lattice development of the BESSY II successor BESSY III, where many lattice candidates arise. Also, the framework could be used to create an updated version of the Synchrotron Light Source Data Book.</p>
<p>The new JSON-based lattice file format LatticeJSON can be considered a byproduct of this work. The goal was to create the most simple and straightforward lattice file format possible to make it easy to load the lattice data into every programming language. In contrary to other lattice files formats, the LatticeJSON format is a pure data format and does not support any constructs like variables, loops, or conditions. While, at the moment, only basic objects like drift sections, multipoles, cavities, or sub-lattices structures are supported, this is already sufficient to describe many accelerators. The simplicity of the format might not make it useable for every scenario, like for control system software, where additional configuration or the history of the magnet values is stored. However, its simplicity facilitates it to integrate it into other tasks. For example, the LatticeJSON format has proven helpful in transferring a new optics to the machine. To automate the process of calculating the new power supply values, the quadrupole strengths have to be extracted from the lattices files. Because the new lattice file format is JSON-based, which makes it trivial to extract values out of it, it was much easier than with the existing lattice file formats.</p>
<p>In conclusion, the code developed as part of this thesis will not replace the existing more mature and full-featured particle accelerator codes. However, it has shown how a modern lattice development workflow can look like and extends the ecosystem of accelerator tools by enabling fundamental lattice development using the Python language.</p>
</section>
<section id="sec:appendix-code" class="level1" data-number="6">
<h1 data-number="6"><span class="header-section-number">6</span> Developed Code</h1>
<p><strong>apace</strong> is yet <strong>a</strong>nother <strong>p</strong>article <strong>a</strong>ccelerator <strong>c</strong>od<strong>e</strong> designed for the optimization of beam optics. It is available as Python package and aims to provide a convenient and straightforward API to make use of Python’s numerous scientific libraries.</p>
<p>The source code is available at:</p>
<blockquote>
<p><a href="https://github.com/andreasfelix/apace">https://github.com/andreasfelix/apace</a></p>
</blockquote>
<section id="installation" class="level2" data-number="6.1">
<h2 data-number="6.1"><span class="header-section-number">6.1</span> Installation</h2>
<p>Install and update using pip:</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="ex">pip</span> install <span class="at">-U</span> apace</span></code></pre></div>
</section>
<section id="requirements" class="level2" data-number="6.2">
<h2 data-number="6.2"><span class="header-section-number">6.2</span> Requirements</h2>
<ul>
<li>Python 3.6 or higher (CPython or PyPy)</li>
<li>CFFI 1.0.0 or higher</li>
<li>NumPy/SciPy</li>
<li>Matplotlib</li>
<li>C Compiler</li>
</ul>
</section>
<section id="links" class="level2" data-number="6.3">
<h2 data-number="6.3"><span class="header-section-number">6.3</span> Links</h2>
<ul>
<li>Documentation: <a href="https://apace.readthedocs.io">https://apace.readthedocs.io</a></li>
<li>API Reference: <a href="https://apace.readthedocs.io/en/stable/reference/apace/index.html">https://apace.readthedocs.io/en/stable/reference/apace/index.html</a></li>
<li>Examples: <a href="https://apace.readthedocs.io/en/stable/examples/index.html">https://apace.readthedocs.io/en/stable/examples/index.html</a></li>
<li>Releases: <a href="https://pypi.org/project/apace/">https://pypi.org/project/apace/</a></li>
<li>Code: <a href="https://github.com/andreasfelix/apace">https://github.com/andreasfelix/apace</a></li>
<li>Issue tracker: <a href="https://github.com/andreasfelix/apace/issues">https://github.com/andreasfelix/apace/issues</a></li>
</ul>
</section>
<section id="license" class="level2" data-number="6.4">
<h2 data-number="6.4"><span class="header-section-number">6.4</span> License</h2>
<p><a href="https://github.com/andreasfelix/apace/blob/main/LICENSE">GNU General Public License v3.0</a></p>
</section>
</section>
<section id="sec:code-to-reproduce-q5t2off-optics" class="level1" data-number="7">
<h1 data-number="7"><span class="header-section-number">7</span> Code to Reproduce the Q5T2off Optics</h1>
<p>The following code snippets reproduce the Q5T2off optics presented in <a href="#sec:optimizing-the-q5t2off-optics">Section 4.1.4</a>.</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> apace <span class="im">as</span> ap</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy <span class="im">import</span> optimize</span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>bessy2 <span class="op">=</span> ap.Lattice.from_file(<span class="st">&quot;bessy2_stduser_2019_05_07.json&quot;</span>)</span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>twiss <span class="op">=</span> ap.Twiss(bessy2, steps_per_meter<span class="op">=</span><span class="dv">4</span>)</span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>t2_center <span class="op">=</span> np.searchsorted(twiss.s, <span class="dv">45</span>)</span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>beta_ref_x <span class="op">=</span> twiss.beta_x.copy()</span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a>beta_ref_y <span class="op">=</span> twiss.beta_y.copy()</span></code></pre></div>
<p>First, the <code>apace</code>, <code>numpy</code> and, <code>scipy.optimize</code> libraries are imported. Then, a new <code>Lattice</code> and <code>Twiss</code> object for the current BESSY II standard user optics is created. The <code>np.searchsorted</code> is used to obtain the index of the center of the T2 section, located at 45 meters. Finally, the current horizontal and vertical beta functions are copied to be later used as reference values:</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>t1 <span class="op">=</span> [<span class="st">&quot;Q3P1T1&quot;</span>, <span class="st">&quot;Q3P2T1&quot;</span>, <span class="st">&quot;Q4P1T1&quot;</span>, <span class="st">&quot;Q4P2T1&quot;</span>, <span class="st">&quot;Q5P1T1&quot;</span>, <span class="st">&quot;Q5P2T1&quot;</span>]</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>d2 <span class="op">=</span> [<span class="st">&quot;Q3D2&quot;</span>, <span class="st">&quot;Q4D2&quot;</span>]</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>t2 <span class="op">=</span> [<span class="st">&quot;Q3T2&quot;</span>, <span class="st">&quot;Q4T2&quot;</span>]</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>d3 <span class="op">=</span> [<span class="st">&quot;Q3D3&quot;</span>, <span class="st">&quot;Q4D3&quot;</span>]</span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>t3 <span class="op">=</span> [<span class="st">&quot;Q3T3&quot;</span>, <span class="st">&quot;Q4T3&quot;</span>, <span class="st">&quot;Q5T3&quot;</span>]</span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>q5t2 <span class="op">=</span> bessy2[<span class="st">&quot;Q5T2&quot;</span>]</span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>quads_turnoff <span class="op">=</span> [bessy2[name] <span class="cf">for</span> name <span class="kw">in</span> t2]</span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a>quads_optimize <span class="op">=</span> [bessy2[name] <span class="cf">for</span> name <span class="kw">in</span> t1 <span class="op">+</span> d2 <span class="op">+</span> t2 <span class="op">+</span> d3 <span class="op">+</span> t3]</span></code></pre></div>
<p>The optimization procedure consists of two parts, which use two different sets of quadrupoles defined in this snippet. The first part uses the <code>quads_turnoff</code> quadrupoles, corresponding to the quadrupoles in the T2 section. Here, each iteration lowers the value of the Q5T2 quadrupole step by step, while the optimizer tries to compensate the turn-off using the <code>quads_turnoff</code> quadrupoles. Then, in the next step, the optimizer tries to optimize the Twiss parameter for similarity with the reference optics. It uses the <code>quad_optimize</code> quadrupoles, corresponding to all quadrupoles from the T1 section to the T3 section.</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> objective_function(values, quads):</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> quad, value <span class="kw">in</span> <span class="bu">zip</span>(quads, values):</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>        quad.k1 <span class="op">=</span> value</span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> twiss.stable:</span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> np.inf</span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a>    beta_beat_x <span class="op">=</span> np.maximum(<span class="dv">1</span>, twiss.beta_x <span class="op">/</span> beta_ref_x) <span class="op">**</span> <span class="dv">2</span></span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a>    beta_beat_y <span class="op">=</span> np.maximum(<span class="dv">1</span>, twiss.beta_y <span class="op">/</span> beta_ref_y) <span class="op">**</span> <span class="dv">2</span></span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a>    beat_mean <span class="op">=</span> np.trapz(beta_beat_x <span class="op">+</span> beta_beat_y, x<span class="op">=</span>twiss.s) <span class="op">/</span> bessy2.length</span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> beat_mean <span class="op">+</span> <span class="bu">max</span>(twiss.beta_y[t2_center], <span class="fl">1.6</span>)</span></code></pre></div>
<p>The snippet above corresponds to the objective function defined in <a href="#eq:objectiv-function">Equation 4.5</a>. The values of <code>twiss.beta_x</code> are not equidistant but depend on how long a given element is and how often it is sliced. Integrating the beta beat using the trapezoidal rule <code>np.trapz</code> takes the correct weighting factor into account. The <code>max(twiss.beta_y[t2_center], 1.6)</code> is used to incentivize a small vertical beta function in the center of the T2 section <span class="math inline">\beta_\mathrm{y}(s_\mathrm{T2})</span>, but it is capped at 1.6 m as these should be enough to fulfill the requirements stated in <a href="#sec:q5t2off-constraints">Section 4.1.2</a>.</p>
<div class="sourceCode" id="cb34"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> run(quads):</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>    result <span class="op">=</span> optimize.minimize(</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>        objective_function,</span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>        np.array([x.k1 <span class="cf">for</span> x <span class="kw">in</span> quads]),</span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>        args<span class="op">=</span>quads,</span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>        method<span class="op">=</span><span class="st">&quot;Nelder-Mead&quot;</span>,</span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot;k1: </span><span class="sc">{</span>q5t2<span class="sc">.k1:+.3f}</span><span class="ss">, objective: </span><span class="sc">{</span>result<span class="sc">.</span>fun<span class="sc">:+.3f}</span><span class="ss">&quot;</span>)</span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> twiss.stable:</span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">raise</span> <span class="pp">Exception</span>(<span class="st">&quot;Result must be stable!&quot;</span>)</span></code></pre></div>
<p>This snippet defines a run function, which takes one parameter, <code>quads</code>. That is the list of quadrupoles used for the optimization. If the Twiss parameters are not stable, the program stops with an error message.</p>
<div class="sourceCode" id="cb35"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> q5t2.k1 <span class="kw">in</span> np.linspace(q5t2.k1, <span class="dv">0</span>, <span class="dv">10</span>):</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>    run(quads_turnoff)</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> _ <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">5</span>):</span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>    run(quads_optimize)</span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>bessy2.as_file(<span class="st">&quot;bessy2_q5t2off.json&quot;</span>)</span></code></pre></div>
<p>In the last snippet, the optimization is executed. First, optimization is run using the quadrupoles <code>quads_turnoff</code>. For each iteration, the <code>k1</code> value of <code>q5t2</code> quadrupole is lowered until it reaches zero. In the second loop, the obtained optics is optimized using all quadrupoles. Finally, the optimized Q5T2off optics is saved to disk.</p>
</section>
<section id="sec:gui-power-supply-values" class="level1" data-number="8">
<h1 data-number="8"><span class="header-section-number">8</span> GUI to Calculate and Set new Power Supply Values</h1>
<figure>
<img src="figures/gui-power-supply-values.png" id="fig:gui-power-supply-values" alt="Figure 8.1: Screenshot of a simple application to calculate and set new power supply values" /><figcaption aria-hidden="true">Figure 8.1: Screenshot of a simple application to calculate and set new power supply values</figcaption>
</figure>
<p>Transfering a new quadrupole setting to the machine by manually entering individual power supply values into the control system can be cumbersome and error-prone. Therefore, a simple application with a graphic user interface (GUI) was developed to automate this process. It is written in Python and uses the EPICS interface to interact with the machine. <a href="#fig:gui-power-supply-values">Figure 8.1</a> shows a screenshot of the application. The application is visually split into three parts:</p>
<p>The first two buttons in the upper part load the quadrupole values of the <em>new lattice</em> and <em>reference lattice</em>. The files must be in the LatticeJSON format. The third button loads the power supply values of the <em>reference lattice</em>.</p>
<p>Below, a table shows the reference, current and, new power supply values. The new power supply values</p>
<div>
<table style="width:99%;">
<colgroup>
<col style="width: 90%" />
<col style="width: 9%" />
</colgroup>
<tbody>
<tr class="odd">
<td style="text-align: center;"><span class="math display"> I_\mathrm{new} = \frac{k_\mathrm{new}}{k_\mathrm{old}} I_\mathrm{old} </span></td>
<td style="text-align: right;"><span class="math display">(8.1)</span></td>
</tr>
</tbody>
</table>
</div>
<p>are calculated by the ratio of the new and old quadruple strength times the old power supply values.</p>
<p>The bottom frame contains multiple buttons: The first button stores all quadrupoles’ current power supply values to a JSON file. During the LOCO measurement, that should be done to make sure the quadrupole values correspond to the power supply value. The second button computes the new power supply values. The multi-knob-toggle in the middle allows interpolating between two lattices. The user can choose a second lattice file and use a slider to interpolate between the quadrupole values of these two lattices. Finally, the three buttons in the right corner can set the new power supply values or set and restore the current quadrupole setting.</p>
</section>
<section id="sec:appendix-transfer-matrices" class="level1" data-number="9">
<h1 data-number="9"><span class="header-section-number">9</span> Transfer Matrices</h1>
<p>Solving <a href="#eq:eom-linearized">Equation 2.20</a> yields the matrix entries for the transversal offset <span class="math inline">u(s)</span> and slope <span class="math inline">u&#39;(s)</span>.</p>
<p>Two effects influence the longitudinal offset <span class="math inline">l(s)</span>: First, the path length within an element can vary from the path length of the ideal orbit. Following from <a href="#eq:path-length-difference">Equation 2.12</a>, in linear approximation the total path length within an element of the length <span class="math inline">L</span> is given by:</p>
<div id="eq:total-path-length">
<table style="width:99%;">
<colgroup>
<col style="width: 90%" />
<col style="width: 9%" />
</colgroup>
<tbody>
<tr class="odd">
<td style="text-align: center;"><span class="math display"> Z = \int_{0}^{L} (1 + \kappa_\mathrm{x0}(s) x)\mathrm{d} s
</span></td>
<td style="text-align: right;"><span class="math display">(9.1)</span></td>
</tr>
</tbody>
</table>
</div>
<p>Secondly, the time scales linearly with the relative velocity error <span class="math inline">\frac{\Delta v}{v_0}</span>. Using an approximation from relativistic kinematics</p>
<div id="eq:relativistic-kinematic-seq">
<table style="width:99%;">
<colgroup>
<col style="width: 90%" />
<col style="width: 9%" />
</colgroup>
<tbody>
<tr class="odd">
<td style="text-align: center;"><span class="math display">
\frac{\mathrm{d} p}{\mathrm{d} v} = m_0 \gamma + m_0 \frac{v^2}{c^2} \gamma^3 = m_0 \gamma^3 (\frac{1}{\gamma^2} + \frac{v^2}{c^2}) \approx m_0 \gamma^3 = \frac{p}{v} \gamma^2,
</span></td>
<td style="text-align: right;"><span class="math display">(9.2)</span></td>
</tr>
</tbody>
</table>
</div>
<p>we can combine both effects and obtain an expression for the longitudinal offset</p>
<div id="eq:logitudinal-offset">
<table style="width:99%;">
<colgroup>
<col style="width: 90%" />
<col style="width: 9%" />
</colgroup>
<tbody>
<tr class="odd">
<td style="text-align: center;"><span class="math display">
\begin{aligned}
l(s + L) &amp; = l(s) -(Z-L) + L\frac{\Delta v}{v_0} \\
&amp; \approx l(s) - \int_{s}^{s + L} \kappa_\mathrm{x0}(s&#39;) x \mathrm{d} s&#39; + \frac{L}{\gamma^2} \delta_0 .
\end{aligned}
</span></td>
<td style="text-align: right;"><span class="math display">(9.3)</span></td>
</tr>
</tbody>
</table>
</div>
<p>Assuming no radiation, the relative momentum deviation</p>
<div id="eq:momentum-change">
<table style="width:99%;">
<colgroup>
<col style="width: 90%" />
<col style="width: 9%" />
</colgroup>
<tbody>
<tr class="odd">
<td style="text-align: center;"><span class="math display">
\begin{aligned}
\delta(s)  = \delta(0) = \delta_0
\end{aligned}
</span></td>
<td style="text-align: right;"><span class="math display">(9.4)</span></td>
</tr>
</tbody>
</table>
</div>
<p>stays constant, resulting in only one nonzero entry in the bottom row of the transfer matrices.</p>
<section id="drift-space" class="level2" data-number="9.1">
<h2 data-number="9.1"><span class="header-section-number">9.1</span> Drift Space</h2>
<p>In a drift space of the length <span class="math inline">L</span>, where <span class="math inline">\kappa_\mathrm{x0} = k = 0</span>, <a href="#eq:eom-linearized">Equation 2.20</a> simplifies to:</p>
<div id="eq:eom-linearized-drift">
<table style="width:99%;">
<colgroup>
<col style="width: 90%" />
<col style="width: 9%" />
</colgroup>
<tbody>
<tr class="odd">
<td style="text-align: center;"><span class="math display">
\begin{aligned}
x&#39;&#39; &amp;= 0 \\
y&#39;&#39; &amp;= 0
\end{aligned}
</span></td>
<td style="text-align: right;"><span class="math display">(9.5)</span></td>
</tr>
</tbody>
</table>
</div>
<p>The longitudinal offset <span class="math inline">l(s)</span> simplifies to:</p>
<div id="eq:logitudinal-offset-drift">
<table style="width:99%;">
<colgroup>
<col style="width: 90%" />
<col style="width: 9%" />
</colgroup>
<tbody>
<tr class="odd">
<td style="text-align: center;"><span class="math display"> l(s + L) = l(s) + \frac{L}{\gamma^2} \delta_0
</span></td>
<td style="text-align: right;"><span class="math display">(9.6)</span></td>
</tr>
</tbody>
</table>
</div>
<p>Thus, the transfer matrix of a drift space is:</p>
<div id="eq:transfer-matrix-drift">
<table style="width:99%;">
<colgroup>
<col style="width: 90%" />
<col style="width: 9%" />
</colgroup>
<tbody>
<tr class="odd">
<td style="text-align: center;"><span class="math display">
\textbf{R}_\mathrm{drift} =
\begin{pmatrix}
1 &amp; L &amp; 0 &amp; 0 &amp; 0 &amp; 0          \\
0 &amp; 1 &amp; 0 &amp; 0 &amp; 0 &amp; 0          \\
0 &amp; 0 &amp; 1 &amp; L &amp; 0 &amp; 0          \\
0 &amp; 0 &amp; 0 &amp; 1 &amp; 0 &amp; 0          \\
0 &amp; 0 &amp; 0 &amp; 0 &amp; 1 &amp; L/\gamma^2 \\
0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 1
\end{pmatrix}
</span></td>
<td style="text-align: right;"><span class="math display">(9.7)</span></td>
</tr>
</tbody>
</table>
</div>
</section>
<section id="dipole-magnet" class="level2" data-number="9.2">
<h2 data-number="9.2"><span class="header-section-number">9.2</span> Dipole Magnet</h2>
<p>In a dipole magnet of the length <span class="math inline">L</span>, where <span class="math inline">\kappa_\mathrm{x0} \neq 0</span> and <span class="math inline">k = 0</span>, <a href="#eq:eom-linearized">Equation 2.20</a> simplifies to</p>
<div id="eq:eom-linearized-dipole">
<table style="width:99%;">
<colgroup>
<col style="width: 90%" />
<col style="width: 9%" />
</colgroup>
<tbody>
<tr class="odd">
<td style="text-align: center;"><span class="math display">
\begin{aligned}
x&#39;&#39; + \kappa_\mathrm{x0}^2 x &amp;= \kappa_\mathrm{x0} \delta \\
y&#39;&#39; &amp;= 0 ,
\end{aligned}
</span></td>
<td style="text-align: right;"><span class="math display">(9.8)</span></td>
</tr>
</tbody>
</table>
</div>
<p>which is an inhomogeneous second-order differential equation. The transfer matrix for a bending magnet, solving <a href="#eq:eom-linearized-dipole">Equation 9.8</a>, is</p>
<div id="eq:transfer-matrix-dipole">
<table style="width:99%;">
<colgroup>
<col style="width: 90%" />
<col style="width: 9%" />
</colgroup>
<tbody>
<tr class="odd">
<td style="text-align: center;"><span class="math display">
\textbf{R}_\mathrm{b} =
\begin{pmatrix}
c &amp; \frac{s}{\kappa_\mathrm{x0}} &amp; 0 &amp; 0 &amp; 0 &amp; \frac{1-c}{\kappa_\mathrm{x0}} \\
- \kappa_\mathrm{x0} s &amp; c &amp; 0 &amp; 0 &amp; 0 &amp; s \\
0 &amp; 0 &amp; 1 &amp; L &amp; 0 &amp; 0 \\
0 &amp; 0 &amp; 0 &amp; 1 &amp; 0 &amp; 0 \\
-s &amp; \frac{c - 1}{\kappa_\mathrm{x0}} &amp; 0 &amp; 0 &amp; 1 &amp; \frac{L}{\gamma^2} - \frac{\varphi_0 - s}{\kappa_\mathrm{x0}} \\
0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 1
\end{pmatrix} ,
</span></td>
<td style="text-align: right;"><span class="math display">(9.9)</span></td>
</tr>
</tbody>
</table>
</div>
<p>where <span class="math inline">\varphi_0 = L \kappa_\mathrm{x0}</span>, <span class="math inline">s = \sin{\varphi_0}</span>, and <span class="math inline">c = \cos{\varphi_0}</span>. The expression above corresponds to a sector magnet, where the entrance and exit angles are zero. The entrance and exit angles <span class="math inline">\alpha</span>, introduced by a rectangular dipole magnet, lead to an effect known as <em>edge focusing</em> and can be described by the matrix</p>
<div id="eq:transfer-matrix-edge">
<table style="width:99%;">
<colgroup>
<col style="width: 90%" />
<col style="width: 9%" />
</colgroup>
<tbody>
<tr class="odd">
<td style="text-align: center;"><span class="math display">
\textbf{R}_\mathrm{e} =
\begin{pmatrix}
1 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 \\
\kappa_\mathrm{x0} \tan{\alpha} &amp; 1 &amp; 0 &amp; 0 &amp; 0 &amp; 0 \\
0 &amp; 0 &amp; 1 &amp; 0 &amp; 0 &amp; 0 \\
0 &amp; 0 &amp; -\kappa_\mathrm{x0} \tan{\alpha} &amp; 1 &amp; 0 &amp; 0 \\
0 &amp; 0 &amp; 0 &amp; 0 &amp; 1 &amp; 0 \\
0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 1
\end{pmatrix} .
</span></td>
<td style="text-align: right;"><span class="math display">(9.10)</span></td>
</tr>
</tbody>
</table>
</div>
<p>Consequently, the transfer matrix for a rectangular dipole magnet is</p>
<div id="eq:transfer-matrix-dipole-rectangular">
<table style="width:99%;">
<colgroup>
<col style="width: 90%" />
<col style="width: 9%" />
</colgroup>
<tbody>
<tr class="odd">
<td style="text-align: center;"><span class="math display"> \textbf{R}_\mathrm{b,r} = \textbf{R}_\mathrm{e} \textbf{R}_\mathrm{b} \textbf{R}_\mathrm{e} .
</span></td>
<td style="text-align: right;"><span class="math display">(9.11)</span></td>
</tr>
</tbody>
</table>
</div>
</section>
<section id="quadrupole-magnet" class="level2" data-number="9.3">
<h2 data-number="9.3"><span class="header-section-number">9.3</span> Quadrupole Magnet</h2>
<p>In a quadrupole magnet of the length <span class="math inline">L</span>, where <span class="math inline">\kappa_\mathrm{x0} = 0</span> and <span class="math inline">k \neq 0</span>, <a href="#eq:eom-linearized">Equation 2.20</a> simplifies to:</p>
<div id="eq:eom-linearized-quadrupole">
<table style="width:99%;">
<colgroup>
<col style="width: 90%" />
<col style="width: 9%" />
</colgroup>
<tbody>
<tr class="odd">
<td style="text-align: center;"><span class="math display">
\begin{aligned}
x&#39;&#39; + k x &amp;= 0\\
y&#39;&#39; - k y &amp;= 0
\end{aligned}
</span></td>
<td style="text-align: right;"><span class="math display">(9.12)</span></td>
</tr>
</tbody>
</table>
</div>
<p>The longitudinal offset <span class="math inline">l(s)</span> changes identical as in the drift space, leading to the transfer matrices for a horizontal focusing quadrupole</p>
<div id="eq:transfer-matrix-quadrupole-horizontal">
<table style="width:99%;">
<colgroup>
<col style="width: 90%" />
<col style="width: 9%" />
</colgroup>
<tbody>
<tr class="odd">
<td style="text-align: center;"><span class="math display">
\textbf{R}_{\textup{q,h}} =
\begin{pmatrix}
c &amp; s/\sqrt{k} &amp; 0 &amp; 0 &amp; 0 &amp; 0 \\
-s\sqrt{k} &amp; c &amp; 0 &amp; 0 &amp; 0 &amp; 0 \\
0 &amp; 0 &amp; ch &amp; sh/\sqrt{k} &amp; 0 &amp; 0 \\
0 &amp; 0 &amp; sh\sqrt{k} &amp; ch &amp; 0 &amp; 0 \\
0 &amp; 0 &amp; 0 &amp; 0 &amp; 1 &amp; L/\gamma^2 \\
0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 1 \\
\end{pmatrix}
</span></td>
<td style="text-align: right;"><span class="math display">(9.13)</span></td>
</tr>
</tbody>
</table>
</div>
<p>and for the vertical focusing quadrupole</p>
<div id="eq:transfer-matrix-quadrupole-vertical">
<table style="width:99%;">
<colgroup>
<col style="width: 90%" />
<col style="width: 9%" />
</colgroup>
<tbody>
<tr class="odd">
<td style="text-align: center;"><span class="math display">
\textbf{R}_{\textup{q,v}} =
\begin{pmatrix}
ch &amp; sh/\sqrt{k} &amp; 0 &amp; 0 &amp; 0 &amp; 0 \\
sh\sqrt{k} &amp; ch &amp; 0 &amp; 0 &amp; 0 &amp; 0 \\
0 &amp; 0 &amp; c &amp; s/\sqrt{k} &amp; 0 &amp; 0 \\
0 &amp; 0 &amp; -s\sqrt{k} &amp; c &amp; 0 &amp; 0 \\
0 &amp; 0 &amp; 0 &amp; 0 &amp; 1 &amp; L/\gamma^2 \\
0 &amp; 0 &amp; 0 &amp; 0 &amp; 0 &amp; 1
\end{pmatrix} ,
</span></td>
<td style="text-align: right;"><span class="math display">(9.14)</span></td>
</tr>
</tbody>
</table>
</div>
<p>where <span class="math inline">s = \sin{\sqrt{k}L}</span>, <span class="math inline">c = \cos{\sqrt{k}L}</span>, <span class="math inline">sh = \sinh{\sqrt{k}L}</span>, and <span class="math inline">ch = \cosh{\sqrt{k}L}</span>.</p>
</section>
</section>
<section id="grammar-files-of-common-lattice-file-formats" class="level1" data-number="10">
<h1 data-number="10"><span class="header-section-number">10</span> Grammar Files of Common Lattice File Formats</h1>
<p>The grammar files are given in the Lark grammar language, which is based on the Extended Backus–Naur Form.</p>
<section id="sec:elegant-grammar" class="level2" data-number="10.1">
<h2 data-number="10.1"><span class="header-section-number">10.1</span> Elegant Grammar File</h2>
<p>This grammar is not 100% consistent with elegants parser:</p>
<ul>
<li>Elegant’s parser allows tokens to be split by the line continuation character “&amp;”. For example, it parses ANGLE=0.123&amp; without an error. However, this is non-trivial to express with grammar rules and is therefore omitted.</li>
<li>Elegant’s parser allows a trailing ” in attribute definitions. This means L=1.23” is parsed without an error. It seems like a bug and is left out.</li>
<li>Elegant’s parser allows unlimited trailing “,”, which also seems like a bug.</li>
</ul>
<div class="sourceCode" id="cb36"><pre class="sourceCode txt"><code class="sourceCode default"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>%ignore /!.*/            // ignore comments</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>%ignore /[ \t\f]/+       // ignore whitespace</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>%ignore /&amp;[ \t\f]*\r?\n/ // line continuation</span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>%import common (SIGNED_INT, SIGNED_FLOAT, SIGNED_NUMBER, ESCAPED_STRING, CNAME)</span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>int         : SIGNED_INT</span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a>float       : SIGNED_FLOAT</span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a>string      : ESCAPED_STRING</span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a>word        : /\w+/</span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a>name        : /\w+/ | &quot;\&quot;&quot; /[\w:]+/ &quot;\&quot;&quot;</span>
<span id="cb36-11"><a href="#cb36-11" aria-hidden="true" tabindex="-1"></a>start        : _NEWLINE* (statement _NEWLINE+)*</span>
<span id="cb36-12"><a href="#cb36-12" aria-hidden="true" tabindex="-1"></a>_NEWLINE    : /[ \t\f]*\r?\n[ \t\f]*/</span>
<span id="cb36-13"><a href="#cb36-13" aria-hidden="true" tabindex="-1"></a>?statement  : element | lattice | command | &quot;%&quot; assignment</span>
<span id="cb36-14"><a href="#cb36-14" aria-hidden="true" tabindex="-1"></a>element     : name &quot;:&quot; [name] (&quot;,&quot; attribute)* &quot;,&quot;?</span>
<span id="cb36-15"><a href="#cb36-15" aria-hidden="true" tabindex="-1"></a>attribute   : word &quot;=&quot; (int | float | string | word)</span>
<span id="cb36-16"><a href="#cb36-16" aria-hidden="true" tabindex="-1"></a>lattice     : name &quot;:&quot; &quot;LINE&quot;i &quot;=&quot; arrangement</span>
<span id="cb36-17"><a href="#cb36-17" aria-hidden="true" tabindex="-1"></a>arrangement : [int &quot;*&quot;] [/-/] &quot;(&quot; object (&quot;,&quot;+ object)* &quot;)&quot;</span>
<span id="cb36-18"><a href="#cb36-18" aria-hidden="true" tabindex="-1"></a>?object     : ref_name | arrangement</span>
<span id="cb36-19"><a href="#cb36-19" aria-hidden="true" tabindex="-1"></a>ref_name    : [int &quot;*&quot;] [/-/] [&quot;\&quot;&quot;] /[\w:]+/ [&quot;\&quot;&quot;]</span>
<span id="cb36-20"><a href="#cb36-20" aria-hidden="true" tabindex="-1"></a>command     : name [&quot;,&quot; word]</span></code></pre></div>
<p>Elegant used the so called reverse polish notation (RPN) for its arithmetic expressions. As there is no syntactic distinction between an escaped string and a variable, it is possible that a collision can happen. In this case a variable is wrongly identified as string.</p>
<div class="sourceCode" id="cb37"><pre class="sourceCode txt"><code class="sourceCode default"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>assignment  : expr &quot;sto&quot; CNAME</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>?expr       : SIGNED_NUMBER -&gt; number</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>            | CNAME         -&gt; variable</span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>            | function</span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>            | binary</span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>!function   : expr (&quot;exp&quot; | &quot;sin&quot; | &quot;cos&quot; | &quot;tan&quot; | &quot;asin&quot; | &quot;acos&quot; | &quot;atan&quot;)</span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>?binary     : expr expr &quot;+&quot; -&gt; add</span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a>            | expr expr &quot;-&quot; -&gt; sub</span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a>            | expr expr &quot;*&quot; -&gt; mul</span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a>            | expr expr &quot;/&quot; -&gt; div</span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a>?start_rpn  : assignment | expr // used to tested the rpn parser</span></code></pre></div>
</section>
<section id="sec:madx-grammar" class="level2" data-number="10.2">
<h2 data-number="10.2"><span class="header-section-number">10.2</span> MAD-X Grammar File</h2>
<p>The following grammar is only a subset of MAD-X grammar, but it is sufficient to parse basic MAD-X lattice files.</p>
<div class="sourceCode" id="cb38"><pre class="sourceCode txt"><code class="sourceCode default"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>%ignore /\s+/  // whitespace</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>%ignore &quot;&amp;&quot; // backwards compatiable line continuation</span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>%ignore /(!|\/\/).*/  // single line comments</span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>%ignore /\/\*(\*(?!\/)|[^*])*\*\//  // multiline comment</span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>%import common (SIGNED_INT, NUMBER, ESCAPED_STRING)</span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a>int         : SIGNED_INT</span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a>string      : ESCAPED_STRING</span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a>word        : /[\w\.]+/</span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a>start       : (_statement &quot;;&quot;)*</span>
<span id="cb38-11"><a href="#cb38-11" aria-hidden="true" tabindex="-1"></a>_statement  : element | lattice | command | assignment</span>
<span id="cb38-12"><a href="#cb38-12" aria-hidden="true" tabindex="-1"></a>element     : word &quot;:&quot; [word] (&quot;,&quot; attribute)* &quot;,&quot;?</span>
<span id="cb38-13"><a href="#cb38-13" aria-hidden="true" tabindex="-1"></a>attribute   : word (&quot;=&quot; | &quot;:=&quot;) (expr | string)</span>
<span id="cb38-14"><a href="#cb38-14" aria-hidden="true" tabindex="-1"></a>lattice     : word &quot;:&quot; &quot;LINE&quot;i &quot;=&quot; arrangement</span>
<span id="cb38-15"><a href="#cb38-15" aria-hidden="true" tabindex="-1"></a>arrangement : [int &quot;*&quot;] [/-/] &quot;(&quot; object (&quot;,&quot; object)* &quot;)&quot;</span>
<span id="cb38-16"><a href="#cb38-16" aria-hidden="true" tabindex="-1"></a>?object     : ref_name | arrangement</span>
<span id="cb38-17"><a href="#cb38-17" aria-hidden="true" tabindex="-1"></a>ref_name    : [int &quot;*&quot;] [/-/] word</span>
<span id="cb38-18"><a href="#cb38-18" aria-hidden="true" tabindex="-1"></a>command     : word (&quot;,&quot; (word | string | attribute))*</span></code></pre></div>
<p>As there is no syntactic distinction between a non-escaped word and a variable, we must parse words as variables and test afterward if it is a variable or not.</p>
<div class="sourceCode" id="cb39"><pre class="sourceCode txt"><code class="sourceCode default"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>assignment  : word (&quot;=&quot; | &quot;:=&quot;) expr        -&gt; assignment</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>?expr       : item</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>            | &quot;{&quot; expr (&quot;,&quot; expr)* &quot;,&quot;? &quot;}&quot; -&gt; array</span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>?item       : term</span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>            | expr &quot;+&quot; term                 -&gt; add</span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a>            | expr &quot;-&quot; term                 -&gt; sub</span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a>?term       : factor</span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a>            | term &quot;*&quot; factor               -&gt; mul</span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a>            | term &quot;/&quot; factor               -&gt; div</span>
<span id="cb39-10"><a href="#cb39-10" aria-hidden="true" tabindex="-1"></a>?factor     : power</span>
<span id="cb39-11"><a href="#cb39-11" aria-hidden="true" tabindex="-1"></a>            | &quot;+&quot; factor                    -&gt; identity</span>
<span id="cb39-12"><a href="#cb39-12" aria-hidden="true" tabindex="-1"></a>            | &quot;-&quot; factor                    -&gt; neg</span>
<span id="cb39-13"><a href="#cb39-13" aria-hidden="true" tabindex="-1"></a>?power      : atom</span>
<span id="cb39-14"><a href="#cb39-14" aria-hidden="true" tabindex="-1"></a>            | power (&quot;^&quot; | &quot;**&quot;) power      -&gt; pow</span>
<span id="cb39-15"><a href="#cb39-15" aria-hidden="true" tabindex="-1"></a>?atom       : NUMBER                        -&gt; number</span>
<span id="cb39-16"><a href="#cb39-16" aria-hidden="true" tabindex="-1"></a>            | word                          -&gt; variable // see 1.</span>
<span id="cb39-17"><a href="#cb39-17" aria-hidden="true" tabindex="-1"></a>            | word &quot;(&quot; expr &quot;)&quot;             -&gt; function</span>
<span id="cb39-18"><a href="#cb39-18" aria-hidden="true" tabindex="-1"></a>            | &quot;(&quot; expr &quot;)&quot;</span>
<span id="cb39-19"><a href="#cb39-19" aria-hidden="true" tabindex="-1"></a>?start_artih : assignment | expr  // used to tested the arithmetic parser</span></code></pre></div>
</section>
</section>
<section id="sec:appendix-documentation" class="level1" data-number="11">
<h1 data-number="11"><span class="header-section-number">11</span> Documentation</h1>
<p>The documentation is available as a Web version</p>
<blockquote>
<p><a href="https://apace.readthedocs.io/">https://apace.readthedocs.io</a></p>
</blockquote>
<p>or as PDF</p>
<blockquote>
<p><a href="https://apace.readthedocs.io/_/downloads/en/latest/pdf/">https://apace.readthedocs.io/_/downloads/en/latest/pdf/</a>.</p>
</blockquote>
</section>
<section id="bibliography" class="level1 unnumbered">
<h1 class="unnumbered">Bibliography</h1>
<div id="refs" class="references csl-bib-body" role="doc-bibliography">
<div id="ref-ruprecht-phd" class="csl-entry" role="doc-biblioentry">
<div class="csl-left-margin">[1] </div><div class="csl-right-inline">M. Ruprecht, <span>“Calculation of coupled bunch effects in the synchrotron light source BESSY VSR”</span>, PhD thesis, Humboldt-Universität zu Berlin, 2016. doi: <a href="https://doi.org/10.18452/17446">10.18452/17446</a>.</div>
</div>
<div id="ref-linac" class="csl-entry" role="doc-biblioentry">
<div class="csl-left-margin">[2] </div><div class="csl-right-inline">T. Atkinson <em>et al.</em>, <span>“Commissioning of the 50 MeV preinjector linac for the BESSY II facility”</span>, in <em>Proc. 2nd int. Particle accelerator conf. (IPAC’11)</em>, San Sebastian, Spain, 2011, pp. 3140–3142.</div>
</div>
<div id="ref-abobakr2003" class="csl-entry" role="doc-biblioentry">
<div class="csl-left-margin">[3] </div><div class="csl-right-inline">M. Abo-Bakr <em>et al.</em>, <span>“Brilliant, coherent far-infrared (THz) synchrotron radiation”</span>, <em>Phys. Rev. Lett.</em>, vol. 90, p. 094801, Mar. 2003, doi: <a href="https://doi.org/10.1103/PhysRevLett.90.094801">10.1103/PhysRevLett.90.094801</a>.</div>
</div>
<div id="ref-vsrstudy" class="csl-entry" role="doc-biblioentry">
<div class="csl-left-margin">[4] </div><div class="csl-right-inline">A. Jankowiak <em>et al.</em>, <em>Technical design study BESSY VSR</em>. Helmholtz-Zentrum Berlin für Materialien und Energie, 2015. doi: <a href="https://doi.org/10.5442/R0001">10.5442/R0001</a>.</div>
</div>
<div id="ref-andreas_ba" class="csl-entry" role="doc-biblioentry">
<div class="csl-left-margin">[5] </div><div class="csl-right-inline">F. Andreas, <span>“Optimization of the BESSY II optics for the VSR project: Increase the installation length for the VSR cryomodule in the T2 section of the BESSY II storage ring”</span>, Bachelor's thesis, Humboldt-Universität zu Berlin, 2017.</div>
</div>
<div id="ref-kuskekramer2016" class="csl-entry" role="doc-biblioentry">
<div class="csl-left-margin">[6] </div><div class="csl-right-inline">P. Kuske and F. Kramer, <span>“Transverse emittance exchange for improved injection efficiency”</span>, in <em>Proc. 7th int. Particle accelerator conf. (IPAC’16)</em>, Busan, Korea, May 2016, pp. 2028–2031. doi: <a href="https://doi.org/doi:10.18429/JACoW-IPAC2016-WEOAA01">doi:10.18429/JACoW-IPAC2016-WEOAA01</a>.</div>
</div>
<div id="ref-murphy_1996" class="csl-entry" role="doc-biblioentry">
<div class="csl-left-margin">[7] </div><div class="csl-right-inline">J. B. Murphy, <em>Synchrotron light source data book: Version 4, revision 05/96</em>. Brookhaven National Lab., 1996. doi: <a href="https://doi.org/10.2172/383670">10.2172/383670</a>.</div>
</div>
<div id="ref-madx" class="csl-entry" role="doc-biblioentry">
<div class="csl-left-margin">[8] </div><div class="csl-right-inline">H. Grote, F. Schmidt, L. Deniau, <em>et al.</em>, <em>Methodical accelerator design</em>. CERN, 2021.</div>
</div>
<div id="ref-elegant" class="csl-entry" role="doc-biblioentry">
<div class="csl-left-margin">[9] </div><div class="csl-right-inline">M. Borland, <em>Elegant: A flexible SDDS-compliant code for accelerator simulation</em>. Argonne National Laboratory, 2021.</div>
</div>
<div id="ref-accelerator-physics-codes" class="csl-entry" role="doc-biblioentry">
<div class="csl-left-margin">[10] </div><div class="csl-right-inline">Wikipedia, <span>“Accelerator physics codes”</span>. <a href="https://en.wikipedia.org/wiki/Accelerator_physics_codes">https://en.wikipedia.org/wiki/Accelerator_physics_codes</a> (accessed Sep. 26, 2021).</div>
</div>
<div id="ref-sdds-toolkit" class="csl-entry" role="doc-biblioentry">
<div class="csl-left-margin">[11] </div><div class="csl-right-inline">M. Borland, <em>SDDS and SDDS-compliant programs: A modular system for accelerator design, simulation, control, and analysis</em>. Argonne National Laboratory. Available: <a href="https://ops.aps.anl.gov/SDDSInfo.shtml">https://ops.aps.anl.gov/SDDSInfo.shtml</a></div>
</div>
<div id="ref-pymad" class="csl-entry" role="doc-biblioentry">
<div class="csl-left-margin">[12] </div><div class="csl-right-inline">K. Fuchsberger and Y. I. Levinsen, <span>“PYMAD – integration of MADX in <span>Python</span>”</span>, in <em>Proc. 2nd int. Particle accelerator conf. (IPAC’11)</em>, San Sebastian, Spain, 2011, pp. 2289–2291.</div>
</div>
<div id="ref-cpymad" class="csl-entry" role="doc-biblioentry">
<div class="csl-left-margin">[13] </div><div class="csl-right-inline">T. Gläßle, R. D. Maria, Y. Levinsen, and K. Fuchsberger, <em>Cpymad: Cython binding to <span>MAD-X</span></em>. Heidelberg Ion-Beam Therapy Center (HIT): Zenodo, 2021. doi: <a href="https://doi.org/10.5281/zenodo.5364513">10.5281/zenodo.5364513</a>.</div>
</div>
<div id="ref-cpython" class="csl-entry" role="doc-biblioentry">
<div class="csl-left-margin">[14] </div><div class="csl-right-inline">G. van Rossum <em>et al.</em>, <em>CPython</em>. GitHub. Available: <a href="https://github.com/python/cpython">https://github.com/python/cpython</a></div>
</div>
<div id="ref-wiedemann" class="csl-entry" role="doc-biblioentry">
<div class="csl-left-margin">[15] </div><div class="csl-right-inline">H. Wiedemann, <em><span>Particle Accelerator Physics</span></em>. Berlin, Germany: Springer, 2015. doi: <a href="https://doi.org/10.1007/978-3-319-18317-6">10.1007/978-3-319-18317-6</a>.</div>
</div>
<div id="ref-wolski" class="csl-entry" role="doc-biblioentry">
<div class="csl-left-margin">[16] </div><div class="csl-right-inline">A. Wolski, <em>Introduction to beam dynamics in high-energy electron storage rings</em>. Morgan &amp; Claypool Publishers, 2018. doi: <a href="https://doi.org/10.1088/978-1-6817-4989-1">10.1088/978-1-6817-4989-1</a>.</div>
</div>
<div id="ref-wille" class="csl-entry" role="doc-biblioentry">
<div class="csl-left-margin">[17] </div><div class="csl-right-inline">K. Wille, <em>The physics of particle accelerators: An introduction</em>. Clarendon Press, 2001.</div>
</div>
<div id="ref-hinterberger" class="csl-entry" role="doc-biblioentry">
<div class="csl-left-margin">[18] </div><div class="csl-right-inline">F. Hinterberger, <em>Physik der Teilchenbeschleuniger und Ionenoptik</em>, 2. Aufl. Springer, 2008. doi: <a href="https://doi.org/10.1007/978-3-540-75282-0">10.1007/978-3-540-75282-0</a>.</div>
</div>
<div id="ref-courantsnyder" class="csl-entry" role="doc-biblioentry">
<div class="csl-left-margin">[19] </div><div class="csl-right-inline">E. D. Courant and H. S. Snyder, <span>“Theory of the alternating-gradient synchrotron”</span>, <em>Annals of Physics</em>, pp. 1–49, 1954, doi: <a href="https://doi.org/10.1016/0003-4916(58)90012-5">10.1016/0003-4916(58)90012-5</a>.</div>
</div>
<div id="ref-magnus_winkler" class="csl-entry" role="doc-biblioentry">
<div class="csl-left-margin">[20] </div><div class="csl-right-inline">W. Magnus and S. Winkler, <em>Hill’s equation</em>. 1966.</div>
</div>
<div id="ref-Nolting2018" class="csl-entry" role="doc-biblioentry">
<div class="csl-left-margin">[21] </div><div class="csl-right-inline">W. Nolting, <em>Theoretical physics 8 - statistical physics</em>. Berlin, Heidelberg: Springer, 2018.</div>
</div>
<div id="ref-sands1970" class="csl-entry" role="doc-biblioentry">
<div class="csl-left-margin">[22] </div><div class="csl-right-inline">M. Sands, <span>“The physics of electron storage rings: An introduction”</span>, 1970, doi: <a href="https://doi.org/10.2172/4064201">10.2172/4064201</a>.</div>
</div>
<div id="ref-helm1973" class="csl-entry" role="doc-biblioentry">
<div class="csl-left-margin">[23] </div><div class="csl-right-inline">R. H. Helm, M. J. Lee, P. L. Morton, and M. Sands, <span>“Evaluation of synchrotron radiation integrals”</span>, in <em>IEEE Transactions on Nuclear Science</em>, 1973, vol. 20, pp. 900–901. doi: <a href="https://doi.org/10.1109/TNS.1973.4327284">10.1109/TNS.1973.4327284</a>.</div>
</div>
<div id="ref-Chasman1975" class="csl-entry" role="doc-biblioentry">
<div class="csl-left-margin">[24] </div><div class="csl-right-inline">R. Chasman, G. K. Green, and E. M. Rowe, <span>“Preliminary design of a dedicated synchrotron radiation facility”</span>, in <em><span>IEEE</span> Transactions on Nuclear Science</em>, 1975, vol. 22, pp. 1765–1767. doi: <a href="https://doi.org/10.1109/tns.1975.4327987">10.1109/tns.1975.4327987</a>.</div>
</div>
<div id="ref-farvacque" class="csl-entry" role="doc-biblioentry">
<div class="csl-left-margin">[25] </div><div class="csl-right-inline">L. Farvacque, J. L. Laclare, P. Nghiem, J. Peyet, H. Tanaka, and A. Tkatchenko, <span>“Possible retuning of the ESRF storage ring lattice for reducing the beam emittance”</span>, in <em>Proc. 4th european particle accelerator conf. (EPAC’94)</em>, London, UK, 1994, pp. 612–615.</div>
</div>
<div id="ref-faster-cpython" class="csl-entry" role="doc-biblioentry">
<div class="csl-left-margin">[26] </div><div class="csl-right-inline">G. van Rossum <em>et al.</em>, <em>Faster CPython</em>. GitHub. Available: <a href="https://github.com/faster-cpython">https://github.com/faster-cpython</a></div>
</div>
<div id="ref-mypyc" class="csl-entry" role="doc-biblioentry">
<div class="csl-left-margin">[27] </div><div class="csl-right-inline">J. Lehtosalo, M. J. Sullivan, <em>et al.</em>, <em>Mypyc: Compile type annotated <span>Python</span> to fast <span>C</span> extensions</em>. GitHub. Available: <a href="https://github.com/mypyc/mypyc">https://github.com/mypyc/mypyc</a></div>
</div>
<div id="ref-cinder" class="csl-entry" role="doc-biblioentry">
<div class="csl-left-margin">[28] </div><div class="csl-right-inline">Facebook, <em>Cinder: Instagram’s performance oriented fork of CPython</em>. GitHub. Available: <a href="https://github.com/facebookincubator/cinder">https://github.com/facebookincubator/cinder</a></div>
</div>
<div id="ref-pypy" class="csl-entry" role="doc-biblioentry">
<div class="csl-left-margin">[29] </div><div class="csl-right-inline">A. Rigo <em>et al.</em>, <em>PyPy: A fast, compliant alternative implementation of <span>Python</span></em>. Available: <a href="https://www.pypy.org/">https://www.pypy.org/</a></div>
</div>
<div id="ref-nuitka" class="csl-entry" role="doc-biblioentry">
<div class="csl-left-margin">[30] </div><div class="csl-right-inline">K. Hayen <em>et al.</em>, <em>Nuitka: A <span>Python</span> compiler written in <span>Python</span></em>. GitHub. Available: <a href="https://github.com/Nuitka/Nuitka">https://github.com/Nuitka/Nuitka</a></div>
</div>
<div id="ref-numpy" class="csl-entry" role="doc-biblioentry">
<div class="csl-left-margin">[31] </div><div class="csl-right-inline">C. R. Harris <em>et al.</em>, <span>“Array programming with <span>NumPy</span>”</span>, <em>Nature</em>, vol. 585, no. 7825, pp. 357–362, Sep. 2020, doi: <a href="https://doi.org/10.1038/s41586-020-2649-2">10.1038/s41586-020-2649-2</a>.</div>
</div>
<div id="ref-numba" class="csl-entry" role="doc-biblioentry">
<div class="csl-left-margin">[32] </div><div class="csl-right-inline">S. K. Lam, A. Pitrou, and S. Seibert, <span>“Numba: A LLVM-based <span>Python</span> JIT compiler”</span>, in <em>Proceedings of the second workshop on the LLVM compiler infrastructure in HPC</em>, 2015, pp. 1–6.</div>
</div>
<div id="ref-pythran" class="csl-entry" role="doc-biblioentry">
<div class="csl-left-margin">[33] </div><div class="csl-right-inline">S. Guelton, P. Brunet, M. Amini, A. Merlini, X. Corbillon, and A. Raynaud, <span>“Pythran: Enabling static optimization of scientific <span>Python</span> programs”</span>, <em>Computational Science &amp; Discovery</em>, vol. 8, no. 1, p. 014001, 2015.</div>
</div>
<div id="ref-cffi" class="csl-entry" role="doc-biblioentry">
<div class="csl-left-margin">[34] </div><div class="csl-right-inline">A. Rigo <em>et al.</em>, <em>CFFI: C foreign function interface for <span>Python</span></em>. Available: <a href="https://cffi.readthedocs.io/en/latest">https://cffi.readthedocs.io/en/latest</a></div>
</div>
<div id="ref-openmp" class="csl-entry" role="doc-biblioentry">
<div class="csl-left-margin">[35] </div><div class="csl-right-inline">R. Chandra, L. Dagum, D. Kohr, R. Menon, D. Maydan, and J. McDonald, <em>Parallel programming in OpenMP</em>. Morgan kaufmann, 2001.</div>
</div>
<div id="ref-matplotlib" class="csl-entry" role="doc-biblioentry">
<div class="csl-left-margin">[36] </div><div class="csl-right-inline">J. D. Hunter, <span>“Matplotlib: A 2D graphics environment”</span>, <em>Computing in Science &amp; Engineering</em>, vol. 9, no. 3, pp. 90–95, 2007, doi: <a href="https://doi.org/10.1109/MCSE.2007.55">10.1109/MCSE.2007.55</a>.</div>
</div>
<div id="ref-lattice-file-issues" class="csl-entry" role="doc-biblioentry">
<div class="csl-left-margin">[37] </div><div class="csl-right-inline">Wikipedia, <span>“Lattice file format and data interchange issues”</span>. <a href="https://en.wikipedia.org/wiki/Accelerator_physics_codes#Lattice_file_format_and_data_interchange_issues">https://en.wikipedia.org/wiki/Accelerator_physics_codes#Lattice_file_format_and_data_interchange_issues</a> (accessed Sep. 26, 2021).</div>
</div>
<div id="ref-aml" class="csl-entry" role="doc-biblioentry">
<div class="csl-left-margin">[38] </div><div class="csl-right-inline">D. Sagan <em>et al.</em>, <span>“The accelerator markup language and the universal accelerator parser”</span>, Edinburgh, UK, 2006.</div>
</div>
<div id="ref-uap" class="csl-entry" role="doc-biblioentry">
<div class="csl-left-margin">[39] </div><div class="csl-right-inline">D. Sagan, D. A. Bates, and A. Wolski, <span>“The universal accelerator parser”</span>, in <em>Proc. 9th int. Computational accelerator physics conf. (ICAP’06)</em>, Chamonix, Switzerland, 2006, pp. 303–307.</div>
</div>
<div id="ref-json" class="csl-entry" role="doc-biblioentry">
<div class="csl-left-margin">[40] </div><div class="csl-right-inline">D. Crockford, <span>“JSON (JavaScript object notation)”</span>, Accessed: Sep. 26, 2021. [Online]. Available: <a href="https://www.json.org">https://www.json.org</a></div>
</div>
<div id="ref-json-schema" class="csl-entry" role="doc-biblioentry">
<div class="csl-left-margin">[41] </div><div class="csl-right-inline"><span>“JSON schema”</span>, Accessed: Sep. 26, 2021. [Online]. Available: <a href="https://json-schema.org/">https://json-schema.org/</a></div>
</div>
<div id="ref-lattice-json" class="csl-entry" role="doc-biblioentry">
<div class="csl-left-margin">[42] </div><div class="csl-right-inline">F. Andreas, <em>LatticeJSON: A JSON based lattice file format</em>. Accessed: Sep. 26, 2021. [Online]. Available: <a href="https://github.com/nobeam/latticejson">https://github.com/nobeam/latticejson</a></div>
</div>
<div id="ref-latticedesignbessy2" class="csl-entry" role="doc-biblioentry">
<div class="csl-left-margin">[43] </div><div class="csl-right-inline">E. Jaeschke <em>et al.</em>, <span>“Lattice design for the 1.7-GeV light source BESSY II”</span>, in <em>Proc. 15th particle accelerator conf. (PAC’93)</em>, Washington D.C., USA, 1993, pp. 1474–1477.</div>
</div>
<div id="ref-femto1" class="csl-entry" role="doc-biblioentry">
<div class="csl-left-margin">[44] </div><div class="csl-right-inline">H. Bäcker <em>et al.</em>, <span>“Status of the BESSY II femtosecond x-ray source”</span>, Lucerne, Switzerland, 2004. Available: <a href="http://accelconf.web.cern.ch/e04/papers/THPKF014.pdf">http://accelconf.web.cern.ch/e04/papers/THPKF014.pdf</a></div>
</div>
<div id="ref-femto2" class="csl-entry" role="doc-biblioentry">
<div class="csl-left-margin">[45] </div><div class="csl-right-inline">K. Holldack, T. Kachel, S. Khan, R. Mitzner, and T. Quast, <span>“Characterization of laser-electron interaction at the BESSY II femtoslicing source”</span>, in <em>Physical review special topics - Accelerators and beams</em>, 2005, vol. 8, p. 040704. doi: <a href="https://doi.org/10.1103/PhysRevSTAB.8.040704">10.1103/PhysRevSTAB.8.040704</a>.</div>
</div>
<div id="ref-emil1" class="csl-entry" role="doc-biblioentry">
<div class="csl-left-margin">[46] </div><div class="csl-right-inline">J. Bahrdt <em>et al.</em>, <span>“Modifications to the machine optics of BESSY II necessitated by the EMIL project”</span>, in <em>Proc. 3rd int. Particle accelerator conf. (IPAC’12)</em>, New Orleans, LA, USA, May 2012, pp. 1614–1616.</div>
</div>
<div id="ref-kuskeli" class="csl-entry" role="doc-biblioentry">
<div class="csl-left-margin">[47] </div><div class="csl-right-inline">P. Kuske and J. Li, <span>“Performance improvements of the BESSY II storage ring by optimizing the phase acceptance”</span>, May 2017. doi: <a href="https://doi.org/10.18429/JACoW-IPAC2017-WEPAB006">10.18429/JACoW-IPAC2017-WEPAB006</a>.</div>
</div>
<div id="ref-locosafranek" class="csl-entry" role="doc-biblioentry">
<div class="csl-left-margin">[48] </div><div class="csl-right-inline">J. Safranek, <span>“Linear optics from closed orbits (LOCO): An introduction”</span>, in <em>ICFA Beam Dyn. Newslett.</em>, 2007, vol. 44, pp. 43–49.</div>
</div>
<div id="ref-mmlbasedloco" class="csl-entry" role="doc-biblioentry">
<div class="csl-left-margin">[49] </div><div class="csl-right-inline">J. Safranek, G. Portmann, and A. Terebilo, <span>“MATLAB-BASED LOCO”</span>, in <em>Proc. 8th european particle accelerator conf. (EPAC’02)</em>, Paris, France, 2002, pp. 1184–1186.</div>
</div>
<div id="ref-mmlpaper" class="csl-entry" role="doc-biblioentry">
<div class="csl-left-margin">[50] </div><div class="csl-right-inline">G. J. Portmann, W. J. Corbett, and A. Terebilo, <span>“An accelerator control middle layer using matlab”</span>, in <em>Proc. 21st particle accelerator conf. (PAC’05)</em>, Knoxville, TN, USA, May 2005, pp. 4009–4011.</div>
</div>
<div id="ref-vuejs" class="csl-entry" role="doc-biblioentry">
<div class="csl-left-margin">[51] </div><div class="csl-right-inline">E. You <em>et al.</em>, <em>Vue.js: The progressive JavaScript framework</em>. 2021. Available: <a href="https://vuejs.org/">https://vuejs.org/</a></div>
</div>
<div id="ref-vitejs" class="csl-entry" role="doc-biblioentry">
<div class="csl-left-margin">[52] </div><div class="csl-right-inline">E. You <em>et al.</em>, <em>Vite: Next generation frontend tooling</em>. 2021. Available: <a href="https://vitejs.dev/">https://vitejs.dev/</a></div>
</div>
</div>
</section></main>

        <div id="declaration-of-authorship">
            <div>
                <h1>Declaration of Authorship</h1>
                <p>
                    I, Felix Andreas, declare that this thesis and the work presented in it are my own.
                    I confirm that where I have quoted from the work of others, the source is always given.
                </p>
            </div>
            <div class="signature">
                <div><span>Signature</span></div>
                <div><span>Place, Date</span><span>Berlin, December 20, 2021</span></div>
            </div>
        </div>
    </div>

        <!-- set a class to all tables containing math -->
        <script>
            document.querySelectorAll(".math.display").forEach(element => {
                element.closest("table")?.classList.add("math-table")
            })
        </script>
        <!-- change appendix prefixes from numeric to alphabetic -->
        <!-- has to be run after math-table-class.js to correctly change equation numbers -->
        <script>
            const lastChapter = document.querySelector("#conclusion")
            const lastChapterNumber = Number(lastChapter.getAttribute("data-number"))

            function numericToAlphabetic(prefix) {
                const [number, ...others] = prefix.split(".")
                if (number < lastChapterNumber) {
                    return false
                }
                const letter = (Number(number) + 9 - lastChapterNumber).toString(36).toUpperCase()
                return [letter, ...others].join(".")
            }

            // change prefixes of appendix headings
            let chapter = lastChapter
            while (chapter) {
                chapter = chapter.nextElementSibling;
                if (chapter.id == "bibliography") {
                    break
                }

                [chapter, ...chapter.querySelectorAll("section")].forEach(section => {
                    const heading = section.firstChild
                    const sectionNumber = section.firstElementChild.firstElementChild
                    const prefix = numericToAlphabetic(sectionNumber.innerHTML)
                    sectionNumber.innerHTML = prefix
                })
            }

            // change prefixes of appendix toc entries
            let entry = document.querySelector('#toc a[href="#conclusion"]').parentElement
            while (entry) {
                entry = entry.nextElementSibling;
                if (entry.firstChild.getAttribute("href") === "#bibliography") {
                    break
                }

                entry.querySelectorAll('a>span').forEach(span => {
                    span.innerHTML = numericToAlphabetic(span.innerText)
                })
            }


            // change prefix in equations
            document.querySelectorAll(".math-table td:nth-child(2) span.math.display").forEach(element => {
                const newNumber = numericToAlphabetic(element.innerHTML.slice(1, -1))
                if (newNumber) {
                    element.innerHTML = `(\\mathrm{${newNumber}})`
                }
            })

            // change prefix in figure captions
            document.querySelectorAll('figure figcaption, table caption').forEach(caption => {
                const [label, text] = caption.innerHTML.split(":")
                const [prefix, number] = label.split(" ")
                if (prefix !== "Figure" || prefix !== "Table") {
                    return
                }

                const newNumber = numericToAlphabetic(number)
                if (newNumber) {
                    caption.innerHTML = `${prefix} ${newNumber}: ${text}`
                }
            })

            // change prefix in references
            document.querySelectorAll('main a').forEach(link => {
                const href = link.getAttribute('href')
                const isSection = href.startsWith("#sec:")
                if (isSection || href.startsWith("#eq:") || href.startsWith("#fig:") || href.startsWith("#tbl:")) {
                    const [prefix, number] = link.innerText.split('\xa0')
                    const newNumber = numericToAlphabetic(number)
                    if (newNumber) {
                        link.innerHTML = `${isSection ? 'Appendix' : prefix}\xa0${newNumber}`
                    }
                }
            })
        </script>
        <!-- prefix chapter headings with 'Chapter' and appendix headings with 'Appendix' -->
        <script>
            const isLetter = char => isNaN(Number(char))
            document.querySelectorAll('section>h1>span').forEach(span => {
                const prefix = span.innerHTML;
                span.innerHTML = isLetter(prefix[0]) ? `Appendix ${prefix}` : `Chapter ${prefix}`
                span.style = "display: block; font-size: 1.5rem; margin-bottom: 0.5rem;"
            })
        </script>
        <!-- add (cit. in sec. 2.x) links to bibliography -->
        <script>
            const targetIdsToLinks = {}

            for (const [index, link] of document.querySelectorAll("span.citation>a").entries()) {
                const targetId = link.getAttribute("href")
                link.id = `citation-${index}`
                if (targetIdsToLinks[targetId] === undefined) {
                    targetIdsToLinks[targetId] = [link]
                } else {
                    targetIdsToLinks[targetId].push(link)
                }
            }

            for (const [targetId, links] of Object.entries(targetIdsToLinks)) {
                const target = document.querySelector(targetId).children[1]
                const newDiv = document.createElement("span");
                newDiv.classList.add("cited-on")
                newDiv.appendChild(document.createTextNode(" (cit. in sec. "))

                links.map((link, index) => {
                    if (index !== 0) {
                        newDiv.appendChild(document.createTextNode(", "))
                    }

                    const linkNode = document.createElement('a');
                    const text = link.closest("section").getAttribute("data-number")
                    linkNode.appendChild(document.createTextNode(text));
                    linkNode.href = `#${link.id}`;
                    newDiv.appendChild(linkNode)
                })

                newDiv.appendChild(document.createTextNode(")"))
                target.appendChild(newDiv)
            }
        </script>
        <!-- don't wait for DOMContentLoaded event, because katex has to be executed before pagedjs chunker -->
    <script>
        document.querySelectorAll(".math").forEach(element => {
            const texText = element.firstChild;
            if (element.tagName == 'SPAN') {
                katex.render(texText.data, element, {
                    displayMode: element.classList.contains('display'),
                    output: 'html',
                    throwOnError: false,
                });
            }
        })
    </script>
</body>

</html>